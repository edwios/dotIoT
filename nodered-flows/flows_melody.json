[{"id":"28f95376.747dcc","type":"tab","label":"UI","disabled":false,"info":""},{"id":"14e9f5d5.1d23fa","type":"tab","label":"Queries","disabled":false,"info":""},{"id":"4d31febf.b2ce","type":"tab","label":"Home IoT"},{"id":"22752fb7.ea4aa","type":"tab","label":"BLE Devices","disabled":false,"info":""},{"id":"32ff8a67.c39a86","type":"tab","label":"House Alarms","disabled":false,"info":""},{"id":"30d36509.cf2c9a","type":"tab","label":"HomeBridge Web"},{"id":"4836b9b7.e4bd18","type":"tab","label":"K2 Control"},{"id":"81fd7809.1072f","type":"tab","label":"Telldus"},{"id":"cb0fb263.d8ff4","type":"tab","label":"Global MQTT services"},{"id":"91296eb.86fc89","type":"tab","label":"GPIO","disabled":false,"info":"Local hardware control"},{"id":"9473c5a0.f3e0c8","type":"tab","label":"Test"},{"id":"6623960.c5be96c","type":"tab","label":"Retired","disabled":false,"info":""},{"id":"9eac092b.6153f8","type":"mqtt-broker","z":"","broker":"10.0.1.250","port":"1883","clientid":"NodeRed","usetls":false,"verifyservercert":true,"compatmode":false,"keepalive":"15","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":null,"birthPayload":"","willTopic":"","willQos":"0","willRetain":null,"willPayload":""},{"id":"d3cae7a7.2c3518","type":"mongodb","z":"","hostname":"127.0.0.1","port":"27017","db":"homeiot","name":"HomeIoT"},{"id":"8daacbf2.827ed8","type":"mqtt-broker","z":"","broker":"10.0.1.252","port":"1883","clientid":"","usetls":false,"compatmode":false,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"1ee64e7d.ebc352","type":"telldus-gateway","z":"","ip":"10.0.1.2","name":"Home"},{"id":"6cff269d.a96688","type":"Generic BLE","z":"","localName":"EnvMultiIR907","address":"fd:ca:60:13:52:9e","uuid":"fdca6013529e","muteNotifyEvents":true,"operationTimeout":"10000","characteristics":[{"uuid":"2a00","name":"Device Name","type":"org.bluetooth.characteristic.gap.device_name","notifiable":false,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"2a01","name":"Appearance","type":"org.bluetooth.characteristic.gap.appearance","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2a04","name":"Peripheral Preferred Connection Parameters","type":"org.bluetooth.characteristic.gap.peripheral_preferred_connection_parameters","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2aa6","name":"Central Address Resolution","type":"org.bluetooth.characteristic.central_address_resolution","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2a05","name":"Service Changed","type":"org.bluetooth.characteristic.gatt.service_changed","notifiable":false,"readable":false,"writable":false,"writeWithoutResponse":false},{"uuid":"815d","name":"<Unnamed>","type":"(Custom Type)","notifiable":true,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"815e","name":"<Unnamed>","type":"(Custom Type)","notifiable":true,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"2a77","name":"Irradiance","type":"org.bluetooth.characteristic.irradiance","notifiable":true,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"2a6e","name":"Temperature","type":"org.bluetooth.characteristic.temperature","notifiable":true,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"2a6f","name":"Humidity","type":"org.bluetooth.characteristic.humidity","notifiable":true,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"2a6d","name":"Pressure","type":"org.bluetooth.characteristic.pressure","notifiable":true,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"2a29","name":"Manufacturer Name String","type":"org.bluetooth.characteristic.manufacturer_name_string","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2a24","name":"Model Number String","type":"org.bluetooth.characteristic.model_number_string","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2a23","name":"System ID","type":"org.bluetooth.characteristic.system_id","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false}]},{"id":"daa86108.dbba4","type":"Generic BLE","z":"","localName":"EnvMultiUV098","address":"e7:7c:12:1f:73:24","uuid":"e77c121f7324","muteNotifyEvents":true,"operationTimeout":"10000","characteristics":[{"uuid":"2a00","name":"Device Name","type":"org.bluetooth.characteristic.gap.device_name","notifiable":false,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"2a01","name":"Appearance","type":"org.bluetooth.characteristic.gap.appearance","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2a04","name":"Peripheral Preferred Connection Parameters","type":"org.bluetooth.characteristic.gap.peripheral_preferred_connection_parameters","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2aa6","name":"Central Address Resolution","type":"org.bluetooth.characteristic.central_address_resolution","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2a05","name":"Service Changed","type":"org.bluetooth.characteristic.gatt.service_changed","notifiable":false,"readable":false,"writable":false,"writeWithoutResponse":false},{"uuid":"815d","name":"<Unnamed>","type":"(Custom Type)","notifiable":true,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"815e","name":"<Unnamed>","type":"(Custom Type)","notifiable":true,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"2a77","name":"Irradiance","type":"org.bluetooth.characteristic.irradiance","notifiable":true,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"2a6e","name":"Temperature","type":"org.bluetooth.characteristic.temperature","notifiable":true,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"2a6f","name":"Humidity","type":"org.bluetooth.characteristic.humidity","notifiable":true,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"2a6d","name":"Pressure","type":"org.bluetooth.characteristic.pressure","notifiable":true,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"2a29","name":"Manufacturer Name String","type":"org.bluetooth.characteristic.manufacturer_name_string","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2a24","name":"Model Number String","type":"org.bluetooth.characteristic.model_number_string","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2a23","name":"System ID","type":"org.bluetooth.characteristic.system_id","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false}]},{"id":"334c0910.3976c6","type":"Generic BLE","z":"","localName":"EvTH5908","address":"cf:1c:3b:a4:56:f4","uuid":"cf1c3ba456f4","muteNotifyEvents":false,"operationTimeout":"10000","characteristics":[{"uuid":"2a00","name":"Device Name","type":"org.bluetooth.characteristic.gap.device_name","notifiable":false,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"2a01","name":"Appearance","type":"org.bluetooth.characteristic.gap.appearance","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2a04","name":"Peripheral Preferred Connection Parameters","type":"org.bluetooth.characteristic.gap.peripheral_preferred_connection_parameters","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2aa6","name":"Central Address Resolution","type":"org.bluetooth.characteristic.central_address_resolution","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2a05","name":"Service Changed","type":"org.bluetooth.characteristic.gatt.service_changed","notifiable":false,"readable":false,"writable":false,"writeWithoutResponse":false},{"uuid":"2a6e","name":"Temperature","type":"org.bluetooth.characteristic.temperature","notifiable":true,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"2a6f","name":"Humidity","type":"org.bluetooth.characteristic.humidity","notifiable":true,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"2a6d","name":"Pressure","type":"org.bluetooth.characteristic.pressure","notifiable":true,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"2a29","name":"Manufacturer Name String","type":"org.bluetooth.characteristic.manufacturer_name_string","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2a24","name":"Model Number String","type":"org.bluetooth.characteristic.model_number_string","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2a23","name":"System ID","type":"org.bluetooth.characteristic.system_id","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false}]},{"id":"1c6dfa25.9a9126","type":"Generic BLE","z":"","localName":"EvTH1206","address":"c2:d6:9b:ab:8c:e6","uuid":"c2d69bab8ce6","muteNotifyEvents":true,"operationTimeout":"10000","characteristics":[{"uuid":"2a00","name":"Device Name","type":"org.bluetooth.characteristic.gap.device_name","notifiable":false,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"2a01","name":"Appearance","type":"org.bluetooth.characteristic.gap.appearance","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2a04","name":"Peripheral Preferred Connection Parameters","type":"org.bluetooth.characteristic.gap.peripheral_preferred_connection_parameters","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2aa6","name":"Central Address Resolution","type":"org.bluetooth.characteristic.central_address_resolution","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2a05","name":"Service Changed","type":"org.bluetooth.characteristic.gatt.service_changed","notifiable":false,"readable":false,"writable":false,"writeWithoutResponse":false},{"uuid":"2a6e","name":"Temperature","type":"org.bluetooth.characteristic.temperature","notifiable":true,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"2a6f","name":"Humidity","type":"org.bluetooth.characteristic.humidity","notifiable":true,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"2a6d","name":"Pressure","type":"org.bluetooth.characteristic.pressure","notifiable":true,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"2a29","name":"Manufacturer Name String","type":"org.bluetooth.characteristic.manufacturer_name_string","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2a24","name":"Model Number String","type":"org.bluetooth.characteristic.model_number_string","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2a23","name":"System ID","type":"org.bluetooth.characteristic.system_id","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false}]},{"id":"b4b530ff.cce84","type":"Generic BLE","z":"","localName":"EvTH9640","address":"e3:13:83:3a:33:c8","uuid":"e313833a33c8","muteNotifyEvents":true,"operationTimeout":"10000","characteristics":[{"uuid":"2a00","name":"Device Name","type":"org.bluetooth.characteristic.gap.device_name","notifiable":false,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"2a01","name":"Appearance","type":"org.bluetooth.characteristic.gap.appearance","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2a04","name":"Peripheral Preferred Connection Parameters","type":"org.bluetooth.characteristic.gap.peripheral_preferred_connection_parameters","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2aa6","name":"Central Address Resolution","type":"org.bluetooth.characteristic.central_address_resolution","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2a05","name":"Service Changed","type":"org.bluetooth.characteristic.gatt.service_changed","notifiable":false,"readable":false,"writable":false,"writeWithoutResponse":false},{"uuid":"2a6e","name":"Temperature","type":"org.bluetooth.characteristic.temperature","notifiable":true,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"2a6f","name":"Humidity","type":"org.bluetooth.characteristic.humidity","notifiable":true,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"2a6d","name":"Pressure","type":"org.bluetooth.characteristic.pressure","notifiable":true,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"2a29","name":"Manufacturer Name String","type":"org.bluetooth.characteristic.manufacturer_name_string","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2a24","name":"Model Number String","type":"org.bluetooth.characteristic.model_number_string","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2a23","name":"System ID","type":"org.bluetooth.characteristic.system_id","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false}]},{"id":"84828a17.51b738","type":"Generic BLE","z":"","localName":"BME680","address":"cf:9e:fc:96:a3:5d","uuid":"cf9efc96a35d","muteNotifyEvents":false,"operationTimeout":"10000","characteristics":[{"uuid":"2a00","name":"Device Name","type":"org.bluetooth.characteristic.gap.device_name","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2a01","name":"Appearance","type":"org.bluetooth.characteristic.gap.appearance","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"000102030405060708090a0b0c0d1921","name":"<Unnamed>","type":"(Custom Type)","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"000102030405060708090a0b0c0d1922","name":"<Unnamed>","type":"(Custom Type)","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"000102030405060708090a0b0c0d1923","name":"<Unnamed>","type":"(Custom Type)","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"000102030405060708090a0b0c0d1924","name":"<Unnamed>","type":"(Custom Type)","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"000102030405060708090a0b0c0d1911","name":"<Unnamed>","type":"(Custom Type)","notifiable":true,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"000102030405060708090a0b0c0d1912","name":"<Unnamed>","type":"(Custom Type)","notifiable":false,"readable":true,"writable":true,"writeWithoutResponse":true},{"uuid":"000102030405060708090a0b0c0d1913","name":"<Unnamed>","type":"(Custom Type)","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":true},{"uuid":"000102030405060708090a0b0c0d1914","name":"<Unnamed>","type":"(Custom Type)","notifiable":false,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"000102030405060708090a0b0c0d1925","name":"<Unnamed>","type":"(Custom Type)","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"000102030405060708090a0b0c0d1926","name":"<Unnamed>","type":"(Custom Type)","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"000102030405060708090a0b0c0d1927","name":"<Unnamed>","type":"(Custom Type)","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false}]},{"id":"b225f3c1.61ec1","type":"Generic BLE","z":"","localName":"BME280","address":"d7:6f:be:6a:88:7d","uuid":"d76fbe6a887d","muteNotifyEvents":false,"operationTimeout":"10000","characteristics":[{"uuid":"2a00","name":"Device Name","type":"org.bluetooth.characteristic.gap.device_name","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2a01","name":"Appearance","type":"org.bluetooth.characteristic.gap.appearance","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2a05","name":"Service Changed","type":"org.bluetooth.characteristic.gatt.service_changed","notifiable":false,"readable":false,"writable":false,"writeWithoutResponse":false},{"uuid":"8667556c9a374c9184ed54ee27d90049","name":"<Unnamed>","type":"(Custom Type)","notifiable":true,"readable":false,"writable":true,"writeWithoutResponse":false}]},{"id":"d00e3d6.43749c","type":"Generic BLE","z":"","localName":"BME680","address":"cd:a0:4b:46:e5:8a","uuid":"cda04b46e58a","muteNotifyEvents":false,"operationTimeout":"4000","characteristics":[]},{"id":"73347c44.a85694","type":"Generic BLE","z":"","localName":"L","address":"fc:f4:35:bf:6b:37","uuid":"fcf435bf6b37","muteNotifyEvents":false,"operationTimeout":"5000","characteristics":[{"uuid":"2a00","name":"Device Name","type":"org.bluetooth.characteristic.gap.device_name","notifiable":false,"readable":true,"writable":true,"writeWithoutResponse":false},{"uuid":"2a01","name":"Appearance","type":"org.bluetooth.characteristic.gap.appearance","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2a04","name":"Peripheral Preferred Connection Parameters","type":"org.bluetooth.characteristic.gap.peripheral_preferred_connection_parameters","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"2aa6","name":"Central Address Resolution","type":"org.bluetooth.characteristic.central_address_resolution","notifiable":false,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"000015241212efde1523785feabcd123","name":"<Unnamed>","type":"(Custom Type)","notifiable":true,"readable":true,"writable":false,"writeWithoutResponse":false},{"uuid":"000015251212efde1523785feabcd123","name":"<Unnamed>","type":"(Custom Type)","notifiable":false,"readable":true,"writable":true,"writeWithoutResponse":false}]},{"id":"451828e0.44aad8","type":"ui_tab","z":"","name":"Analytics","icon":"dashboard","disabled":false,"hidden":false},{"id":"7f80b2a1.1b92bc","type":"ui_group","z":"","name":"Base","tab":"451828e0.44aad8","disp":true,"width":"7","collapse":false},{"id":"e81d2c8a.be5f5","type":"ui_base","theme":{"name":"theme-light","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#0094CE","value":"#0094CE","edited":false},"page-titlebar-backgroundColor":{"value":"#0094CE","edited":false},"page-backgroundColor":{"value":"#fafafa","edited":false},"page-sidebar-backgroundColor":{"value":"#ffffff","edited":false},"group-textColor":{"value":"#1bbfff","edited":false},"group-borderColor":{"value":"#ffffff","edited":false},"group-backgroundColor":{"value":"#ffffff","edited":false},"widget-textColor":{"value":"#111111","edited":false},"widget-backgroundColor":{"value":"#0094ce","edited":false},"widget-borderColor":{"value":"#ffffff","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"564b00d.e410c","type":"ui_group","z":"","name":"Environment","tab":"451828e0.44aad8","disp":true,"width":"6","collapse":false},{"id":"9a4340f9.65bcc","type":"mqtt out","z":"4d31febf.b2ce","name":"Set Light Color","topic":"/sensornet/command/color","qos":"","retain":"","broker":"9eac092b.6153f8","x":1560,"y":1460,"wires":[]},{"id":"cbcc447a.3433b8","type":"inject","z":"4d31febf.b2ce","name":"Full Brightness","topic":"/sensornet/command/color","payload":"{\"Command\":\"COLOR\",\"Color\":[255,255,255]}","payloadType":"string","repeat":"","crontab":"","once":false,"x":340,"y":1320,"wires":[["6b9fb3b7.94604c"]]},{"id":"8418dab1.7be728","type":"inject","z":"4d31febf.b2ce","name":"Off","topic":"/sensornet/command/color","payload":"{\"Command\":\"COLOR\",\"Color\":[0,0,0]}","payloadType":"string","repeat":"","crontab":"","once":false,"x":150,"y":1320,"wires":[["6b9fb3b7.94604c"]]},{"id":"8a616939.759e98","type":"inject","z":"4d31febf.b2ce","name":"Blue","topic":"/sensornet/command/color","payload":"{\"Command\":\"COLOR\",\"Color\":[0,0,255]}","payloadType":"string","repeat":"","crontab":"","once":false,"x":1230,"y":1320,"wires":[["6b9fb3b7.94604c"]]},{"id":"2005b3be.dffa4c","type":"inject","z":"4d31febf.b2ce","name":"Warm white","topic":"/sensornet/command/color","payload":"{\"Command\":\"COLOR\",\"Color\":[200,200,80]}","payloadType":"str","repeat":"","crontab":"","once":false,"x":550,"y":1320,"wires":[["6b9fb3b7.94604c"]]},{"id":"4638d449.b9c72c","type":"inject","z":"4d31febf.b2ce","name":"Pink","topic":"/sensornet/command/color","payload":"{\"Command\":\"COLOR\",\"Color\":[255,40,40]}","payloadType":"string","repeat":"","crontab":"","once":false,"x":730,"y":1320,"wires":[["6b9fb3b7.94604c"]]},{"id":"a5601d40.5a9fe","type":"function","z":"4d31febf.b2ce","name":"FalseColor","func":"/* accepts parameters\n * h  Object = {h:x, s:y, v:z}\n * OR \n * h, s, v\n*/\nfunction HSVtoRGB(h, s, v) {\n    var r, g, b, i, f, p, q, t;\n    if (arguments.length === 1) {\n        s = h.s, v = h.v, h = h.h;\n    }\n    i = Math.floor(h * 6);\n    f = h * 6 - i;\n    p = v * (1 - s);\n    q = v * (1 - f * s);\n    t = v * (1 - (1 - f) * s);\n    switch (i % 6) {\n        case 0: r = v, g = t, b = p; break;\n        case 1: r = q, g = v, b = p; break;\n        case 2: r = p, g = v, b = t; break;\n        case 3: r = p, g = q, b = v; break;\n        case 4: r = t, g = p, b = v; break;\n        case 5: r = v, g = p, b = q; break;\n    }\n    return {\n        r: Math.round(r * 255),\n        g: Math.round(g * 255),\n        b: Math.round(b * 255)\n    };\n}\n\nvar outputMsgs = [];\nvar tem = msg.payload;\nvar aTem = (1-tem)-0.1667;\nif (aTem < 0) aTem = 1 + aTem;\nvar rgb = HSVtoRGB(aTem, 1, 1);\noutputMsgs.push({payload:rgb});\noutputMsgs.push({payload:aTem});\nreturn outputMsgs;","outputs":"2","noerr":0,"x":870,"y":1980,"wires":[["80efe594.7f1018","5bd6df21.a4292"],[]]},{"id":"700889f4.8ff778","type":"range","z":"4d31febf.b2ce","minin":"9","maxin":"34","minout":"0","maxout":"0.8333","action":"clamp","round":false,"name":"Scale temperature","x":630,"y":1980,"wires":[["a5601d40.5a9fe"]]},{"id":"80efe594.7f1018","type":"template","z":"4d31febf.b2ce","name":"Rewrite JSON msg","field":"payload","format":"handlebars","template":"{\"Command\":\"COLOR\",\"Color\":[{{payload.r}},{{payload.g}},{{payload.b}}]}\n","x":1110,"y":1980,"wires":[["9a4340f9.65bcc"]]},{"id":"96cd420e.6932c","type":"inject","z":"4d31febf.b2ce","name":"Green","topic":"/sensornet/command/color","payload":"{\"Command\":\"COLOR\",\"Color\":[0,255,0]}","payloadType":"string","repeat":"","crontab":"","once":false,"x":1050,"y":1320,"wires":[["6b9fb3b7.94604c"]]},{"id":"289da2d4.d7625e","type":"inject","z":"4d31febf.b2ce","name":"Orange","topic":"/sensornet/command/color","payload":"{\"Command\":\"COLOR\",\"Color\":[255,80,20]}","payloadType":"string","repeat":"","crontab":"","once":false,"x":890,"y":1320,"wires":[["6b9fb3b7.94604c"]]},{"id":"71841ade.8e7be4","type":"mqtt in","z":"4d31febf.b2ce","name":"Balcony temp","topic":"sensornet/env/home/balcony/temperature","broker":"9eac092b.6153f8","x":150,"y":1940,"wires":[["8235c26f.7dca4","fd36164d.02c9e8","dd96bdcf.22694","d7e40c06.96faf"]]},{"id":"e8fb38f9.1704c8","type":"mqtt in","z":"4d31febf.b2ce","name":"Balcony humi","topic":"sensornet/env/home/balcony/humidity","broker":"9eac092b.6153f8","x":150,"y":2120,"wires":[["b5de4fc7.4a21b","d05786cd.3f2768"]]},{"id":"dd147d49.22eb8","type":"http request","z":"4d31febf.b2ce","name":"Thingspeak update","method":"GET","ret":"txt","url":"https://api.thingspeak.com/update?key={{{APIKey}}}&field1={{{field1}}}&field2={{{field2}}}&field3={{{field3}}}","x":630,"y":1880,"wires":[["2d13cc46.d2ec34"]]},{"id":"423d605d.bdc2a","type":"debug","z":"4d31febf.b2ce","name":"Thingspeak indoor result","active":false,"console":"false","complete":"payload","x":890,"y":780,"wires":[]},{"id":"a7a329b3.585cd8","type":"mqtt out","z":"4d31febf.b2ce","name":"Dump","topic":"sensornet/command/dump","qos":"0","retain":"false","broker":"9eac092b.6153f8","x":430,"y":380,"wires":[]},{"id":"afe55072.501ab","type":"inject","z":"4d31febf.b2ce","name":"Dump","topic":"sensornet/command/dump","payload":"dump","payloadType":"str","repeat":"","crontab":"","once":false,"x":150,"y":380,"wires":[["a7a329b3.585cd8"]]},{"id":"8235c26f.7dca4","type":"function","z":"4d31febf.b2ce","name":"Context var","func":"var d = new Date();\nmsg.dtime = d.getTime();\nif (msg.payload) {\n    context.global.balcony_temp=msg.payload;\n    return msg;\n}\nreturn;","outputs":1,"noerr":0,"x":350,"y":2060,"wires":[["5c0f491a.a3f0b8"]]},{"id":"b5de4fc7.4a21b","type":"function","z":"4d31febf.b2ce","name":"Context var","func":"var d = new Date();\nmsg.dtime = d.getTime();\nif (msg.payload) {\n    context.global.balcony_humi=msg.payload;\n    return msg;\n}\nreturn;\n","outputs":1,"noerr":0,"x":350,"y":2120,"wires":[["5c0f491a.a3f0b8"]]},{"id":"fd36164d.02c9e8","type":"function","z":"4d31febf.b2ce","name":"Thingspeak data","func":"var d = new Date()\nmsg.dtime = d.getTime()\nmsg.field1=context.global.balcony_temp\nmsg.field2=context.global.balcony_humi\nmsg.field3=context.global.balcony_brgt\nmsg.APIKey=\"89DQON6G9XOGVTR3\"\nif (msg.field1 === null || msg.field2 === null || msg.field3 === null) {\n    return; // eliminate null fields\n} else {\n    return msg;\n}","outputs":1,"noerr":0,"x":370,"y":1880,"wires":[["dd147d49.22eb8"]]},{"id":"c33ca296.3cc36","type":"mqtt in","z":"4d31febf.b2ce","name":"Balcony bright","topic":"sensornet/env/home/balcony/brightness","broker":"9eac092b.6153f8","x":150,"y":2240,"wires":[["91711c1a.6e8ee"]]},{"id":"91711c1a.6e8ee","type":"function","z":"4d31febf.b2ce","name":"Context var","func":"var d = new Date();\nmsg.dtime = d.getTime();\nif (msg.payload) {\n    context.global.balcony_brgt=msg.payload;\n    return msg;\n}\nreturn;\n","outputs":1,"noerr":0,"x":350,"y":2240,"wires":[["5c0f491a.a3f0b8"]]},{"id":"9a448261.65bb8","type":"mqtt in","z":"4d31febf.b2ce","name":"Living Room Motion","topic":"sensornet/env/home/living/motion","broker":"9eac092b.6153f8","x":170,"y":900,"wires":[["93b19a3.f6c4e68","a06b86b4.5f9478"]]},{"id":"93b19a3.f6c4e68","type":"function","z":"4d31febf.b2ce","name":"Context var","func":"var d = new Date()\nmsg.dtime = d.getTime()\nif (msg.payload) {\n    context.global.living_motion=msg.payload\n    return msg\n}\nreturn\n","outputs":1,"noerr":0,"x":390,"y":900,"wires":[["306fcbe9.cf9034"]]},{"id":"43cb7d67.bc3484","type":"mqtt in","z":"4d31febf.b2ce","name":"Living Room Sound","topic":"sensornet/env/home/living/sound","broker":"9eac092b.6153f8","x":170,"y":960,"wires":[["a5c46db5.5a3b9"]]},{"id":"a5c46db5.5a3b9","type":"function","z":"4d31febf.b2ce","name":"Context var","func":"var d = new Date()\nmsg.dtime = d.getTime()\nif (msg.payload) {\n    context.global.living_sound=msg.payload\n    return msg\n}\nreturn\n","outputs":1,"noerr":0,"x":390,"y":960,"wires":[["306fcbe9.cf9034"]]},{"id":"e4de15fa.1b21e8","type":"http request","z":"4d31febf.b2ce","name":"Thingspeak update","method":"GET","ret":"txt","url":"https://api.thingspeak.com/update?key={{{APIKey}}}&field1={{{field1}}}&field2={{{field2}}}&field3={{{field3}}}&field4={{{field4}}}&field5={{{field5}}}","x":650,"y":780,"wires":[["423d605d.bdc2a"]]},{"id":"38fee16d.c7011e","type":"function","z":"4d31febf.b2ce","name":"Thingspeak data","func":"var d = new Date()\nmsg.dtime = d.getTime()\nmsg.field1=context.global.living_temp\nmsg.field2=context.global.living_motion\nmsg.field3=context.global.living_sound\nmsg.field4=context.global.living_humi\nmsg.field5=context.global.living_brgt\nmsg.APIKey=\"94R8F61EKX9BXNGQ\"\nif (msg.field1 === null || msg.field2 === null || msg.field3 === null || msg.field4 === null || msg.field5 === null) {\n    return; // eliminate null fields\n} else {\n    return msg;\n}","outputs":1,"noerr":0,"x":410.66666412353516,"y":661.7499709129333,"wires":[["e4de15fa.1b21e8"]]},{"id":"301bd21a.cfe42e","type":"mqtt in","z":"4d31febf.b2ce","name":"LivingRoom temp","topic":"sensornet/env/home/living/temperature","broker":"9eac092b.6153f8","x":160,"y":720,"wires":[["38fee16d.c7011e","5ef67156.a1099","4bde8cc9.6cd004"]]},{"id":"1d484bd3.e2b7b4","type":"mqtt in","z":"4d31febf.b2ce","name":"LivingRoom humi","topic":"sensornet/env/home/living/humidity","broker":"9eac092b.6153f8","x":160,"y":780,"wires":[["284f0069.d7b1","3d5d0f7a.d1524"]]},{"id":"522c4010.add3c","type":"mqtt in","z":"4d31febf.b2ce","name":"LivingRoom bright","topic":"sensornet/env/home/living/brightness","broker":"9eac092b.6153f8","x":170,"y":840,"wires":[["6127b00.f9ed85"]]},{"id":"5ef67156.a1099","type":"function","z":"4d31febf.b2ce","name":"Context var","func":"var d = new Date()\nmsg.dtime = d.getTime()\nif (msg.payload) {\n    context.global.living_temp=msg.payload\n    return msg\n}\nreturn\n","outputs":1,"noerr":0,"x":390,"y":720,"wires":[["306fcbe9.cf9034"]]},{"id":"284f0069.d7b1","type":"function","z":"4d31febf.b2ce","name":"Context var","func":"var d = new Date()\nmsg.dtime = d.getTime()\nif (msg.payload) {\n    context.global.living_humi=msg.payload\n    return msg\n}\nreturn\n","outputs":1,"noerr":0,"x":390,"y":780,"wires":[["306fcbe9.cf9034"]]},{"id":"6127b00.f9ed85","type":"function","z":"4d31febf.b2ce","name":"Context var","func":"var d = new Date()\nmsg.dtime = d.getTime()\nif (msg.payload) {\n    context.global.living_brgt=msg.payload\n    return msg\n}\nreturn\n","outputs":1,"noerr":0,"x":390,"y":840,"wires":[["306fcbe9.cf9034"]]},{"id":"d3e0e540.2c1f18","type":"inject","z":"30d36509.cf2c9a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":164.2857208251953,"y":218.57142639160156,"wires":[[]]},{"id":"cc23bcfd.33dc4","type":"inject","z":"30d36509.cf2c9a","name":"On","topic":"","payload":"on","payloadType":"string","repeat":"","crontab":"","once":false,"x":174.2857208251953,"y":374.28570556640625,"wires":[["5c384ba7.a3c7b4"]]},{"id":"6ae43d1d.951bc4","type":"function","z":"30d36509.cf2c9a","name":"Telldus-live List All Device","func":"// Node-RED function to\n// a) list all Telldus devices (device = everything in Telldus Live except sensors)\n//\n// The code below relies on the following modules to be installed in the Node-RED environment, including being set up\n// in the functionGlobalContext section of the Node-RED settings.js config file (see last section of http://nodered.org/docs/writing-functions.html page)\n//\n// a) Telldus-Live module (https://github.com/TheThingSystem/node-telldus-live)\n//\n//\n// The function will fire one output message for each device it gets information about from Telldus Live.\n// By default the device id and name is included in the messages, but this can be customised as needed.\n//\n\n// Define Telldus Live API credentials\nvar publicKey    = 'FEHUVEW84RAFR5SP22RABURUPHAFRUNU',\n    privateKey   = 'ZUXEVEGA9USTAZEWRETHAQUBUR69U6EF',\n    token        = '13469c397c5216df6db311f991b09b3f055d36f2a',\n    tokenSecret  = '0b66cde0bc8c0afca00c56289b174cac',\n    cloud;\n\n\n// Create and log into new TelldusAPI object\ncloud = new context.global.telldusLive.TelldusAPI({ publicKey  : publicKey,\n    privateKey : privateKey });\n\ncloud.login(token, tokenSecret, function(err, user) {\n  if (!!err) return console.log('login error: ' + err.message);\n\n  // Get list of all devices. Use async call to avoid blocking\n  cloud.getDevices(function(err, devices) {\n    var f, i;\n\n    if (!!err) return console.log('getDevices: ' + err.message);\n\n    f = function(offset, p, s) {\n      return function(err, device) {\n        var d, type, types;\n\n        if (!!err) return console.log(s + ' id=' + p.id + ': ' + err.message);\n\n        var devInfo = 'Device list, id=' + device.id + ', name=' + device.name;\n        node.log (devInfo);\n\n        // Fire one output message for each pass of this function.\n        // An effect of this function being a callback (which is async by its nature) is that the devices\n        // will be returned in random order (i.e. not sorted from lowest to highest)\n        node.send({payload:devInfo});\n\n        return;\n      };\n    };\n\n    // Loop over all devices, asynchcronously get the data for each\n    for (i = 0; i < devices.length; i++) {\n      if (devices[i].type === 'device') cloud.getDeviceInfo(devices[i], f(i, devices[i], 'getDeviceInfo'));\n    }\n  });\n}).on('error', function(err) {\n  console.log('background error: ' + err.message);\n});\n\n\nreturn;","outputs":1,"noerr":0,"x":590.0000610351562,"y":287.1427694048202,"wires":[["970c5b7c.68f3a8"]]},{"id":"7e21cb81.81de34","type":"function","z":"30d36509.cf2c9a","name":"Telldus-live MQTT bridge","func":"// Node-RED function to\n// a) extract data from TelldusLive API, and\n// b) send that data to MQTT for later consumption by various MQTT clients\n//\n// The code below relies on the following modules to be installed in the Node-RED environment, including being set up\n// in the functionGlobalContext section of the Node-RED settings.js config file (see last section of http://nodered.org/docs/writing-functions.html page)\n//\n// a) MQTT module (https://www.npmjs.com/package/mqtt)\n// b) Telldus-Live module (https://github.com/TheThingSystem/node-telldus-live)\n//\n//\n// Code below borrows a lot from the test script at https://github.com/TheThingSystem/node-telldus-live, with main addition being the use of MQTT client to publish such messages.\n//\n\n// Define Telldus Live API credentials\nvar publicKey    = 'FEHUVEW84RAFR5SP22RABURUPHAFRUNU',\n    privateKey   = 'ZUXEVEGA9USTAZEWRETHAQUBUR69U6EF',\n    token        = '13469c397c5216df6db311f991b09b3f055d36f2a',\n    tokenSecret  = '0b66cde0bc8c0afca00c56289b174cac',\n    cloud\n  ;\n\nvar mqtt = context.global.mqttModule;\nvar mqttClient = mqtt.connect('mqtt://10.0.1.250');\n\nvar batteryStatus;\n\n\n// Convenience function to format datetimes in nice human readable format\nfunction formatDate(d){\n  if(typeof d === 'number') d = new Date(d);\n  if(!(d instanceof Date)) return d;\n  function pad(n){return n<10 ? '0'+n : n}\n  return d.getFullYear()+'-' +\n    pad(d.getMonth()+1)+'-'+\n    pad(d.getDate())+' '+\n    pad(d.getHours()) + \":\"+\n    pad(d.getMinutes()) + \":\"+\n    pad(d.getSeconds());\n}\n\n\n// Create and log into new TelldusAPI object\ncloud = new context.global.telldusLive.TelldusAPI({ publicKey  : publicKey,\n    privateKey : privateKey });\n\ncloud.login(token, tokenSecret, function(err, user) {\n\n  if (!!err) return console.log('login error: ' + err.message);\n\n  console.log('user: ');\n  console.log(user);\n  console.log('');\n  console.log('');\n\n  // \n  cloud.getSensors(function(err, sensors) {\n    var f, i;\n\n    if (!!err) return console.log('getSensors: ' + err.message);\n\n    f = function(offset, p, s) {\n\n      return function(err, sensor) {\n        var i, prop, props, type;\n\n        if (!!err) return console.log(s + ' id=' + p.id + ': ' + err.message);\n\n        console.log('sensor #' + offset + ' ' + s + ': '); console.log(sensor);\n        props =  { temp     : [ 'temperature', 'celcius',    'meteo' ],\n            humidity : [ 'humidity',    'percentage', 'meteo' ]\n        };\n\n        type = null;\n        for (i = 0; i < sensor.data.length; i++) {\n          type = props[sensor.data[i].name];\n          if (!!type) break;\n        }\n        if (!type) return;\n\n        console.log('/device/climate/' + (sensor.protocol || 'telldus') + '/' + type[2]);\n        console.log('    uuid=teldus:' + sensor.id);\n        console.log('    name: ' + sensor.name);\n        console.log('    status: ' + (p.online === '1' ? 'present' : 'absent'));\n        console.log('    battery: ' + sensor.battery);\n        console.log('    lastSample: ' + sensor.lastUpdated * 1000);\n        console.log('    lastSample: ' + '' + formatDate(sensor.lastUpdated * 1000));\n        console.log('    info:');\n\n\n        batteryStatus = '-'\n        if (sensor.battery === '253') {\n            batteryStatus = 'ok';\n        } else if (sensor.battery === '254') {\n            batteryStatus = 'unknown';\n        } else if (sensor.battery === '255') {\n            batteryStatus = 'low battery';\n        } else {\n            batteryStatus = sensor.battery;\n        }\n\n\n        mqttClient.publish('common/telldus live/' + sensor.clientName + '/sensors/' + sensor.name + '/telldus id', sensor.id);\n        mqttClient.publish('common/telldus live/' + sensor.clientName + '/sensors/' + sensor.name + '/protocol', '' + sensor.protocol);\n        mqttClient.publish('common/telldus live/' + sensor.clientName + '/sensors/' + sensor.name + '/last update', '' + sensor.lastUpdated * 1000);\n        mqttClient.publish('common/telldus live/' + sensor.clientName + '/sensors/' + sensor.name + '/last update nice', '' + formatDate(sensor.lastUpdated * 1000));\n        mqttClient.publish('common/telldus live/' + sensor.clientName + '/sensors/' + sensor.name + '/ignored', '' + sensor.ignored);\n        mqttClient.publish('common/telldus live/' + sensor.clientName + '/sensors/' + sensor.name + '/editable', '' + sensor.editable);\n        mqttClient.publish('common/telldus live/' + sensor.clientName + '/sensors/' + sensor.name + '/status', (p.online === '1' ? 'present' : 'absent'));\n        mqttClient.publish('common/telldus live/' + sensor.clientName + '/sensors/' + sensor.name + '/sensor id', sensor.sensorId);\n        mqttClient.publish('common/telldus live/' + sensor.clientName + '/sensors/' + sensor.name + '/timezone offset', '' + sensor.timezoneoffset);\n        mqttClient.publish('common/telldus live/' + sensor.clientName + '/sensors/' + sensor.name + '/battery status', batteryStatus);\n        mqttClient.publish('common/telldus live/' + sensor.clientName + '/sensors/' + sensor.name + '/mqtt last update', '' + Date.now());\n        mqttClient.publish('common/telldus live/' + sensor.clientName + '/sensors/' + sensor.name + '/mqtt last update nice', '' + formatDate(Date.now()));\n\n        for (i = 0; i < sensor.data.length; i++) {\n          prop =  props[sensor.data[i].name];\n          if (prop) console.log('      ' + prop[0] + ': \"' + prop[1] + '\"');\n        }\n        console.log('    values:');\n        for (i = 0; i < sensor.data.length; i++) {\n          prop =  props[sensor.data[i].name];\n          if (prop) console.log('      ' + prop[0] + ': ' + sensor.data[i].value);\n          mqttClient.publish('common/telldus live/' + sensor.clientName + '/sensors/' + sensor.name + '/data/' + prop[0] + '/value', sensor.data[i].value);\n          mqttClient.publish('common/telldus live/' + sensor.clientName + '/sensors/' + sensor.name + '/data/' + prop[0] + '/unit', prop[1]);\n        }\n        console.log('');\n      };\n    };\n\n    for (i = 0; i < sensors.length; i++) cloud.getSensorInfo(sensors[i], f(i, sensors[i], 'getSensorInfo'));\n\n  }).getDevices(function(err, devices) {\n    var f, i;\n\n    if (!!err) return console.log('getDevices: ' + err.message);\n\n    f = function(offset, p, s) {\n      return function(err, device) {\n        var d, type, types;\n\n        if (!!err) return console.log(s + ' id=' + p.id + ': ' + err.message);\n\n        console.log('device #' + offset + ' ' + s + ': '); console.log(device);\n        types = { 'selflearning-switch' : 'onoff',\n                'selflearning-dimmer' : 'dimmer',\n                'codeswitch'          : 'onoff' };\n\n        type = null;\n        d = device.model.split(':');\n        type = types[d[0]];\n        if (!type) return;\n\n        console.log('/device/switch' + '/' + (d[d.length - 1] || 'telldus') + '/' + type);\n        console.log('    uuid=teldus:' + device.id);\n        console.log('    perform: off, on');\n        console.log('    name: ' + device.name);\n        console.log('last update: ' + device.lastUpdated*1000);\n        console.log('    status: ' + (device.online === '0' ? 'absent' : device.status));\n        console.log('    info:');\n        if (type === 'dimmer') console.log('      dimmer: percentage');\n        console.log('    values:');\n        if (type === 'dimmer') console.log('      dimmer: ' + Math.round((1-(255 - device.statevalue)/255)*100) + '%');\n        console.log('');\n\n        mqttClient.publish('common/telldus live/' + device.client + '/devices/' + device.name + '/telldus id', device.id);\n        mqttClient.publish('common/telldus live/' + device.client + '/devices/' + device.name + '/protocol', '' + device.protocol);\n        mqttClient.publish('common/telldus live/' + device.client + '/devices/' + device.name + '/model', '' + device.model);\n        mqttClient.publish('common/telldus live/' + device.client + '/devices/' + device.name + '/state', '' + device.state);\n        mqttClient.publish('common/telldus live/' + device.client + '/devices/' + device.name + '/state value', '' + device.statevalue);\n        mqttClient.publish('common/telldus live/' + device.client + '/devices/' + device.name + '/methods', '' + device.methods);\n        mqttClient.publish('common/telldus live/' + device.client + '/devices/' + device.name + '/type', '' + type);\n        mqttClient.publish('common/telldus live/' + device.client + '/devices/' + device.name + '/client', '' + device.client);\n        mqttClient.publish('common/telldus live/' + device.client + '/devices/' + device.name + '/online', '' + device.online);\n        mqttClient.publish('common/telldus live/' + device.client + '/devices/' + device.name + '/editable', '' + device.editable);\n        mqttClient.publish('common/telldus live/' + device.client + '/devices/' + device.name + '/status', '' + (device.online === '0' ? 'absent' : device.status));\n        mqttClient.publish('common/telldus live/' + device.client + '/devices/' + device.name + '/mqtt last update', '' + Date.now());\n        mqttClient.publish('common/telldus live/' + device.client + '/devices/' + device.name + '/mqtt last update nice', '' + formatDate(Date.now()));\n\n        for (j = 0; j < device.parameter.length; j++) {\n          mqttClient.publish('common/telldus live/' + device.client + '/devices/' + device.name + '/data/' + device.parameter[j].name , '' + device.parameter[j].value);\n        }\n      };\n    };\n\n    for (i = 0; i < devices.length; i++) {\n      if (devices[i].type === 'device') cloud.getDeviceInfo(devices[i], f(i, devices[i], 'getDeviceInfo'));\n    }\n  });\n}).on('error', function(err) {\n  console.log('background error: ' + err.message);\n});\n\n\nreturn msg;\n","outputs":1,"noerr":0,"x":540.0000610351562,"y":358.5713408333918,"wires":[[]]},{"id":"ed27f4fe.12d808","type":"comment","z":"4d31febf.b2ce","name":"Living room information","info":"Publish the readings of the sensors in the living room to Thingspeak.","x":160,"y":520,"wires":[]},{"id":"a84d7416.57b288","type":"mqtt in","z":"30d36509.cf2c9a","name":"Color Changes","topic":"/sensornet/echo","broker":"9eac092b.6153f8","x":167.14285278320312,"y":502.8571472167969,"wires":[["a0548739.5fab78"]]},{"id":"a0548739.5fab78","type":"json","z":"30d36509.cf2c9a","name":"JSON","x":381.1428527832031,"y":502.8571472167969,"wires":[["a65c7dd.f59a38"]]},{"id":"a65c7dd.f59a38","type":"function","z":"30d36509.cf2c9a","name":"Get Color","func":"if (msg.payload.Command == \"COLOR\") {\n    var outputMsgs = [];\n    var color = msg.payload.Color.split(\",\");\n    for (var c in color) {\n        outputMsgs.push({payload:color[c]});\n    }\n    return [ outputMsgs ];\n} else {\n    return msg;\n}","outputs":"3","noerr":0,"x":559.1428527832031,"y":578.8571472167969,"wires":[["418295ec.be7d6c"],["418295ec.be7d6c"],["418295ec.be7d6c"]]},{"id":"418295ec.be7d6c","type":"debug","z":"30d36509.cf2c9a","name":"Color Debug","active":false,"console":"false","complete":"payload","x":758.1428527832031,"y":488.8571472167969,"wires":[]},{"id":"b4b8ae8a.4b475","type":"comment","z":"4d31febf.b2ce","name":"Balcony information","info":"Publish the readings of the sensors in the balcony to Thingspeak.","x":150,"y":1820,"wires":[]},{"id":"9158b2c.f6ea75","type":"comment","z":"4d31febf.b2ce","name":"Force to update","info":"Issue a \"dump\" topic on the MQTT net. Devices that response to this topic are suppose to update the sensor readings onto the MQTT net.","x":180,"y":320,"wires":[]},{"id":"d6be3781.2941c8","type":"comment","z":"4d31febf.b2ce","name":"Manual Color Control","info":"Set the color of the RingLED manually.","x":160,"y":1260,"wires":[]},{"id":"3c23a26b.c3dc5e","type":"http request","z":"30d36509.cf2c9a","name":"ThingTweet","method":"POST","ret":"txt","url":"https://api.thingspeak.com/apps/thingtweet/1/statuses/update","x":550.0000228881836,"y":692.85715675354,"wires":[["f113da68.0eec28"]]},{"id":"9164fc5.f6e9b","type":"template","z":"30d36509.cf2c9a","name":"Set Alert Tweet","field":"payload","format":"text","template":"api_key=IZYF8LAGP8393BTA&status=d edwios Alert: Intruder!!","x":322.85714285714283,"y":682.8571428571428,"wires":[["3c23a26b.c3dc5e"]]},{"id":"fc069501.03f968","type":"inject","z":"30d36509.cf2c9a","name":"","topic":"","payload":"","payloadType":"none","repeat":"","crontab":"","once":false,"x":141.42857142857142,"y":674.2857142857142,"wires":[["9164fc5.f6e9b"]]},{"id":"f113da68.0eec28","type":"debug","z":"30d36509.cf2c9a","name":"","active":false,"console":"false","complete":"true","x":854.2857142857142,"y":674.2857142857142,"wires":[]},{"id":"fb458296.04ba8","type":"debug","z":"30d36509.cf2c9a","name":"Telldus-live status","active":false,"console":"false","complete":"payload","x":920.0000801086426,"y":368.5714282989502,"wires":[]},{"id":"5c384ba7.a3c7b4","type":"change","z":"30d36509.cf2c9a","name":"Living Room Switch","rules":[{"t":"set","p":"deviceid","pt":"msg","to":"1605001","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":374.28570556640625,"y":432.85712242126465,"wires":[["d2d5e951.2d2a18"]]},{"id":"3cfa1c9b.c305e4","type":"inject","z":"30d36509.cf2c9a","name":"List all devices","topic":"","payload":"","payloadType":"none","repeat":"","crontab":"","once":false,"x":152.85713958740234,"y":275.7143154144287,"wires":[["6ae43d1d.951bc4"]]},{"id":"970c5b7c.68f3a8","type":"debug","z":"30d36509.cf2c9a","name":"","active":false,"console":"false","complete":"false","x":892.8571357727051,"y":270,"wires":[]},{"id":"79662148.8699e","type":"function","z":"30d36509.cf2c9a","name":"Motion Elapsed","func":"changed = false;\nmsg.payload = \"---\";\nif (changed) {\n    msg.payload = \"Changed\";\n    return msg;\n} else {\n    msg.payload = \"Not changed\";\n    return;\n}","outputs":1,"noerr":0,"x":328.5714416503906,"y":861.4285888671875,"wires":[["1e5f27ff.e1a0d8"]]},{"id":"1e5f27ff.e1a0d8","type":"debug","z":"30d36509.cf2c9a","name":"","active":false,"console":"false","complete":"false","x":540.000015258789,"y":791.4286499023435,"wires":[]},{"id":"2838ea5d.d7c716","type":"inject","z":"30d36509.cf2c9a","name":"","topic":"","payload":"","payloadType":"none","repeat":"","crontab":"","once":false,"x":135.71428298950195,"y":811.4285469055176,"wires":[["79662148.8699e"]]},{"id":"a06b86b4.5f9478","type":"function","z":"4d31febf.b2ce","name":"Motion Elapsed","func":"var now = new Date().getTime();    // contains the millisecond value since epoch needing to be divided by 1000 to get to Unix epoch time\nif (context.global.motion_elapsed === undefined)\n    context.global.motion_elapsed = now;\nvar elapsed = now - context.global.motion_elapsed;\n//context.global.motion_elapsed = now;\nif (msg.payload > 0) elapsed = 0;  // reset elapsed when we see motion\nmsg.payload = elapsed;\ncontext.global.nomotionfor = elapsed;\nreturn msg;","outputs":1,"noerr":0,"x":640,"y":940,"wires":[["466e7345.b9918c"]]},{"id":"466e7345.b9918c","type":"function","z":"4d31febf.b2ce","name":"When no motion for 30m","func":"if (!context.global.allarmed) {\n    if (context.global.enableAlarm && (context.global.nomotionfor > 30*60*1000)) {\n        return msg;\n    }\n}\nreturn;","outputs":1,"noerr":0,"x":870,"y":940,"wires":[["7b8f80ec.84708","942fe48c.6bd018"]]},{"id":"7b8f80ec.84708","type":"mqtt out","z":"4d31febf.b2ce","name":"Arm alarm","topic":"sensornet/command/arm","qos":"","retain":"","broker":"9eac092b.6153f8","x":1150,"y":940,"wires":[]},{"id":"942fe48c.6bd018","type":"debug","z":"4d31febf.b2ce","name":"Arm/Disarm","active":false,"console":"false","complete":"payload","x":1150,"y":1020,"wires":[]},{"id":"d2d5e951.2d2a18","type":"function","z":"30d36509.cf2c9a","name":"Telldus ONOFF","func":"// Node-RED function to\n// a) list all Telldus devices (device = everything in Telldus Live except sensors)\n//\n// The code below relies on the following modules to be installed in the Node-RED environment, including being set up\n// in the functionGlobalContext section of the Node-RED settings.js config file (see last section of http://nodered.org/docs/writing-functions.html page)\n//\n// a) Telldus-Live module (https://github.com/TheThingSystem/node-telldus-live)\n//\n//\n// The function will fire one output message for each device it gets information about from Telldus Live.\n// By default the device id and name is included in the messages, but this can be customised as needed.\n//\n\n// Define Telldus Live API credentials\nvar publicKey    = 'FEHUVEW84RAFR5SP22RABURUPHAFRUNU',\n    privateKey   = 'ZUXEVEGA9USTAZEWRETHAQUBUR69U6EF',\n    token        = '13469c397c5216df6db311f991b09b3f055d36f2a',\n    tokenSecret  = '0b66cde0bc8c0afca00c56289b174cac',\n    cloud\n  ;\n\nvar mydevice = msg.deviceid;\nvar onP = (msg.payload==='on');\n\n// Create and log into new TelldusAPI object\ncloud = new context.global.telldusLive.TelldusAPI({ publicKey  : publicKey,\n    privateKey : privateKey });\n\ncloud.login(token, tokenSecret, function(err, user) {\n  if (!!err) return console.log('login error: ' + err.message);\n\n  // Get list of all devices. Use async call to avoid blocking\n  cloud.getDevices(function(err, devices) {\n    var f, i;\n\n    if (!!err) return console.log('getDevices: ' + err.message);\n\n\n    f = function(err, result) {\n      return function(err, result) {\n        if (!!err) return console.log('onOffDevices: ' + err.message);\n        node.send({payload:result});\n        return;\n      };\n    };\n\n    // Loop over all devices, asynchcronously get the data for each\n    for (i = 0; i < devices.length; i++) {\n      if (devices[i].type === 'device' && devices[i].id === mydevice) {\n        node.log('found device: '+i+' '+devices[i].id);\n        cloud.onOffDevice(devices[i], onP, f);\n      }\n    }\n  });\n}).on('error', function(err) {\n  console.log('background error: ' + err.message);\n});\n\n\nreturn;\n","outputs":1,"noerr":0,"x":640,"y":428,"wires":[["fb458296.04ba8"]]},{"id":"7a538904.85ac78","type":"inject","z":"30d36509.cf2c9a","name":"Off","topic":"","payload":"off","payloadType":"string","repeat":"","crontab":"","once":false,"x":168,"y":442,"wires":[["5c384ba7.a3c7b4"]]},{"id":"2d13cc46.d2ec34","type":"debug","z":"4d31febf.b2ce","name":"Thingspeak outdoor result","active":false,"console":"false","complete":"payload","x":910,"y":1880,"wires":[]},{"id":"184db551.e7b24b","type":"inject","z":"30d36509.cf2c9a","name":"Telldus bridge","topic":"","payload":"","payloadType":"none","repeat":"","crontab":"","once":false,"x":151.4285659790039,"y":324.28569984436035,"wires":[["7e21cb81.81de34"]]},{"id":"d0746f0b.2f8b9","type":"inject","z":"4d31febf.b2ce","name":"Auto","topic":"","payload":"","payloadType":"string","repeat":"","crontab":"","once":false,"x":150,"y":1380,"wires":[["87752a1b.788ad8"]]},{"id":"87752a1b.788ad8","type":"function","z":"4d31febf.b2ce","name":"Set auto light","func":"context.global.auto_light=true;\nmsg.payload=context.global.balcony_temp;\nreturn msg;","outputs":1,"noerr":0,"x":310,"y":1380,"wires":[["700889f4.8ff778"]]},{"id":"6b9fb3b7.94604c","type":"function","z":"4d31febf.b2ce","name":"Unset auto light","func":"context.global.auto_light=false;\nreturn msg;","outputs":1,"noerr":0,"x":700,"y":1460,"wires":[["9a4340f9.65bcc"]]},{"id":"dd96bdcf.22694","type":"function","z":"4d31febf.b2ce","name":"Is auto?","func":"if (context.global.auto_light)\n    return msg;\nelse\n    return;\n","outputs":1,"noerr":0,"x":340,"y":2000,"wires":[["700889f4.8ff778"]]},{"id":"580faf47.a7f05","type":"comment","z":"4d31febf.b2ce","name":"Can use MQTT instead?","info":"","x":210,"y":1440,"wires":[]},{"id":"d4a74000.2b58c","type":"mqtt out","z":"30d36509.cf2c9a","name":"","topic":"","qos":"","retain":"","broker":"9eac092b.6153f8","x":788.5714285714284,"y":1038.5714285714284,"wires":[]},{"id":"38959531.c76a6a","type":"inject","z":"30d36509.cf2c9a","name":"White","topic":"sensornet/MagicLight-Spark/color","payload":"COLOR 200 200 200","payloadType":"string","repeat":"","crontab":"","once":false,"x":357.1428571428571,"y":1004.2857142857142,"wires":[["d4a74000.2b58c"]]},{"id":"4887e533.b7781c","type":"inject","z":"30d36509.cf2c9a","name":"Off","topic":"sensornet/MagicLight-Spark/off","payload":"","payloadType":"none","repeat":"","crontab":"","once":false,"x":359.9999885559082,"y":950.0000247955322,"wires":[["d4a74000.2b58c"]]},{"id":"23930613.dc6cfa","type":"inject","z":"30d36509.cf2c9a","name":"Blue","topic":"sensornet/MagicLight-Spark/color","payload":"COLOR 0 0 255","payloadType":"string","repeat":"","crontab":"","once":false,"x":364.28570556640625,"y":1071.4285888671875,"wires":[["d4a74000.2b58c"]]},{"id":"8f1eaf16.70e15","type":"inject","z":"30d36509.cf2c9a","name":"Warm white","topic":"sensornet/MagicLight-Spark/color","payload":"COLOR 200 200 80","payloadType":"string","repeat":"","crontab":"","once":false,"x":361.4285888671875,"y":1131.4285888671875,"wires":[["d4a74000.2b58c"]]},{"id":"bcad3373.4352d","type":"inject","z":"30d36509.cf2c9a","name":"Green","topic":"sensornet/MagicLight-Spark/color","payload":"COLOR 0 255 0","payloadType":"string","repeat":"","crontab":"","once":false,"x":361.4285888671875,"y":1191.4285888671875,"wires":[["d4a74000.2b58c"]]},{"id":"87b52cef.784ad","type":"inject","z":"30d36509.cf2c9a","name":"On","topic":"sensornet/MagicLight-Spark/on","payload":"COLOR 200 200 200","payloadType":"none","repeat":"","crontab":"","once":false,"x":348.5714416503906,"y":1251.4285888671875,"wires":[["d4a74000.2b58c"]]},{"id":"10897a69.ef7686","type":"mqtt out","z":"4d31febf.b2ce","name":"MagicLight","topic":"sensornet/MagicLight-Spark/color","qos":"","retain":"","broker":"9eac092b.6153f8","x":1570,"y":1720,"wires":[]},{"id":"b9a98082.46568","type":"template","z":"4d31febf.b2ce","name":"Rewite for MagicLight","field":"payload","format":"handlebars","template":"COLOR {{payload.r}} {{payload.g}} {{payload.b}}","x":1340,"y":2060,"wires":[["10897a69.ef7686"]]},{"id":"fccf4381.0330c","type":"inject","z":"4d31febf.b2ce","name":"Init","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":true,"x":154,"y":84,"wires":[["42606991.bd9f98"]]},{"id":"42606991.bd9f98","type":"function","z":"4d31febf.b2ce","name":"Set Initial Values","func":"context.global.auto_light=true;\ncontext.global.auto_magiclight=true;\ncontext.global.rLastUpdate=0;\ncontext.global.bLastUpdate=0;\ncontext.global.mLastUpdate=0;\ncontext.global.aqiTLastUpdate=0;\ncontext.global.aqiALastUpdate=0;\ncontext.global.aqi02ALastUpdate=0;\ncontext.global.uv0980ALastUpdate=0;\ncontext.global.balcony_temp=25;\ncontext.global.living_temp=25;\ncontext.global.living_co2=0;\ncontext.global.living_voc=0;\ncontext.global.masterbed_temp=25;\ncontext.global.aqitemp=25;\ncontext.global.aqihumi=25;\ncontext.global.aqipm25=0;\ncontext.global.aqiaqi=0;\ncontext.global.aqi02pm25=0;\ncontext.global.aqi02aqi=0;\ncontext.global.aqi02temp = 0;\ncontext.global.aqi02humi = 0;\ncontext.global.uv0980_uvi = 0;\ncontext.global.uv0980_uva = 0;\ncontext.global.uv0980_uvb = 0;\ncontext.global.uv0980_vis = 0;\ncontext.global.uv0980_ir = 0;\ncontext.global.uv0980_lux = 0;\ncontext.global.uv0980_temp = 0;\ncontext.global.uv0980_press = 0;\nglobal.set(\"lantern\", 0);\nglobal.set(\"kit_onoff\",0);\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":84,"wires":[[]]},{"id":"5bd6df21.a4292","type":"function","z":"4d31febf.b2ce","name":"MagicLight switch","func":"if (context.global.auto_magiclight === false) {\n    msg.payload = {'r':0,'g':0,'b':0}\n}\nreturn msg;","outputs":1,"noerr":0,"x":1110,"y":2060,"wires":[["b9a98082.46568"]]},{"id":"283859cf.d7c7a6","type":"function","z":"4d31febf.b2ce","name":"Set auto MagicLight","func":"context.global.auto_magiclight=true;\nmsg.payload=context.global.balcony_temp;\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":1580,"wires":[["c8e31f19.371ce"]]},{"id":"b154c3c5.4eab4","type":"inject","z":"4d31febf.b2ce","name":"Auto MagicLight","topic":"","payload":"","payloadType":"none","repeat":"","crontab":"","once":true,"x":190,"y":1580,"wires":[["283859cf.d7c7a6"]]},{"id":"35284e76.cad7b2","type":"function","z":"4d31febf.b2ce","name":"Unset Auto MagicLight","func":"context.global.auto_magiclight=false;\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":1720,"wires":[["10897a69.ef7686"]]},{"id":"f7f9fcd5.0806","type":"inject","z":"4d31febf.b2ce","name":"MagicLight Off","topic":"","payload":"COLOR 0 0 0","payloadType":"string","repeat":"","crontab":"","once":false,"x":180,"y":1640,"wires":[["35284e76.cad7b2"]]},{"id":"5c0f491a.a3f0b8","type":"mongodb out","z":"4d31febf.b2ce","mongodb":"d3cae7a7.2c3518","name":"Insert Home IOT","collection":"environment","payonly":false,"upsert":false,"multi":false,"operation":"insert","x":660,"y":2160,"wires":[]},{"id":"306fcbe9.cf9034","type":"mongodb out","z":"4d31febf.b2ce","mongodb":"d3cae7a7.2c3518","name":"Insert Home IOT","collection":"environment","payonly":false,"upsert":false,"multi":false,"operation":"insert","x":640,"y":560,"wires":[]},{"id":"40251bd8.bfdae4","type":"comment","z":"4d31febf.b2ce","name":"Initialization","info":"###Initialization\n","x":199,"y":36,"wires":[]},{"id":"c8e31f19.371ce","type":"function","z":"4d31febf.b2ce","name":"Balcony Temperature","func":"var qtime = new Date()\nqtime = qtime - 30*60*1000\nvar query = {}\nquery[\"topic\"] = /\\/balcony\\/temperature$/i\nquery[\"dtime\"] = {\"$gt\": qtime}\nvar proj = {topic:1,payload:1,dtime:1,_id:0}\nmsg.projection = proj\nmsg.payload = query\nmsg.limit=1\nmsg.skip=0\nmsg.sort={dtime:-1}\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":1640,"wires":[["69185134.96e7b"]]},{"id":"69185134.96e7b","type":"mongodb in","z":"4d31febf.b2ce","mongodb":"d3cae7a7.2c3518","name":"Lookup DB","collection":"environment","operation":"find","x":670,"y":1640,"wires":[["ef949fdf.106b6"]]},{"id":"ef949fdf.106b6","type":"function","z":"4d31febf.b2ce","name":"First element","func":"var val = msg.payload;\nif (val) {\n    if (val.length > 0) {\n        val=val[0];\n        msg.payload=val.payload;\n    }\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":850,"y":1640,"wires":[["700889f4.8ff778","86813045.797ed"]]},{"id":"86813045.797ed","type":"debug","z":"4d31febf.b2ce","name":"","active":false,"console":"false","complete":"false","x":1050,"y":1640,"wires":[]},{"id":"1bff0235.e400fe","type":"debug","z":"4d31febf.b2ce","name":"Thingspeak master bedroom result","active":false,"console":"false","complete":"payload","x":1000,"y":3000,"wires":[]},{"id":"de63e4a7.219c18","type":"http request","z":"4d31febf.b2ce","name":"Thingspeak update","method":"GET","ret":"txt","url":"https://api.thingspeak.com/update?key={{{APIKey}}}&field1={{{field1}}}&field2={{{field2}}}&field3={{{field3}}}","x":669.2499313354492,"y":2979.6669931411743,"wires":[["1bff0235.e400fe"]]},{"id":"a83db9bd.57c248","type":"function","z":"4d31febf.b2ce","name":"Thingspeak data","func":"var d = new Date()\nmsg.dtime = d.getTime()\nmsg.field1=context.global.masterbed_temp\nmsg.field2=context.global.masterbed_humi\nmsg.field3=context.global.masterbed_brgt\nmsg.APIKey=\"7S4RBIU2SQ99W5IU\"\nif (msg.field1 === null || msg.field2 === null || msg.field3 === null) {\n    return; // eliminate null fields\n} else {\n    return msg;\n}","outputs":1,"noerr":0,"x":442.8332748413086,"y":2978.50003862381,"wires":[["de63e4a7.219c18"]]},{"id":"3564ff80.ca9b","type":"mqtt in","z":"4d31febf.b2ce","name":"Master Bedroom temp","topic":"sensornet/env/home/masterbed/temperature","broker":"9eac092b.6153f8","x":197.16661071777344,"y":3004.6669931411743,"wires":[["a83db9bd.57c248","129e60d7.ed619f"]]},{"id":"77413446.88becc","type":"mqtt in","z":"4d31febf.b2ce","name":"Master bedroom humi","topic":"sensornet/env/home/masterbed/humidity","broker":"9eac092b.6153f8","x":197.5832748413086,"y":3052.1669940948486,"wires":[["54b3c5ac.ab4c3c"]]},{"id":"129e60d7.ed619f","type":"function","z":"4d31febf.b2ce","name":"Context var","func":"var d = new Date()\nmsg.dtime = d.getTime()\nif (msg.payload) {\n    context.global.masterbed_temp=msg.payload\n    return msg\n}\nreturn\n","outputs":1,"noerr":0,"x":436.7499008178711,"y":3019.25,"wires":[["192b5b8e.e6d4a4"]]},{"id":"54b3c5ac.ab4c3c","type":"function","z":"4d31febf.b2ce","name":"Context var","func":"var d = new Date()\nmsg.dtime = d.getTime()\nif (msg.payload) {\n    context.global.masterbed_humi=msg.payload\n    return msg\n}\nreturn\n","outputs":1,"noerr":0,"x":440.0832748413086,"y":3056.3334980010986,"wires":[["192b5b8e.e6d4a4"]]},{"id":"5c090a2c.a3f6f4","type":"comment","z":"4d31febf.b2ce","name":"Master bed room information","info":"Publish the readings of the sensors in the master bed room to Thingspeak.","x":200,"y":2920,"wires":[]},{"id":"192b5b8e.e6d4a4","type":"mongodb out","z":"4d31febf.b2ce","mongodb":"d3cae7a7.2c3518","name":"Insert Home IOT","collection":"environment","payonly":false,"upsert":false,"multi":false,"operation":"insert","x":662.916618347168,"y":3019.7500019073486,"wires":[]},{"id":"abcc72fb.54339","type":"mqtt in","z":"4d31febf.b2ce","name":"Master Bedroom bright","topic":"sensornet/env/home/masterbed/brightness","broker":"9eac092b.6153f8","x":199.41661071777344,"y":3103.4165058135986,"wires":[["a0948c98.5f6b7"]]},{"id":"a0948c98.5f6b7","type":"function","z":"4d31febf.b2ce","name":"Context var","func":"var d = new Date()\nmsg.dtime = d.getTime()\nif (msg.payload) {\n    context.global.masterbed_brgt=msg.payload\n    return msg\n}\nreturn\n","outputs":1,"noerr":0,"x":441.0832748413086,"y":3094.250002861023,"wires":[["192b5b8e.e6d4a4"]]},{"id":"cf5cfd77.30a3","type":"mqtt in","z":"4d31febf.b2ce","name":"MagicLight status","topic":"sensornet/status/MagicLight-Spark","broker":"9eac092b.6153f8","x":170,"y":1500,"wires":[["78b64a0b.8749b4"]]},{"id":"78b64a0b.8749b4","type":"function","z":"4d31febf.b2ce","name":"MagicLight Init","func":"var str = msg.payload;\nif ((str == 'ready') && context.global.auto_magiclight)\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":1500,"wires":[["283859cf.d7c7a6"]]},{"id":"e7131108.8644c","type":"http in","z":"4836b9b7.e4bd18","name":"","url":"/k2test","method":"get","swaggerDoc":"","x":193.66665649414062,"y":244.6666488647461,"wires":[["bc5eac7b.be3fb"]]},{"id":"fdddfebb.97e7c","type":"http response","z":"4836b9b7.e4bd18","name":"/k2test","x":773.6666564941406,"y":225.6666488647461,"wires":[]},{"id":"ecbbc643.e26ca8","type":"switch","z":"4836b9b7.e4bd18","name":"R/W/P?","property":"req.query.action","propertyType":"msg","rules":[{"t":"eq","v":"read","vt":"str"},{"t":"eq","v":"write","vt":"str"},{"t":"eq","v":"power","vt":"str"}],"checkall":"false","outputs":3,"x":100.38073348999023,"y":830.238037109375,"wires":[["8359f34f.c40c2"],["5b17ff10.c0ee2"],["80bd94ba.acd508"]]},{"id":"1a0c25a5.00e7ba","type":"change","z":"4836b9b7.e4bd18","name":"Device n to IP","rules":[{"t":"change","p":"req.query.device","pt":"msg","from":"^1$","fromt":"re","to":"10.0.1.246","tot":"str"},{"t":"change","p":"req.query.device","pt":"msg","from":"^2$","fromt":"re","to":"10.0.1.247","tot":"str"},{"t":"change","p":"req.query.device","pt":"msg","from":"^3$","fromt":"re","to":"10.0.1.248","tot":"str"},{"t":"change","p":"req.query.state","pt":"msg","from":"^on$","fromt":"re","to":"1","tot":"str"},{"t":"change","p":"req.query.state","pt":"msg","from":"^off$","fromt":"re","to":"0","tot":"str"},{"t":"change","p":"req.query.homekit","pt":"msg","from":"true","fromt":"bool","to":"1","tot":"str"},{"t":"change","p":"req.query.homekit","pt":"msg","from":"false","fromt":"bool","to":"0","tot":"str"},{"t":"change","p":"req.query.device","pt":"msg","from":"^4$","fromt":"re","to":"10.0.1.241","tot":"str"},{"t":"change","p":"req.query.device","pt":"msg","from":"^5$","fromt":"re","to":"10.0.1.242","tot":"str"},{"t":"change","p":"req.query.device","pt":"msg","from":"^6$","fromt":"re","to":"10.0.1.243","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":451.6666259765625,"y":518.6666564941406,"wires":[["d5d4f56.f0f7308"]]},{"id":"c13379cf.731ef8","type":"debug","z":"4836b9b7.e4bd18","name":"","active":false,"console":"false","complete":"true","x":935.5237426757812,"y":451.761962890625,"wires":[]},{"id":"bc5eac7b.be3fb","type":"template","z":"4836b9b7.e4bd18","name":"Example","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"Switch is {{req.query.switch}} and action is {{req.query.action}}.<br/>\nDevice IP is {{req.query.device}}","x":472.6666564941406,"y":228.66666412353516,"wires":[["fdddfebb.97e7c"]]},{"id":"b16d005.5ecb","type":"http in","z":"4836b9b7.e4bd18","name":"","url":"/k2control","method":"get","swaggerDoc":"","x":163.66665649414062,"y":436.6666259765625,"wires":[["fa8e2102.fefa2"]]},{"id":"bcd17846.43aeb8","type":"http response","z":"4836b9b7.e4bd18","name":"/nodes/k2control","x":1607.619140625,"y":814.8570556640625,"wires":[]},{"id":"182d09bc.8b7cb6","type":"http request","z":"4836b9b7.e4bd18","name":"GetSessionID from Device","method":"POST","ret":"txt","url":"","tls":"","x":713.5238037109375,"y":542.238037109375,"wires":[["c13379cf.731ef8","a22a7b8b.438d38"]]},{"id":"aeaca2f5.c7f8f","type":"template","z":"4836b9b7.e4bd18","name":"Set URL","field":"url","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"http://{{req.query.device}}/ubus","x":642.6666259765625,"y":614.6666259765625,"wires":[["182d09bc.8b7cb6"]]},{"id":"fac6a78.93dfa58","type":"change","z":"4836b9b7.e4bd18","name":"Prepare JSON payload","rules":[{"t":"set","p":"payload","pt":"msg","to":"{ \"jsonrpc\": \"2.0\", \"id\": 1, \"method\": \"call\", \"params\": [ \"00000000000000000000000000000000\", \"session\", \"login\", { \"username\": \"root\", \"password\": \"Akihabara\"  } ] }","tot":"str"},{"t":"set","p":"topic","pt":"msg","to":"/HomeIoT/k2control","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":445.6666259765625,"y":614.6666259765625,"wires":[["aeaca2f5.c7f8f"]]},{"id":"2ca36659.398dba","type":"json","z":"4836b9b7.e4bd18","name":"","x":1316.6666259765625,"y":539.3333129882812,"wires":[["ecbbc643.e26ca8"]]},{"id":"5b17ff10.c0ee2","type":"template","z":"4836b9b7.e4bd18","name":"Write","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{ \"jsonrpc\": \"2.0\", \"id\": 1, \"method\": \"call\", \"params\": [ \"{{payload.result.1.ubus_rpc_session}}\", \"file\", \"write\", { \"path\": \"/sys/class/leds/i-konke:{{req.query.switch}}/brightness\", \"data\":\"{{req.query.state}}\" } ] }\n","x":273.8096046447754,"y":835.1428852081299,"wires":[["dc2df024.e8ba68"]]},{"id":"d5d4f56.f0f7308","type":"change","z":"4836b9b7.e4bd18","name":"Control to GPIO type","rules":[{"t":"change","p":"req.query.switch","pt":"msg","from":"^USB$","fromt":"re","to":"green:usb","tot":"str"},{"t":"change","p":"req.query.switch","pt":"msg","from":"^Light$","fromt":"re","to":"yellow:light","tot":"str"},{"t":"change","p":"req.query.switch","pt":"msg","from":"^Relay$","fromt":"re","to":"red:relay","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":196,"y":603.6666870117188,"wires":[["fac6a78.93dfa58"]]},{"id":"a65689cb.f59f48","type":"comment","z":"4836b9b7.e4bd18","name":"Control URL example","info":"Call example\n------------\n\nDevice [1,2,3]\n\nState  [on/off]\n\nAction [write]\n\nSwitch [Light, USB, Relay]\n\nhttp://10.0.1.253:1880/nodes/k2control?switch=Light&action=write&device=1&state=off","x":625.6666259765625,"y":327.3333435058594,"wires":[]},{"id":"e46f2f1f.a9d37","type":"template","z":"4836b9b7.e4bd18","name":"jQuery HTML","field":"payload","fieldType":"msg","format":"html","syntax":"mustache","template":"<!doctype html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"utf-8\">\n  <title>K2 Control</title>\n\t<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n  <link rel=\"stylesheet\" href=\"/jq/smoothness/jquery-ui.css\">\n\t<link rel=\"stylesheet\" href=\"/jq/mobile/jquery.mobile-1.4.5.min.css\" />\n  <link rel=\"stylesheet\" href=\"/jq/ui/1.11.4/themes/smoothness/jquery-ui.css\">\n  <script src=\"/jq/jquery-1.10.2.js\"></script>\n  <script src=\"/jq/ui/1.11.4/jquery-ui.js\"></script>\n  <link rel=\"stylesheet\" href=\"/resources/demos/style.css\">\n  <script>\n  $(function() {\n    $( \"input[type=submit], a, button\" )\n      .button()\n      .click(function( event ) {\n        event.preventDefault();\n      });\n  });\n  </script>\n</head>\n<body>\n \n<a href=\"#\">An anchor</a>\n \n \n</body>\n</html>\n","x":498.5714285714285,"y":1135.7142857142856,"wires":[["72ad98ff.234308"]]},{"id":"a6cb0910.401d98","type":"http in","z":"4836b9b7.e4bd18","name":"/k2","url":"/k2","method":"get","swaggerDoc":"","x":229.99999999999997,"y":1067.142857142857,"wires":[["e46f2f1f.a9d37"]]},{"id":"72ad98ff.234308","type":"http response","z":"4836b9b7.e4bd18","name":"/k2","x":872.8571428571428,"y":1054.2857142857142,"wires":[]},{"id":"985f54b2.70eec8","type":"json","z":"4d31febf.b2ce","name":"","x":521.3332748413086,"y":3175.9165058135986,"wires":[["d16385ec.62bf28","89896fb.728249","c5872bb6.b16a28"]]},{"id":"d16385ec.62bf28","type":"mongodb out","z":"4d31febf.b2ce","mongodb":"d3cae7a7.2c3518","name":"Insert Home IOT","collection":"environment","payonly":false,"upsert":false,"multi":false,"operation":"insert","x":690.3332443237305,"y":3179.0834980010986,"wires":[]},{"id":"826815d8.650d88","type":"mqtt in","z":"4d31febf.b2ce","name":"AQI01","topic":"sensornet/aqi/AQI01/allvalues","broker":"9eac092b.6153f8","x":155.83327102661133,"y":3158.1665077209473,"wires":[["33207f1d.1de5c"]]},{"id":"33207f1d.1de5c","type":"function","z":"4d31febf.b2ce","name":"Add timestamp","func":"var d = new Date()\nmsg.dtime = d.getTime()\nreturn msg;","outputs":1,"noerr":0,"x":354.9999465942383,"y":3175.5000038146973,"wires":[["985f54b2.70eec8"]]},{"id":"111ccd89.815672","type":"mqtt in","z":"4d31febf.b2ce","name":"AQI01-tem","topic":"sensornet/aqi/AQI01/temperature","broker":"9eac092b.6153f8","x":164.99993896484375,"y":3210.9165077209473,"wires":[["33207f1d.1de5c"]]},{"id":"c40c3a61.775a38","type":"inject","z":"30d36509.cf2c9a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":307.5,"y":1862.5,"wires":[["f2aacd1.5caf93"]]},{"id":"f2aacd1.5caf93","type":"function","z":"30d36509.cf2c9a","name":"Latest Temperature","func":"var qtime = new Date()\nqtime = qtime - 30*60*1000\nvar query = {}\nquery[\"topic\"] = /\\/aqi\\/AQI01\\/temperature$/i\nquery[\"dtime\"] = {\"$gt\": qtime}\nvar proj = {topic:1,payload:1,dtime:1,_id:0}\nmsg.projection = proj\nmsg.payload = query\nmsg.limit=1\nmsg.sort={dtime:-1}\nreturn msg;","outputs":1,"noerr":0,"x":489.0833740234375,"y":1883.00048828125,"wires":[["fbb9b039.7c60d"]]},{"id":"fbb9b039.7c60d","type":"mongodb in","z":"30d36509.cf2c9a","mongodb":"d3cae7a7.2c3518","name":"Lookup DB","collection":"environment","operation":"find","x":184.33333587646484,"y":2021.7502504984532,"wires":[["875e9cbd.7c869"]]},{"id":"875e9cbd.7c869","type":"function","z":"30d36509.cf2c9a","name":"First element","func":"msg.payload=msg.payload[0]\nreturn msg;","outputs":1,"noerr":0,"x":399.3333053588867,"y":1983.7503086725865,"wires":[["612f6d96.9a2b14"]]},{"id":"612f6d96.9a2b14","type":"debug","z":"30d36509.cf2c9a","name":"","active":false,"console":"false","complete":"false","x":618.7499313354492,"y":1999.5000645319615,"wires":[]},{"id":"ad6d9d1a.9d558","type":"mqtt in","z":"4d31febf.b2ce","name":"AQI02","topic":"sensornet/aqi/AQI02/allvalues","qos":"0","broker":"9eac092b.6153f8","x":150,"y":3400,"wires":[["eaab8916.ae63a8"]]},{"id":"eaab8916.ae63a8","type":"function","z":"4d31febf.b2ce","name":"Add timestamp and counter","func":"var d = new Date();\nmsg.dtime = d.getTime();\n//var aqi02counter = global.get(\"aqi02counter\");\nvar aqi02counter = context.global.aqi02counter;\nif (aqi02counter === undefined) {\n    aqi02counter = 0;\n} else {\n    aqi02counter++;\n}\n//global.set(\"aqi02counter\", aqi02counter);\ncontext.global.aqi02counter = aqi02counter;\nif (aqi02counter > 3) {\n    return msg;\n} else {\n    return null;\n}","outputs":"1","noerr":0,"x":370.8332748413086,"y":3400.6669931411743,"wires":[["cc64c44d.d6f148"]]},{"id":"cc64c44d.d6f148","type":"json","z":"4d31febf.b2ce","name":"","x":570,"y":3400,"wires":[["a830fc4f.d1d8","dbd151a0.1d418","9b51f2ed.43376"]]},{"id":"a830fc4f.d1d8","type":"mongodb out","z":"4d31febf.b2ce","mongodb":"d3cae7a7.2c3518","name":"Insert Home IOT","collection":"environment","payonly":false,"upsert":false,"multi":false,"operation":"insert","x":800,"y":3400,"wires":[]},{"id":"e8de86ae.602568","type":"inject","z":"4d31febf.b2ce","name":"AQI02 Measure","topic":"sensornet/AQI02/deviceon","payload":"","payloadType":"str","repeat":"","crontab":"*/10 0-23 * * *","once":false,"x":190,"y":3580,"wires":[["71da8602.5aaec8","826a0694.409b18"]]},{"id":"ea0e29d0.2d0e28","type":"mqtt out","z":"4d31febf.b2ce","name":"AQI02","topic":"","qos":"0","retain":"false","broker":"9eac092b.6153f8","x":1010,"y":3580,"wires":[]},{"id":"71da8602.5aaec8","type":"delay","z":"4d31febf.b2ce","name":"","pauseType":"delay","timeout":"30","timeoutUnits":"seconds","rate":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":371.6666793823242,"y":3650.0004453659058,"wires":[["13a14ce4.5aa633"]]},{"id":"13a14ce4.5aa633","type":"change","z":"4d31febf.b2ce","name":"AQI02 off","rules":[{"t":"set","p":"topic","to":"sensornet/AQI02/deviceoff","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":550.0000190734863,"y":3650.0001249313354,"wires":[["ea0e29d0.2d0e28","6e010194.ae5ee"]]},{"id":"dbd151a0.1d418","type":"debug","z":"4d31febf.b2ce","name":"","active":false,"console":"false","complete":"false","x":790,"y":3460,"wires":[]},{"id":"826a0694.409b18","type":"function","z":"4d31febf.b2ce","name":"Reset AQI02 counter","func":"//global.set(\"aqi02counter\") = 0;\ncontext.global.aqi02counter = 0;\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":3580,"wires":[["ea0e29d0.2d0e28"]]},{"id":"6e010194.ae5ee","type":"function","z":"4d31febf.b2ce","name":"AQI02 All","func":"var qtime = new Date()\nqtime = qtime - 30*60*1000\nvar query = {}\nquery[\"topic\"] = /\\/aqi\\/AQI02\\/allvalues$/i\nquery[\"dtime\"] = {\"$gt\": qtime}\nvar proj = {topic:1,payload:1,dtime:1,_id:0}\nmsg.projection = proj\nmsg.payload = query\nmsg.limit=10\nmsg.skip=0\nmsg.sort={dtime:-1}\nreturn msg;","outputs":1,"noerr":0,"x":309.9999465942383,"y":3767.7777948379517,"wires":[["cff4581b.fc5a18"]]},{"id":"cff4581b.fc5a18","type":"mongodb in","z":"4d31febf.b2ce","mongodb":"d3cae7a7.2c3518","name":"Lookup DB","collection":"environment","operation":"find","x":478.9800262451172,"y":3769.2250604629517,"wires":[["bc2baf67.77ff"]]},{"id":"bc2baf67.77ff","type":"function","z":"4d31febf.b2ce","name":"Average over","func":"var val = msg.payload;\nvar tval;\nvar skip=4; // skip the first 4 early samples\nif (val) {\n    var count = val.length;\n    var i = 0;\n    var pm25 = 0, aqi = 0, tp =0, hm = 0;\n    if (count > 0) {\n        for (i=skip; i < count; i++) {\n            tval=val[i];\n            pm25+=tval.payload.pm25;\n            aqi+=tval.payload.aqi;\n            dtime = tval.dtime;\n        }\n        pm25 = pm25/(i-skip);\n        aqi = aqi/(i-skip);\n//        msg.payload = \"{\\\"pm25\\\":\"+pm25+\",\\\"aqi\\\":\"+aqi+\"}\";\n        msg.payload = { \"pm25\": pm25,\n                        \"aqi\" : aqi,\n                        \"temperature\": tp,\n                        \"humidity\" : hm,\n                        \"dtime\": dtime}\n    }\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":668.6625823974609,"y":3769.9953508377075,"wires":[["b631c0aa.0717e","63da4cd3.951504"]]},{"id":"b631c0aa.0717e","type":"switch","z":"4d31febf.b2ce","name":"Air dirty?","property":"payload.aqi","propertyType":"msg","rules":[{"t":"gt","v":"60","vt":"num"},{"t":"lte","v":"50","vt":"num"}],"checkall":"true","outputs":2,"x":855.3332290649414,"y":3802.99986743927,"wires":[["fb802a04.e273c"],["1f15e5a4.1e196a"]]},{"id":"8c3eded2.02903","type":"mqtt in","z":"4836b9b7.e4bd18","name":"Living Room Set","topic":"sensornet/controllers/livingroom/relay/set","qos":"0","broker":"9eac092b.6153f8","x":181.5,"y":1264,"wires":[["8b9a6bbe.a4f1c8","c71ab9b2.4bd1a8"]]},{"id":"8b9a6bbe.a4f1c8","type":"debug","z":"4836b9b7.e4bd18","name":"","active":false,"console":"false","complete":"false","x":447.21427154541016,"y":1363.2855529785156,"wires":[]},{"id":"8359f34f.c40c2","type":"template","z":"4836b9b7.e4bd18","name":"Read","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{ \"jsonrpc\": \"2.0\", \"id\": 1, \"method\": \"call\", \"params\": [ \"{{payload.result.1.ubus_rpc_session}}\", \"file\", \"read\", { \"path\": \"/sys/class/leds/i-konke:{{req.query.switch}}/brightness\" } ] }\n","x":271.42856216430664,"y":782.8571910858154,"wires":[["dc2df024.e8ba68"]]},{"id":"b9db27d.64a8ed8","type":"function","z":"4836b9b7.e4bd18","name":"Compose JSON result","func":"var result = msg.payload.result;\nvar hk = msg.req.query.homekit;\nmsg.statusCode=200;\ndelete msg.headers[\"transfer-encoding\"];\nvar pw = false;\nif (msg.req.query.action == \"power\") {\n    pw = true;\n}\nif (hk === undefined) {\n    hk = 1; // Default HomeKit\n}\nif (hk == 1) {\n    msg.headers[\"Content-Type\"]=\"text/plain\";\n}\nif ((result === undefined) || (result === 0)) {\n    if (hk) {\n        msg.payload = -1;\n    } else {\n        msg.payload = {\"result\": \"error\"};\n    }\n    msg.headers[\"Content-Length\"]=msg.payload.length;\n    return msg;    \n}\nif (result.length == 1) {\n    result = ''+msg.payload.result[0]+'';\n} else if (result.length == 2) {\n    result = msg.payload.result[1].data.trim();\n}\nif (pw) {\n    var results = result.split(\" \");\n    msg.payload = results[0];\n} else {\n    if (hk == 1) {\n        if (result != \"0\") {\n            result = \"1\";\n        } else {\n            result = \"0\";\n        }\n        msg.payload = result;\n    } else {\n        msg.payload = {\"result\": result};\n    }\n}\nmsg.headers[\"Content-Length\"]=msg.payload.length;\nreturn msg;","outputs":1,"noerr":0,"x":1113.90478515625,"y":816.8095703125,"wires":[["d0787879.82484","bcd17846.43aeb8"]]},{"id":"1165bb09.522f35","type":"http request","z":"4836b9b7.e4bd18","name":"Switch On","method":"GET","ret":"obj","url":"http://10.0.1.253:1880/nodes/k2control?switch=Relay&action=write&device=3&state=on","x":634.9999618530273,"y":1212.85715675354,"wires":[["cca17fb6.b6015","2517273.698ddd8"]]},{"id":"c71ab9b2.4bd1a8","type":"switch","z":"4836b9b7.e4bd18","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"true","vt":"str"},{"t":"eq","v":"false","vt":"str"}],"checkall":"false","outputs":2,"x":419.2857142857142,"y":1254.2857142857142,"wires":[["1165bb09.522f35"],["432bb221.56b3bc"]]},{"id":"432bb221.56b3bc","type":"http request","z":"4836b9b7.e4bd18","name":"Switch Off","method":"GET","ret":"obj","url":"http://10.0.1.253:1880/nodes/k2control?switch=Relay&action=write&device=3&state=off","x":638.571418762207,"y":1277.142939567566,"wires":[["c7128c6.86ebb7","cca17fb6.b6015"]]},{"id":"a029dd37.f16a1","type":"mqtt out","z":"4836b9b7.e4bd18","name":"Get status","topic":"sensornet/controllers/livingroom/relay/status","qos":"","retain":"","broker":"9eac092b.6153f8","x":1107.8571472167969,"y":1238.5714416503906,"wires":[]},{"id":"c7128c6.86ebb7","type":"function","z":"4836b9b7.e4bd18","name":"Return OFF","func":"var result = msg.payload.result;\nif (result == \"1\" || result == \"2\") {\n    result = false;\n} else {\n    result = false;\n}\nmsg.payload = result;\nreturn msg;","outputs":1,"noerr":0,"x":862.8571891784668,"y":1269.9999961853027,"wires":[["a029dd37.f16a1"]]},{"id":"cca17fb6.b6015","type":"debug","z":"4836b9b7.e4bd18","name":"","active":false,"console":"false","complete":"false","x":1129.28568649292,"y":1334.2857084274292,"wires":[]},{"id":"59c051e4.3044e","type":"mqtt in","z":"4836b9b7.e4bd18","name":"Charging Station Set","topic":"sensornet/controllers/chargingstation/relay/set","qos":"0","broker":"9eac092b.6153f8","x":190.00000762939453,"y":1491.428581237793,"wires":[["6bacd82c.8338d8","42737f10.95274"]]},{"id":"6bacd82c.8338d8","type":"debug","z":"4836b9b7.e4bd18","name":"","active":false,"console":"false","complete":"false","x":445.7142791748047,"y":1590.7141342163086,"wires":[]},{"id":"42737f10.95274","type":"switch","z":"4836b9b7.e4bd18","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"true","vt":"str"},{"t":"eq","v":"false","vt":"str"}],"checkall":"true","outputs":2,"x":417.78572191510875,"y":1481.7142955235072,"wires":[["cd9e8f82.72f19"],["f55c3690.a003e8"]]},{"id":"cd9e8f82.72f19","type":"http request","z":"4836b9b7.e4bd18","name":"Switch On","method":"GET","ret":"obj","url":"http://10.0.1.253:1880/nodes/k2control?switch=Relay&action=write&device=2&state=on","x":633.4999694824219,"y":1440.285737991333,"wires":[["94ab054b.424dd8"]]},{"id":"f55c3690.a003e8","type":"http request","z":"4836b9b7.e4bd18","name":"Switch Off","method":"GET","ret":"obj","url":"http://10.0.1.253:1880/nodes/k2control?switch=Relay&action=write&device=2&state=off","x":637.0714263916016,"y":1504.571520805359,"wires":[["50bac468.1bab9c"]]},{"id":"4133a6ad.b402b8","type":"mqtt out","z":"4836b9b7.e4bd18","name":"Get status","topic":"sensornet/controllers/livingroom/relay/status","qos":"","retain":"","broker":"9eac092b.6153f8","x":1106.3571548461914,"y":1466.0000228881836,"wires":[]},{"id":"2517273.698ddd8","type":"function","z":"4836b9b7.e4bd18","name":"Return ON","func":"var result = msg.payload.result;\nif (result == \"1\" || result == \"2\") {\n    result = true;\n} else {\n    result = false;\n}\nmsg.payload = result;\nreturn msg;","outputs":1,"noerr":0,"x":865.7142715454102,"y":1210.0000314712524,"wires":[["a029dd37.f16a1"]]},{"id":"94ab054b.424dd8","type":"function","z":"4836b9b7.e4bd18","name":"Return ON","func":"var result = msg.payload.result;\nif (result == \"1\" || result == \"2\") {\n    result = true;\n} else {\n    result = false;\n}\nmsg.payload = result;\nreturn msg;","outputs":1,"noerr":0,"x":860,"y":1447.142822265625,"wires":[["4133a6ad.b402b8"]]},{"id":"50bac468.1bab9c","type":"function","z":"4836b9b7.e4bd18","name":"Return OFF","func":"var result = msg.payload.result;\nif (result == \"1\" || result == \"2\") {\n    result = false;\n} else {\n    result = false;\n}\nmsg.payload = result;\nreturn msg;","outputs":1,"noerr":0,"x":857.1429176330566,"y":1507.1427869796753,"wires":[["4133a6ad.b402b8"]]},{"id":"80bd94ba.acd508","type":"template","z":"4836b9b7.e4bd18","name":"Power","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{ \"jsonrpc\": \"2.0\", \"id\": 1, \"method\": \"call\", \"params\": [ \"{{payload.result.1.ubus_rpc_session}}\", \"file\", \"read\", { \"path\": \"/tmp/power\" } ] }\n","x":273.33331298828125,"y":886.6666259765625,"wires":[["dc2df024.e8ba68"]]},{"id":"89896fb.728249","type":"debug","z":"4d31febf.b2ce","name":"","active":false,"console":"false","complete":"true","x":666.1666107177734,"y":3122.166437149048,"wires":[]},{"id":"fa8e2102.fefa2","type":"switch","z":"4836b9b7.e4bd18","name":"Device number gating","property":"req.query.device","propertyType":"msg","rules":[{"t":"btwn","v":"1","vt":"num","v2":"6","v2t":"num"},{"t":"else"}],"checkall":"false","outputs":2,"x":410.5,"y":435,"wires":[["1a0c25a5.00e7ba"],["30ba431c.9e3bec"]]},{"id":"30ba431c.9e3bec","type":"change","z":"4836b9b7.e4bd18","name":"Not handled","rules":[{"t":"set","p":"payload.result","pt":"msg","to":"0","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":887.857177734375,"y":755.7142333984375,"wires":[["b9db27d.64a8ed8"]]},{"id":"4bb04e35.c7c5","type":"http in","z":"30d36509.cf2c9a","name":"Home_Page","url":"/Home_Page","method":"get","x":138.57142639160156,"y":91.42857360839844,"wires":[["feacb41f.9695b8"]]},{"id":"feacb41f.9695b8","type":"template","z":"30d36509.cf2c9a","name":"","field":"payload","fieldType":"msg","syntax":"mustache","template":"<!DOCTYPE html> \n<html>\n<head>\n\t<title>Page Title</title>\n\t<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n\t<link rel=\"stylesheet\" href=\"http://code.jquery.com/mobile/1.4.0/jquery.mobile-1.4.0.min.css\" />\n<script src=\"http://code.jquery.com/jquery-1.9.1.min.js\"></script>\n<script src=\"http://code.jquery.com/mobile/1.4.0/jquery.mobile-1.4.0.min.js\"></script>\n</head>\n\n<body>\n<!-- Start of first page: #one -->\n<div data-role=\"page\" id=\"one\">\n\n\t<div data-role=\"header\">\n\t\t<h1>Multi-page</h1>\n\t</div><!-- /header -->\n\n\t<div role=\"main\" class=\"ui-content\" >\n\t\t<h2>One</h2>\n\n\t\t<p>I have an <code>id</code> of \"one\" on my page container. I'm first in the source order so I'm shown when the page loads.</p>\n\n\t\t<p>This is a multi-page boilerplate template that you can copy to build your first jQuery Mobile page. This template contains multiple \"page\" containers inside, unlike a single page template that has just one page within it.</p>\n\t\t<p>Just view the source and copy the code to get started. All the CSS and JS is linked to the jQuery CDN versions so this is super easy to set up. Remember to include a meta viewport tag in the head to set the zoom level.</p>\n\t\t<p>You link to internal pages by referring to the <code>id</code> of the page you want to show. For example, to <a href=\"#two\" >link</a> to the page with an <code>id</code> of \"two\", my link would have a <code>href=\"#two\"</code> in the code.</p>\n\n\t\t<h3>Show internal pages:</h3>\n\t\t<p><a href=\"#two\" class=\"ui-btn ui-shadow ui-corner-all\">Show page \"two\"</a></p>\n\t\t<p><a href=\"#popup\" class=\"ui-btn ui-shadow ui-corner-all\" data-rel=\"dialog\" data-transition=\"pop\">Show page \"popup\" (as a dialog)</a></p>\n\t</div><!-- /content -->\n\n\t<div data-role=\"footer\" data-theme=\"a\">\n\t\t<h4>Page Footer</h4>\n\t</div><!-- /footer -->\n</div><!-- /page one -->\n\n<!-- Start of second page: #two -->\n<div data-role=\"page\" id=\"two\" data-theme=\"a\">\n\n\t<div data-role=\"header\">\n\t\t<h1>Two</h1>\n\t</div><!-- /header -->\n\n\t<div role=\"main\" class=\"ui-content\">\n\t\t<h2>Two</h2>\n\t\t<p>I have an id of \"two\" on my page container. I'm the second page container in this multi-page template.</p>\n\t\t<p>Notice that the theme is different for this page because we've added a few <code>data-theme</code> swatch assigments here to show off how flexible it is. You can add any content or widget to these pages, but we're keeping these simple.</p>\n\t\t<p><a href=\"#one\" data-direction=\"reverse\" class=\"ui-btn ui-shadow ui-corner-all ui-btn-b\">Back to page \"one\"</a></p>\n\n\t</div><!-- /content -->\n\n\t<div data-role=\"footer\">\n\t\t<h4>Page Footer</h4>\n\t</div><!-- /footer -->\n</div><!-- /page two -->\n\n<!-- Start of third page: #popup -->\n<div data-role=\"page\" id=\"popup\">\n\n\t<div data-role=\"header\" data-theme=\"b\">\n\t\t<h1>Dialog</h1>\n\t</div><!-- /header -->\n\n\t<div role=\"main\" class=\"ui-content\">\n\t\t<h2>Popup</h2>\n\t\t<p>I have an id of \"popup\" on my page container and only look like a dialog because the link to me had a <code>data-rel=\"dialog\"</code> attribute which gives me this inset look and a <code>data-transition=\"pop\"</code> attribute to change the transition to pop. Without this, I'd be styled as a normal page.</p>\n\t\t<p><a href=\"#one\" data-rel=\"back\" class=\"ui-btn ui-shadow ui-corner-all ui-btn-inline ui-icon-back ui-btn-icon-left\">Back to page \"one\"</a></p>\n\t</div><!-- /content -->\n\n\t<div data-role=\"footer\">\n\t\t<h4>Page Footer</h4>\n\t</div><!-- /footer -->\n</div><!-- /page popup -->\n</body>\n\n\n\n\n\n</html>","x":379.57142639160156,"y":76.42857360839844,"wires":[["7a81107a.0c63f"]]},{"id":"7a81107a.0c63f","type":"http response","z":"30d36509.cf2c9a","name":"","x":584.5714263916016,"y":121.42857360839844,"wires":[]},{"id":"b6ee5995.928538","type":"function","z":"4836b9b7.e4bd18","name":"Validate return msg","func":"try {\n    var test = JSON.parse(msg.payload);\n} catch (e) {\n    msg.payload = \"0\";\n}\nreturn msg;","outputs":1,"noerr":0,"x":1144.5,"y":506,"wires":[["2ca36659.398dba"]]},{"id":"b7a69d0c.eccf2","type":"mqtt in","z":"30d36509.cf2c9a","name":"Living Room Motion","topic":"sensornet/env/home/living/motion","broker":"9eac092b.6153f8","x":170,"y":2227.142822265625,"wires":[["d37d12da.8bde2","7a276215.d8dcdc"]]},{"id":"d37d12da.8bde2","type":"change","z":"30d36509.cf2c9a","name":"Dining Room Floor Light On","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"name\": \"Dining room floorlight\", \"characteristic\": \"On\", \"value\": true}","tot":"json"},{"t":"set","p":"topic","pt":"msg","to":"setValue","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":486.42857360839844,"y":2228.571388244629,"wires":[["5581aadb.ec2f74"]]},{"id":"5581aadb.ec2f74","type":"debug","z":"30d36509.cf2c9a","name":"","active":false,"console":"false","complete":"false","x":812.1428571428571,"y":2307.142857142857,"wires":[]},{"id":"7a276215.d8dcdc","type":"debug","z":"30d36509.cf2c9a","name":"","active":false,"console":"false","complete":"false","x":446.4285714285714,"y":2301.428571428571,"wires":[]},{"id":"e118f4b5.acdaa8","type":"inject","z":"30d36509.cf2c9a","name":"Get HB Devices","topic":"get","payload":"{\"name\": \"all\"}","payloadType":"json","repeat":"","crontab":"","once":false,"x":183.57142857142856,"y":2467.142857142857,"wires":[[]]},{"id":"da06d0a0.55f0f","type":"inject","z":"30d36509.cf2c9a","name":"Add Light","topic":"remove","payload":"{ \"name\": \"Dining room floor light\" }","payloadType":"json","repeat":"","crontab":"","once":false,"x":154.99999999999997,"y":2522.8571428571427,"wires":[[]]},{"id":"cd27dac.245d828","type":"inject","z":"30d36509.cf2c9a","name":"Test","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":132.14285714285714,"y":2377.142857142857,"wires":[["d37d12da.8bde2"]]},{"id":"c5872bb6.b16a28","type":"template","z":"4d31febf.b2ce","name":"AQI","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{{payload.aqi}}","x":636.6666107177734,"y":3248.166437149048,"wires":[["413798bd.60ffe8","398eed1b.989352"]]},{"id":"413798bd.60ffe8","type":"mqtt out","z":"4d31febf.b2ce","name":"AQI for Displays","topic":"sensornet/env/home/balcony/aqi","qos":"2","retain":"true","broker":"9eac092b.6153f8","x":855.6666107177734,"y":3249.166437149048,"wires":[]},{"id":"9b51f2ed.43376","type":"template","z":"4d31febf.b2ce","name":"AQI","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{{payload.aqi}}","x":770,"y":3520,"wires":[["9a769f9b.1e909","ce33dce4.365ad"]]},{"id":"9a769f9b.1e909","type":"mqtt out","z":"4d31febf.b2ce","name":"AQI for Displays","topic":"sensornet/env/home/living/aqi","qos":"2","retain":"true","broker":"9eac092b.6153f8","x":1040,"y":3520,"wires":[]},{"id":"d4cefac0.3d1ce","type":"inject","z":"4d31febf.b2ce","name":"On","topic":"","payload":"on","payloadType":"string","repeat":"","crontab":"","once":false,"x":157,"y":201,"wires":[["ec4fd793.819fe8"]]},{"id":"ec4fd793.819fe8","type":"change","z":"4d31febf.b2ce","name":"Living Room Switch","rules":[{"t":"set","p":"deviceid","pt":"msg","to":"1605001","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":356.99998474121094,"y":259.5714168548584,"wires":[["4071e738.9dc26"]]},{"id":"4071e738.9dc26","type":"function","z":"4d31febf.b2ce","name":"Telldus ONOFF","func":"// Node-RED function to\n// a) list all Telldus devices (device = everything in Telldus Live except sensors)\n//\n// The code below relies on the following modules to be installed in the Node-RED environment, including being set up\n// in the functionGlobalContext section of the Node-RED settings.js config file (see last section of http://nodered.org/docs/writing-functions.html page)\n//\n// a) Telldus-Live module (https://github.com/TheThingSystem/node-telldus-live)\n//\n//\n// The function will fire one output message for each device it gets information about from Telldus Live.\n// By default the device id and name is included in the messages, but this can be customised as needed.\n//\n\n// Define Telldus Live API credentials\nvar publicKey    = 'FEHUVEW84RAFR5SP22RABURUPHAFRUNU',\n    privateKey   = 'ZUXEVEGA9USTAZEWRETHAQUBUR69U6EF',\n    token        = '13469c397c5216df6db311f991b09b3f055d36f2a',\n    tokenSecret  = '0b66cde0bc8c0afca00c56289b174cac',\n    cloud\n  ;\n\nvar mydevice = msg.deviceid;\nvar onP = (msg.payload==='on');\n\n// Create and log into new TelldusAPI object\ncloud = new context.global.telldusLive.TelldusAPI({ publicKey  : publicKey,\n    privateKey : privateKey });\n\ncloud.login(token, tokenSecret, function(err, user) {\n  if (!!err) return console.log('login error: ' + err.message);\n\n  // Get list of all devices. Use async call to avoid blocking\n  cloud.getDevices(function(err, devices) {\n    var f, i;\n\n    if (!!err) return console.log('getDevices: ' + err.message);\n\n\n    f = function(err, result) {\n      return function(err, result) {\n        if (!!err) return console.log('onOffDevices: ' + err.message);\n        node.send({payload:result});\n        return;\n      };\n    };\n\n    // Loop over all devices, asynchcronously get the data for each\n    for (i = 0; i < devices.length; i++) {\n      if (devices[i].type === 'device' && devices[i].id === mydevice) {\n        node.log('found device: '+i+' '+devices[i].id);\n        cloud.onOffDevice(devices[i], onP, f);\n      }\n    }\n  });\n}).on('error', function(err) {\n  console.log('background error: ' + err.message);\n});\n\n\nreturn;\n","outputs":1,"noerr":0,"x":622.7142791748047,"y":254.71429443359375,"wires":[["455d2f78.ff7c2"]]},{"id":"2fe0bba0.6ca5b4","type":"inject","z":"4d31febf.b2ce","name":"Off","topic":"","payload":"off","payloadType":"string","repeat":"","crontab":"","once":false,"x":150.7142791748047,"y":268.71429443359375,"wires":[["ec4fd793.819fe8"]]},{"id":"455d2f78.ff7c2","type":"debug","z":"4d31febf.b2ce","name":"Telldus-live status","active":false,"console":"false","complete":"payload","x":882.71435546875,"y":244.2857208251953,"wires":[]},{"id":"52c5bdf3.09455c","type":"comment","z":"4d31febf.b2ce","name":"Manual Control","info":"Turn on the lights manually.","x":178,"y":155,"wires":[]},{"id":"dc2df024.e8ba68","type":"template","z":"4836b9b7.e4bd18","name":"Set URL","field":"url","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"http://{{req.query.device}}/ubus","x":456,"y":834,"wires":[["a13bd957.121df8"]]},{"id":"a13bd957.121df8","type":"change","z":"4836b9b7.e4bd18","name":"Clear msg headers","rules":[{"t":"set","p":"headers","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":649.0475463867188,"y":834.9522705078125,"wires":[["54f799d6.7ac668"]]},{"id":"54f799d6.7ac668","type":"http request","z":"4836b9b7.e4bd18","name":"Send to Device","method":"POST","ret":"obj","url":"","tls":"","x":877.6664428710938,"y":827.6189575195312,"wires":[["b9db27d.64a8ed8"]]},{"id":"d0787879.82484","type":"debug","z":"4836b9b7.e4bd18","name":"","active":false,"console":"false","complete":"true","x":1261.5,"y":926,"wires":[]},{"id":"a22a7b8b.438d38","type":"switch","z":"4836b9b7.e4bd18","name":"Error handling","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":948,"y":543,"wires":[["b6ee5995.928538"],["30ba431c.9e3bec"]]},{"id":"e6832196.4e31b8","type":"mqtt in","z":"81fd7809.1072f","name":"Air Cleaner Set","topic":"sensornet/controllers/aircleaner/relay/set","qos":"0","broker":"9eac092b.6153f8","x":118,"y":230,"wires":[["8a02df07.db4118","d58706f5.79a93"]]},{"id":"8a02df07.db4118","type":"debug","z":"81fd7809.1072f","name":"","active":false,"console":"false","complete":"false","x":370.7142639160156,"y":145.28555297851562,"wires":[]},{"id":"500a5ad.4eadea4","type":"change","z":"81fd7809.1072f","name":"AirCleaner Plug","rules":[{"t":"set","p":"deviceid","pt":"msg","to":"1958268","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":560,"y":340,"wires":[["eb2a3641.e688"]]},{"id":"5e6b6d43.c7af34","type":"inject","z":"81fd7809.1072f","name":"On","topic":"","payload":"on","payloadType":"str","repeat":"","crontab":"","once":false,"x":130.00003051757812,"y":333.42858123779297,"wires":[["500a5ad.4eadea4"]]},{"id":"4fa8daa8.25ab8c","type":"inject","z":"81fd7809.1072f","name":"Off","topic":"","payload":"off","payloadType":"string","repeat":"","crontab":"","once":false,"x":127.71429443359375,"y":395.1428756713867,"wires":[["500a5ad.4eadea4"]]},{"id":"d58706f5.79a93","type":"change","z":"81fd7809.1072f","name":"BOOL to ONOFF","rules":[{"t":"change","p":"payload","pt":"msg","from":"true","fromt":"str","to":"on","tot":"str"},{"t":"change","p":"payload","pt":"msg","from":"false","fromt":"str","to":"off","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":369.5,"y":270,"wires":[["500a5ad.4eadea4"]]},{"id":"83da4f89.2d6e98","type":"mqtt in","z":"4836b9b7.e4bd18","name":"Air cleaner Set","topic":"sensornet/controllers/aircleaner/relay/set","qos":"0","broker":"9eac092b.6153f8","x":185,"y":1707,"wires":[["61d60881.8f7e2"]]},{"id":"61d60881.8f7e2","type":"debug","z":"4836b9b7.e4bd18","name":"","active":false,"console":"false","complete":"false","x":450.71427154541016,"y":1806.2855529785156,"wires":[]},{"id":"a25670a4.fc35d8","type":"switch","z":"4836b9b7.e4bd18","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"true","vt":"str"},{"t":"eq","v":"false","vt":"str"}],"checkall":"true","outputs":2,"x":422.7857142857142,"y":1697.2857142857142,"wires":[["f9186cd1.c7565"],["45dbad6.c9442d4"]]},{"id":"f9186cd1.c7565","type":"http request","z":"4836b9b7.e4bd18","name":"Switch On","method":"GET","ret":"obj","url":"http://10.0.1.253:1880/nodes/k2control?switch=Relay&action=write&device=1&state=on","tls":"","x":638.4999618530273,"y":1655.85715675354,"wires":[["8f36ca43.7089f8"]]},{"id":"45dbad6.c9442d4","type":"http request","z":"4836b9b7.e4bd18","name":"Switch Off","method":"GET","ret":"obj","url":"http://10.0.1.253:1880/nodes/k2control?switch=Relay&action=write&device=1&state=off","tls":"","x":642.071418762207,"y":1720.142939567566,"wires":[["f4f99a9.a0b9b68"]]},{"id":"8f36ca43.7089f8","type":"function","z":"4836b9b7.e4bd18","name":"Return ON","func":"var result = msg.payload.result;\nif (result == \"1\" || result == \"2\") {\n    result = true;\n} else {\n    result = false;\n}\nmsg.payload = result;\nreturn msg;","outputs":1,"noerr":0,"x":864.9999923706055,"y":1662.714241027832,"wires":[["61a5fdad.e7554c"]]},{"id":"f4f99a9.a0b9b68","type":"function","z":"4836b9b7.e4bd18","name":"Return OFF","func":"var result = msg.payload.result;\nif (result == \"1\" || result == \"2\") {\n    result = false;\n} else {\n    result = false;\n}\nmsg.payload = result;\nreturn msg;","outputs":1,"noerr":0,"x":862.1429100036621,"y":1722.7142057418823,"wires":[["61a5fdad.e7554c"]]},{"id":"61a5fdad.e7554c","type":"mqtt out","z":"4836b9b7.e4bd18","name":"Get status","topic":"sensornet/controllers/livingroom/relay/status","qos":"","retain":"","broker":"9eac092b.6153f8","x":1111.3571472167969,"y":1681.5714416503906,"wires":[]},{"id":"52fe083d.f30ca8","type":"mqtt out","z":"4d31febf.b2ce","name":"Air cleaner set","topic":"sensornet/controllers/aircleaner/relay/set","qos":"1","retain":"false","broker":"9eac092b.6153f8","x":1210.833423614502,"y":3790.333607673645,"wires":[]},{"id":"fb802a04.e273c","type":"change","z":"4d31febf.b2ce","name":"Yes","rules":[{"t":"set","p":"payload","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":999.8334159851074,"y":3749.3336057662964,"wires":[["52fe083d.f30ca8"]]},{"id":"1f15e5a4.1e196a","type":"change","z":"4d31febf.b2ce","name":"No","rules":[{"t":"set","p":"payload","pt":"msg","to":"false","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":997.8334808349609,"y":3851.333607673645,"wires":[["52fe083d.f30ca8"]]},{"id":"e1989473.bb96f8","type":"inject","z":"4d31febf.b2ce","name":"Dirty air","topic":"","payload":"80","payloadType":"num","repeat":"","crontab":"","once":false,"x":164.8333282470703,"y":3823.3336038589478,"wires":[["b9b562d6.0bb4e8"]]},{"id":"eb329c10.f85ae8","type":"inject","z":"4d31febf.b2ce","name":"Clean air","topic":"","payload":"40","payloadType":"num","repeat":"","crontab":"","once":false,"x":174.8333282470703,"y":3883.3336038589478,"wires":[["b9b562d6.0bb4e8"]]},{"id":"b9b562d6.0bb4e8","type":"function","z":"4d31febf.b2ce","name":"Force AQI","func":"var aqi = msg.payload;\nmsg.payload = {\"aqi\": aqi};\nreturn msg;","outputs":1,"noerr":0,"x":659.8333282470703,"y":3836.3336038589478,"wires":[["b631c0aa.0717e"]]},{"id":"ed9e0a60.0d19d8","type":"mqtt in","z":"81fd7809.1072f","name":"Dining Room Plug Set","topic":"sensornet/controllers/diningroomplug/relay/set","qos":"0","broker":"9eac092b.6153f8","x":127,"y":558,"wires":[["58ddbd21.96e3ac","c9671ed0.b658c"]]},{"id":"58ddbd21.96e3ac","type":"debug","z":"81fd7809.1072f","name":"","active":false,"console":"false","complete":"false","x":359.7142639160156,"y":473.2855529785156,"wires":[]},{"id":"c9671ed0.b658c","type":"change","z":"81fd7809.1072f","name":"BOOL to ONOFF","rules":[{"t":"change","p":"payload","pt":"msg","from":"true","fromt":"str","to":"on","tot":"str"},{"t":"change","p":"payload","pt":"msg","from":"false","fromt":"str","to":"off","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":358.5,"y":598,"wires":[["add132fd.0dff88"]]},{"id":"add132fd.0dff88","type":"change","z":"81fd7809.1072f","name":"Dining Room Plug","rules":[{"t":"set","p":"deviceid","pt":"msg","to":"1708606","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":548,"y":661,"wires":[["d543d877.cc8c"]]},{"id":"a9d075b0.1f15d8","type":"inject","z":"81fd7809.1072f","name":"On","topic":"","payload":"on","payloadType":"str","repeat":"","crontab":"","once":false,"x":119.00003051757812,"y":661.428581237793,"wires":[["add132fd.0dff88"]]},{"id":"8e470590.e1818","type":"inject","z":"81fd7809.1072f","name":"Off","topic":"","payload":"off","payloadType":"string","repeat":"","crontab":"","once":false,"x":116.71429443359375,"y":723.1428756713867,"wires":[["add132fd.0dff88"]]},{"id":"13b06b97.3d0794","type":"inject","z":"cb0fb263.d8ff4","name":"Short Date-time","topic":"sensornet/time/shortdatetime","payload":"","payloadType":"date","repeat":"60","crontab":"","once":true,"x":153,"y":90,"wires":[["759701d2.99212"]]},{"id":"759701d2.99212","type":"function","z":"cb0fb263.d8ff4","name":"Get Short Date-time","func":"var d = new Date(),\n    minutes = d.getMinutes().toString().length == 1 ? '0'+d.getMinutes() : d.getMinutes(),\n    hours = d.getHours().toString().length == 1 ? '0'+d.getHours() : d.getHours(),\n    ampm = d.getHours() >= 12 ? 'pm' : 'am',\n    months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],\n    days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];\nmsg.payload =  days[d.getDay()]+'  '+months[d.getMonth()]+'  '+d.getDate()+'   '+hours+':'+minutes;\nreturn msg;\n","outputs":1,"noerr":0,"x":433.5,"y":89,"wires":[["1db99eb4.2a0381"]]},{"id":"1db99eb4.2a0381","type":"mqtt out","z":"cb0fb263.d8ff4","name":"Short Date-time","topic":"","qos":"0","retain":"false","broker":"9eac092b.6153f8","x":667,"y":85,"wires":[]},{"id":"fd8181be.577ad","type":"inject","z":"cb0fb263.d8ff4","name":"Short Date","topic":"sensornet/time/shortdate","payload":"","payloadType":"date","repeat":"3600","crontab":"","once":true,"x":133,"y":152,"wires":[["2ab47995.3dcde6"]]},{"id":"2ab47995.3dcde6","type":"function","z":"cb0fb263.d8ff4","name":"Get Short Date","func":"var d = new Date(),\n    minutes = d.getMinutes().toString().length == 1 ? '0'+d.getMinutes() : d.getMinutes(),\n    hours = d.getHours().toString().length == 1 ? '0'+d.getHours() : d.getHours(),\n    ampm = d.getHours() >= 12 ? 'pm' : 'am',\n    months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],\n    days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];\nmsg.payload = months[d.getMonth()]+' '+d.getDate();\nreturn msg;\n","outputs":1,"noerr":0,"x":413.5,"y":151,"wires":[["c3115944.204738"]]},{"id":"c3115944.204738","type":"mqtt out","z":"cb0fb263.d8ff4","name":"Short Date","topic":"","qos":"0","retain":"false","broker":"9eac092b.6153f8","x":657,"y":147,"wires":[]},{"id":"69b626b5.085188","type":"inject","z":"cb0fb263.d8ff4","name":"Short Time","topic":"sensornet/time/shorttime","payload":"","payloadType":"date","repeat":"60","crontab":"","once":true,"x":135,"y":217,"wires":[["45b3eae9.44ace4"]]},{"id":"45b3eae9.44ace4","type":"function","z":"cb0fb263.d8ff4","name":"Get Short Time","func":"var d = new Date(),\n    minutes = d.getMinutes().toString().length == 1 ? '0'+d.getMinutes() : d.getMinutes(),\n    hours = d.getHours().toString().length == 1 ? '0'+d.getHours() : d.getHours(),\n    ampm = d.getHours() >= 12 ? 'pm' : 'am',\n    months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],\n    days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];\nmsg.payload =  hours+':'+minutes;\nreturn msg;\n","outputs":1,"noerr":0,"x":415.5,"y":216,"wires":[["b27bdd53.de758"]]},{"id":"b27bdd53.de758","type":"mqtt out","z":"cb0fb263.d8ff4","name":"Short Time","topic":"","qos":"0","retain":"false","broker":"9eac092b.6153f8","x":659,"y":212,"wires":[]},{"id":"54db27f3.070448","type":"inject","z":"cb0fb263.d8ff4","name":"UNIX Time","topic":"sensornet/time/timestamp","payload":"","payloadType":"date","repeat":"30","crontab":"","once":true,"x":134,"y":285,"wires":[["aceec617.e07668","25e563a7.be384c"]]},{"id":"aceec617.e07668","type":"mqtt out","z":"cb0fb263.d8ff4","name":"","topic":"","qos":"0","retain":"false","broker":"9eac092b.6153f8","x":678.5,"y":278,"wires":[]},{"id":"25e563a7.be384c","type":"debug","z":"cb0fb263.d8ff4","name":"","active":false,"console":"false","complete":"false","x":116.5,"y":357,"wires":[]},{"id":"a5030afa.6eab58","type":"comment","z":"cb0fb263.d8ff4","name":"Date-Time","info":"## Date-Time service\n*Provide varieties of date-time services to MQTT subs*\n\nThese are glabal services that provide date and time information to MQTT subscribers.\n","x":121.5,"y":32,"wires":[]},{"id":"63da4cd3.951504","type":"mqtt out","z":"4d31febf.b2ce","name":"SH MQTT","topic":"sensornet/aqi/AQI02/allvalues","qos":"1","retain":"true","broker":"9eac092b.6153f8","x":1020,"y":3660,"wires":[]},{"id":"4bde8cc9.6cd004","type":"mqtt out","z":"4d31febf.b2ce","name":"252 Forwarder","topic":"sensornet/env/home/living/temperature","qos":"2","retain":"true","broker":"8daacbf2.827ed8","x":638.5,"y":676,"wires":[]},{"id":"3d5d0f7a.d1524","type":"mqtt out","z":"4d31febf.b2ce","name":"252 Forwarder","topic":"sensornet/env/home/living/humidity","qos":"2","retain":"true","broker":"8daacbf2.827ed8","x":639,"y":727,"wires":[]},{"id":"ce33dce4.365ad","type":"mqtt out","z":"4d31febf.b2ce","name":"AQI for Displays","topic":"sensornet/env/home/living/aqi","qos":"2","retain":"true","broker":"8daacbf2.827ed8","x":1040,"y":3460,"wires":[]},{"id":"398eed1b.989352","type":"mqtt out","z":"4d31febf.b2ce","name":"AQI for Displays","topic":"sensornet/env/home/balcony/aqi","qos":"2","retain":"true","broker":"8daacbf2.827ed8","x":854.1666107177734,"y":3300.166437149048,"wires":[]},{"id":"d7e40c06.96faf","type":"mqtt out","z":"4d31febf.b2ce","name":"252 Forwarder","topic":"sensornet/env/home/balcony/temperature","qos":"2","retain":"true","broker":"8daacbf2.827ed8","x":360,"y":1940,"wires":[]},{"id":"d05786cd.3f2768","type":"mqtt out","z":"4d31febf.b2ce","name":"252 Forwarder","topic":"sensornet/env/home/balcony/humidity","qos":"2","retain":"true","broker":"8daacbf2.827ed8","x":360,"y":2180,"wires":[]},{"id":"8d7fadef.944fa","type":"comment","z":"4836b9b7.e4bd18","name":"KK for air cleaner replaced by Telldus plug 1708657","info":"","x":282.5,"y":1653,"wires":[]},{"id":"8b2b3f80.0cd85","type":"http request","z":"4d31febf.b2ce","name":"Toilet Light On","method":"GET","ret":"txt","url":"http://10.0.1.253:1880/nodes/k2control?switch=USB&action=write&device=5&state=on","tls":"","x":1231.0000457763672,"y":2202.0835514068604,"wires":[["c3bdf22f.0ee0d"]]},{"id":"ac694844.f8b638","type":"switch","z":"4d31febf.b2ce","name":"","property":"payload","propertyType":"msg","rules":[{"t":"lt","v":"30","vt":"num"},{"t":"gte","v":"30","vt":"num"}],"checkall":"true","outputs":2,"x":1030,"y":2240,"wires":[["8b2b3f80.0cd85"],["5144666b.c58b58"]]},{"id":"c3bdf22f.0ee0d","type":"debug","z":"4d31febf.b2ce","name":"","active":false,"console":"false","complete":"false","x":1438.3333358764648,"y":2240.000155131022,"wires":[]},{"id":"5144666b.c58b58","type":"http request","z":"4d31febf.b2ce","name":"Toilet Light OFF","method":"GET","ret":"txt","url":"http://10.0.1.253:1880/nodes/k2control?switch=USB&action=write&device=5&state=off","tls":"","x":1233.3333358764648,"y":2274.9999923706055,"wires":[["c3bdf22f.0ee0d"]]},{"id":"eb2a3641.e688","type":"telldus-device","z":"81fd7809.1072f","gateway":"1ee64e7d.ebc352","localId":"4","name":"AirCleaner_Fibaro","active":true,"x":810,"y":340,"wires":[]},{"id":"d543d877.cc8c","type":"telldus-device","z":"81fd7809.1072f","gateway":"1ee64e7d.ebc352","localId":"12","name":"DiningLight_LDS-02","active":true,"x":820,"y":660,"wires":[]},{"id":"ab095604.329068","type":"inject","z":"22752fb7.ea4aa","name":"Periodic 5m","topic":"2a6e,2a6f,2a6d","payload":"{}","payloadType":"json","repeat":"300","crontab":"","once":false,"onceDelay":"0","x":120,"y":340,"wires":[["fa87d5c2.922f88","8518981e.e51168"]]},{"id":"2c6a4dd1.6a6762","type":"debug","z":"22752fb7.ea4aa","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1310,"y":560,"wires":[]},{"id":"d22a0a8.80aaef8","type":"function","z":"22752fb7.ea4aa","name":"Temperature","func":"var a = msg.payload.characteristics[\"2a6e\"];\nmsg.payload = (a[0]+a[1]*256)/100;\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":260,"wires":[["58b3a8d7.cb1938","2c6a4dd1.6a6762"]]},{"id":"58b3a8d7.cb1938","type":"mqtt out","z":"22752fb7.ea4aa","name":"Master Bedroom temp","topic":"sensornet/env/home/masterbed/temperature","qos":"2","retain":"true","broker":"9eac092b.6153f8","x":920,"y":260,"wires":[]},{"id":"5fb0cdfd.434774","type":"function","z":"22752fb7.ea4aa","name":"Humidity","func":"var a = msg.payload.characteristics[\"2a6f\"];\nmsg.payload = (a[0]+a[1]*256)/100;\nreturn msg;","outputs":1,"noerr":0,"x":680,"y":320,"wires":[["d4d34993.a9e398","2c6a4dd1.6a6762"]]},{"id":"d4d34993.a9e398","type":"mqtt out","z":"22752fb7.ea4aa","name":"Master Bedroom humi","topic":"sensornet/env/home/masterbed/humidity","qos":"2","retain":"true","broker":"9eac092b.6153f8","x":920,"y":340,"wires":[]},{"id":"b78fbe9d.6b25e","type":"mqtt out","z":"22752fb7.ea4aa","name":"LivingRoom temp","topic":"sensornet/env/home/living/temperature","qos":"2","retain":"true","broker":"9eac092b.6153f8","x":910,"y":440,"wires":[]},{"id":"cdd4e3ec.8400a","type":"mqtt out","z":"22752fb7.ea4aa","name":"LivingRoom humi","topic":"sensornet/env/home/living/humidity","qos":"2","retain":"true","broker":"9eac092b.6153f8","x":910,"y":520,"wires":[]},{"id":"80eede44.10e6d","type":"mqtt out","z":"22752fb7.ea4aa","name":"Balcony temp","topic":"sensornet/env/home/balcony/temperature","qos":"2","retain":"true","broker":"9eac092b.6153f8","x":900,"y":640,"wires":[]},{"id":"9e5b40ba.44707","type":"mqtt out","z":"22752fb7.ea4aa","name":"Balcony humidity","topic":"sensornet/env/home/balcony/humidity","qos":"2","retain":"true","broker":"9eac092b.6153f8","x":910,"y":720,"wires":[]},{"id":"9ef24578.3dd118","type":"debug","z":"22752fb7.ea4aa","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":490,"y":200,"wires":[]},{"id":"2772d442.81494c","type":"debug","z":"22752fb7.ea4aa","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1150,"y":1420,"wires":[]},{"id":"e2a043f6.ccdde","type":"template","z":"22752fb7.ea4aa","name":"Temp","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"EnvMulti Temp: {{payload}}","output":"str","x":870,"y":860,"wires":[["2772d442.81494c"]]},{"id":"ada8bd5e.3e07e","type":"template","z":"22752fb7.ea4aa","name":"Lux","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"EnvMulti Lux: {{payload}}","output":"str","x":870,"y":1040,"wires":[["2772d442.81494c"]]},{"id":"caf7bd14.d195a","type":"template","z":"22752fb7.ea4aa","name":"UVA","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"EnvMulti UVA: {{payload}}","output":"str","x":870,"y":1120,"wires":[["2772d442.81494c"]]},{"id":"9f758d55.3d623","type":"template","z":"22752fb7.ea4aa","name":"UVB","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"EnvMulti UVB: {{payload}}","output":"str","x":870,"y":1180,"wires":[["2772d442.81494c"]]},{"id":"cab24697.7a6a38","type":"template","z":"22752fb7.ea4aa","name":"UVI","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"EnvMulti UVI: {{payload}}","output":"str","x":870,"y":1240,"wires":[["2772d442.81494c"]]},{"id":"dca84c6f.76845","type":"template","z":"22752fb7.ea4aa","name":"Visible","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"EnvMulti Visible: {{payload}}","output":"str","x":870,"y":1300,"wires":[["2772d442.81494c"]]},{"id":"aba6092a.e13028","type":"template","z":"22752fb7.ea4aa","name":"IR","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"EnvMulti IR: {{payload}}","output":"str","x":870,"y":1360,"wires":[["2772d442.81494c"]]},{"id":"91f6a4cd.1c5988","type":"template","z":"22752fb7.ea4aa","name":"Pressure","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"EnvMulti Pressure: {{payload}}","output":"str","x":880,"y":920,"wires":[["2772d442.81494c"]]},{"id":"f3c1541a.d6a9e8","type":"function","z":"22752fb7.ea4aa","name":"UVA","func":"var a = msg.payload.characteristics[\"815b\"];\nmsg.payload = (a[0]+a[1]*256);\nreturn msg;","outputs":1,"noerr":0,"x":670,"y":1100,"wires":[["caf7bd14.d195a","f7f7bcc4.a4f2b"]]},{"id":"dd6beffa.bb5a","type":"function","z":"22752fb7.ea4aa","name":"UVB","func":"var a = msg.payload.characteristics[\"815c\"];\nmsg.payload = (a[0]+a[1]*256);\nreturn msg;","outputs":1,"noerr":0,"x":670,"y":1160,"wires":[["9f758d55.3d623","2b3c9adf.3a9ea6"]]},{"id":"4a1dd865.0aea48","type":"function","z":"22752fb7.ea4aa","name":"UVI","func":"var a = msg.payload.characteristics[\"2a76\"];\nmsg.payload = (a[0]+a[1]*256);\nreturn msg;","outputs":1,"noerr":0,"x":670,"y":1220,"wires":[["cab24697.7a6a38","e68a152f.1ce518"]]},{"id":"18e88c4b.e328e4","type":"function","z":"22752fb7.ea4aa","name":"Visible","func":"var a = msg.payload.characteristics[\"815d\"];\nmsg.payload = (a[0]+a[1]*256);\nreturn msg;","outputs":1,"noerr":0,"x":670,"y":1280,"wires":[["dca84c6f.76845","c449f19b.1ec9c"]]},{"id":"353276e2.13a02a","type":"function","z":"22752fb7.ea4aa","name":"IR","func":"var a = msg.payload.characteristics[\"815e\"];\nmsg.payload = (a[0]+a[1]*256);\nreturn msg;","outputs":1,"noerr":0,"x":670,"y":1340,"wires":[["aba6092a.e13028","8ec82c60.c364b"]]},{"id":"186875c7.a4645a","type":"function","z":"22752fb7.ea4aa","name":"Visible","func":"if (msg.payload.characteristics[\"815d\"]!==undefined) {\n    var a = msg.payload.characteristics[\"815d\"];\n    msg.payload = (a[0]+a[1]*256);\n    return msg;\n}","outputs":1,"noerr":0,"x":670,"y":1580,"wires":[["6e04d7b.64a3028"]]},{"id":"2bb0bb3.8a8f944","type":"function","z":"22752fb7.ea4aa","name":"Pressure","func":"var a = msg.payload.characteristics[\"2a6d\"];\nmsg.payload = (a[0]+a[1]*256);\nreturn msg;","outputs":1,"noerr":0,"x":680,"y":380,"wires":[["2c6a4dd1.6a6762"]]},{"id":"a3acb65d.985ab8","type":"mqtt out","z":"22752fb7.ea4aa","name":"Livingroom bright","topic":"sensornet/env/home/living/brightness","qos":"1","retain":"true","broker":"9eac092b.6153f8","x":1110,"y":1700,"wires":[]},{"id":"59e102bc.62872c","type":"mqtt out","z":"22752fb7.ea4aa","name":"Balcony bright","topic":"sensornet/env/home/balcony/brightness","qos":"1","retain":"true","broker":"9eac092b.6153f8","x":1160,"y":1020,"wires":[]},{"id":"fa87d5c2.922f88","type":"Generic BLE in","z":"22752fb7.ea4aa","name":"Bedroom TH","genericBle":"d00e3d6.43749c","useString":false,"notification":false,"x":370,"y":300,"wires":[["9ef24578.3dd118","d22a0a8.80aaef8","5fb0cdfd.434774","2bb0bb3.8a8f944"]]},{"id":"9ad9c4ab.965a08","type":"function","z":"22752fb7.ea4aa","name":"Temperature","func":"var a = msg.payload.characteristics[\"2a6e\"];\nmsg.payload = (a[0]+a[1]*256)/100;\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":440,"wires":[["b78fbe9d.6b25e"]]},{"id":"4b8469ba.d5a318","type":"function","z":"22752fb7.ea4aa","name":"Humidity","func":"var a = msg.payload.characteristics[\"2a6f\"];\nmsg.payload = (a[0]+a[1]*256)/100;\nreturn msg;","outputs":1,"noerr":0,"x":680,"y":500,"wires":[["cdd4e3ec.8400a"]]},{"id":"61dd3c66.155ab4","type":"function","z":"22752fb7.ea4aa","name":"Pressure","func":"var a = msg.payload.characteristics[\"2a6d\"];\nmsg.payload = (a[0]+a[1]*256);\nreturn msg;","outputs":1,"noerr":0,"x":680,"y":560,"wires":[["2c6a4dd1.6a6762"]]},{"id":"fd6ff25a.d696","type":"Generic BLE in","z":"22752fb7.ea4aa","name":"Livingroom TH","genericBle":"84828a17.51b738","useString":false,"notification":false,"x":380,"y":480,"wires":[["9ad9c4ab.965a08","4b8469ba.d5a318","61dd3c66.155ab4","ccef957e.8ed568"]]},{"id":"5efd5cb8.dad394","type":"function","z":"22752fb7.ea4aa","name":"Temperature","func":"var a = msg.payload.characteristics[\"2a6e\"];\nmsg.payload = (a[0]+a[1]*256)/100;\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":640,"wires":[["80eede44.10e6d"]]},{"id":"a599207.14845e","type":"function","z":"22752fb7.ea4aa","name":"Humidity","func":"var a = msg.payload.characteristics[\"2a6f\"];\nmsg.payload = (a[0]+a[1]*256)/100;\nreturn msg;","outputs":1,"noerr":0,"x":680,"y":700,"wires":[["9e5b40ba.44707"]]},{"id":"a49f4a15.894698","type":"function","z":"22752fb7.ea4aa","name":"Pressure","func":"var a = msg.payload.characteristics[\"2a6d\"];\nmsg.payload = (a[0]+a[1]*256);\nreturn msg;","outputs":1,"noerr":0,"x":680,"y":760,"wires":[["2c6a4dd1.6a6762"]]},{"id":"cd919c76.a854b","type":"Generic BLE in","z":"22752fb7.ea4aa","name":"Balcony TH","genericBle":"b225f3c1.61ec1","useString":false,"notification":false,"x":370,"y":680,"wires":[["5efd5cb8.dad394","a599207.14845e","a49f4a15.894698","984998f6.19ec28"]]},{"id":"8db7fc1b.09092","type":"function","z":"22752fb7.ea4aa","name":"Temperature","func":"var a = msg.payload.characteristics[\"2a6e\"];\nmsg.payload = (a[0]+a[1]*256)/100;\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":840,"wires":[["e2a043f6.ccdde","510a345a.300ffc"]]},{"id":"66d5ae74.f18a5","type":"function","z":"22752fb7.ea4aa","name":"Lux","func":"var a = msg.payload.characteristics[\"2a77\"];\nmsg.payload = (a[0]+a[1]*256)/100;\nreturn msg;","outputs":1,"noerr":0,"x":670,"y":1020,"wires":[["ada8bd5e.3e07e","bcccdcba.0d3a1","59e102bc.62872c"]]},{"id":"530bbf9a.ee88a","type":"function","z":"22752fb7.ea4aa","name":"Pressure","func":"var a = msg.payload.characteristics[\"2a6d\"];\nmsg.payload = (a[0]+a[1]*256);\nreturn msg;","outputs":1,"noerr":0,"x":680,"y":900,"wires":[["91f6a4cd.1c5988","eae07d3a.90ed4"]]},{"id":"b482b76c.660748","type":"Generic BLE in","z":"22752fb7.ea4aa","name":"UV","genericBle":"daa86108.dbba4","useString":false,"notification":false,"x":350,"y":1100,"wires":[["8db7fc1b.09092","66d5ae74.f18a5","530bbf9a.ee88a","f3c1541a.d6a9e8","dd6beffa.bb5a","4a1dd865.0aea48","18e88c4b.e328e4","353276e2.13a02a","792d812f.18151"]]},{"id":"842be5d6.aa1248","type":"function","z":"22752fb7.ea4aa","name":"IR","func":"if (msg.payload.characteristics[\"815e\"] !== undefined) {\n    var a = msg.payload.characteristics[\"815e\"];\n    msg.payload = (a[0]+a[1]*256);\n    return msg;\n}","outputs":1,"noerr":0,"x":670,"y":1640,"wires":[["3765bf8d.1ec26"]]},{"id":"7d8be84b.e49d18","type":"function","z":"22752fb7.ea4aa","name":"Lux","func":"if (msg.payload.characteristics[\"2a77\"] !== undefined) {\n    var a = msg.payload.characteristics[\"2a77\"];\n    msg.payload = (a[0]+a[1]*256)/100;\n    return msg;\n}\n","outputs":1,"noerr":0,"x":670,"y":1700,"wires":[["a3acb65d.985ab8"]]},{"id":"bd3b8c0b.99aea","type":"function","z":"22752fb7.ea4aa","name":"Temperature","func":"if (msg.payload.characteristics[\"2a6e\"] !== undefined) {\n    var a = msg.payload.characteristics[\"2a6e\"];\n    msg.payload = (a[0]+a[1]*256)/100;\n    return msg;\n}\n","outputs":1,"noerr":0,"x":690,"y":1760,"wires":[[]]},{"id":"d3e63f09.50fb8","type":"function","z":"22752fb7.ea4aa","name":"Pressure","func":"if (msg.payload.characteristics[\"2a6d\"] !== undefined) {\n    var a = msg.payload.characteristics[\"2a6d\"];\n    msg.payload = (a[0]+a[1]*256);\n    return msg;\n}","outputs":1,"noerr":0,"x":680,"y":1820,"wires":[[]]},{"id":"ccef957e.8ed568","type":"debug","z":"22752fb7.ea4aa","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":490,"y":400,"wires":[]},{"id":"984998f6.19ec28","type":"debug","z":"22752fb7.ea4aa","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":490,"y":580,"wires":[]},{"id":"792d812f.18151","type":"debug","z":"22752fb7.ea4aa","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":540,"y":1460,"wires":[]},{"id":"c66caa7.8856158","type":"debug","z":"22752fb7.ea4aa","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":540,"y":1980,"wires":[]},{"id":"1069a049.08d67","type":"inject","z":"22752fb7.ea4aa","name":"Manual","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":130,"y":940,"wires":[["b482b76c.660748"]]},{"id":"93d7e4f8.5bfcf8","type":"http in","z":"14e9f5d5.1d23fa","name":"/env","url":"/env","method":"get","swaggerDoc":"","x":170,"y":440,"wires":[["6613a8f9.d6d5e8"]]},{"id":"6613a8f9.d6d5e8","type":"function","z":"14e9f5d5.1d23fa","name":"Latest Temperature","func":"var qtime = new Date()\nqtime = qtime - 30*60*1000\nvar query = {}\nquery[\"topic\"] = /\\/temperature$/i\nquery[\"dtime\"] = {\"$gt\": qtime}\nvar proj = {topic:1,payload:1,dtime:1,_id:0}\nmsg.projection = proj\nmsg.payload = query\nmsg.limit=1\nmsg.skip=0\nmsg.sort={dtime:-1}\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":440,"wires":[["b5c5afcf.c745a"]]},{"id":"b5c5afcf.c745a","type":"mongodb in","z":"14e9f5d5.1d23fa","mongodb":"d3cae7a7.2c3518","name":"Lookup DB","collection":"environment","operation":"find","x":610,"y":440,"wires":[["6ede17b8.743058"]]},{"id":"6ede17b8.743058","type":"function","z":"14e9f5d5.1d23fa","name":"First element","func":"msg.payload=msg.payload[0]\nreturn msg;","outputs":1,"noerr":0,"x":790,"y":440,"wires":[["73fc5081.5b1af"]]},{"id":"73fc5081.5b1af","type":"template","z":"14e9f5d5.1d23fa","name":"HTML","field":"payload","format":"html","template":"<!DOCTYPE html>\n<html>\n<body>\n\n<p id=\"p1\">Current temperature is {{payload.payload}}</p>\n<p id=\"p2\">Topic is {{payload.topic}}</p>\n<p id=\"p0\">Last update: <span id=\"p3\">datetime</span></p>\n\n<script>\nvar dt = new Date({{payload.dtime}})\ndocument.getElementById(\"p3\").innerHTML = dt.toString();\n</script>\n\n</body>\n</html> ","x":950,"y":440,"wires":[["3f2d1378.54706c","1c5c626a.b78e6e"]]},{"id":"3f2d1378.54706c","type":"http response","z":"14e9f5d5.1d23fa","name":"/env","x":1170,"y":440,"wires":[]},{"id":"1c5c626a.b78e6e","type":"debug","z":"14e9f5d5.1d23fa","name":"","active":false,"console":"false","complete":"payload","x":1430,"y":480,"wires":[]},{"id":"d41017ed.8460b8","type":"http in","z":"14e9f5d5.1d23fa","name":"/sense2","url":"/sense2","method":"get","swaggerDoc":"","x":170,"y":760,"wires":[["baea26c7.8fea88"]]},{"id":"baea26c7.8fea88","type":"function","z":"14e9f5d5.1d23fa","name":"AQI Temperature","func":"var qtime = new Date()\nqtime = qtime - 30*60*1000\nvar query = {}\nquery[\"topic\"] = /\\/aqi\\/AQI01\\/allvalues$/i\nquery[\"dtime\"] = {\"$gt\": qtime}\nvar proj = {topic:1,payload:1,dtime:1,_id:0}\nmsg.projection = proj\nmsg.payload = query\nmsg.limit=1\nmsg.skip=0\nmsg.sort={dtime:-1}\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":660,"wires":[["a3dd3178.22721"]]},{"id":"a3dd3178.22721","type":"mongodb in","z":"14e9f5d5.1d23fa","mongodb":"d3cae7a7.2c3518","name":"Lookup DB","collection":"environment","operation":"find","x":730,"y":660,"wires":[["39c9d4e3.55997c"]]},{"id":"39c9d4e3.55997c","type":"function","z":"14e9f5d5.1d23fa","name":"First element","func":"var val = msg.payload;\nif (val) {\n    if (val.length > 0) {\n        val=val[0];\n        msg.payload=val;\n    }\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":910,"y":660,"wires":[["d118c492.bf08b8"]]},{"id":"d118c492.bf08b8","type":"function","z":"14e9f5d5.1d23fa","name":"Set context vars","func":"if (msg.payload.dtime > context.global.aqiTLastUpdate)\n    context.global.aqiTLastUpdate = msg.payload.dtime;\nmsg.payload = msg.payload.payload;\nif (msg.payload !== undefined) {\n    context.global.aqitemp = msg.payload.temperature;\n    context.global.aqihumi = msg.payload.humidity;\n}\nreturn msg;","outputs":1,"noerr":0,"x":1100,"y":660,"wires":[["dcd83667.e36478"]]},{"id":"dcd83667.e36478","type":"function","z":"14e9f5d5.1d23fa","name":"AQI All","func":"var qtime = new Date()\nqtime = qtime - 60*60*1000\nvar query = {}\nquery[\"topic\"] = /\\/aqi\\/AQI01\\/allvalues$/i\nquery[\"dtime\"] = {\"$gt\": qtime}\nvar proj = {topic:1,payload:1,dtime:1,_id:0}\nmsg.projection = proj\nmsg.payload = query\nmsg.limit=1\nmsg.skip=0\nmsg.sort={dtime:-1}\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":720,"wires":[["615f40a5.837d2"]]},{"id":"615f40a5.837d2","type":"mongodb in","z":"14e9f5d5.1d23fa","mongodb":"d3cae7a7.2c3518","name":"Lookup DB","collection":"environment","operation":"find","x":730,"y":720,"wires":[["51693372.a6a12c"]]},{"id":"51693372.a6a12c","type":"function","z":"14e9f5d5.1d23fa","name":"First element","func":"var val = msg.payload;\nif (val) {\n    if (val.length > 0) {\n        val=val[0];\n        msg.payload=val;\n    }\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":910,"y":720,"wires":[["9d09c30a.ff3ea"]]},{"id":"9d09c30a.ff3ea","type":"function","z":"14e9f5d5.1d23fa","name":"Set context vars","func":"if (msg.payload.dtime > context.global.aqiALastUpdate)\n    context.global.aqiALastUpdate = msg.payload.dtime;\nmsg.payload = msg.payload.payload;\nif (msg.payload !== undefined) {\n    context.global.aqipm25 = msg.payload.pm25;\n    context.global.aqiaqi = msg.payload.aqi;\n}\nreturn msg;","outputs":1,"noerr":0,"x":1100,"y":720,"wires":[["256a974.5f13f68"]]},{"id":"256a974.5f13f68","type":"function","z":"14e9f5d5.1d23fa","name":"AQI02 All","func":"var qtime = new Date()\nqtime = qtime - 30*60*1000\nvar query = {}\nquery[\"topic\"] = /\\/aqi\\/AQI02\\/allvalues$/i\nquery[\"dtime\"] = {\"$gt\": qtime}\nvar proj = {topic:1,payload:1,dtime:1,_id:0}\nmsg.projection = proj\nmsg.payload = query\nmsg.limit=10\nmsg.skip=0\nmsg.sort={dtime:-1}\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":780,"wires":[["931a77b2.7f4bc8"]]},{"id":"931a77b2.7f4bc8","type":"mongodb in","z":"14e9f5d5.1d23fa","mongodb":"d3cae7a7.2c3518","name":"Lookup DB","collection":"environment","operation":"find","x":730,"y":780,"wires":[["89743c10.6c2fe"]]},{"id":"89743c10.6c2fe","type":"function","z":"14e9f5d5.1d23fa","name":"Average over","func":"var val = msg.payload;\nvar tval;\nvar skip=4; // skip the first 4 early samples\nif (val) {\n    var count = val.length;\n    var i = 0;\n    var pm25 = 0, aqi = 0, tp =0, hm = 0;\n    if (count > 0) {\n        for (i=skip; i < count; i++) {\n            tval=val[i];\n            pm25+=tval.payload.pm25;\n            aqi+=tval.payload.aqi;\n            dtime = tval.dtime;\n        }\n        pm25 = pm25/(i-skip);\n        aqi = aqi/(i-skip);\n//        msg.payload = \"{\\\"pm25\\\":\"+pm25+\",\\\"aqi\\\":\"+aqi+\"}\";\n        msg.payload = { \"pm25\": pm25,\n                        \"aqi\" : aqi,\n                        \"temperature\": tp,\n                        \"humidity\" : hm,\n                        \"dtime\": dtime}\n    }\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":910,"y":780,"wires":[["94ab44cc.37ba58"]]},{"id":"94ab44cc.37ba58","type":"function","z":"14e9f5d5.1d23fa","name":"Set context vars","func":"if (msg.payload !== undefined) {\n    if (msg.payload.dtime > context.global.aqi02ALastUpdate) {\n        context.global.aqi02ALastUpdate = msg.payload.dtime;\n    }\n    context.global.aqi02pm25 = msg.payload.pm25;\n    context.global.aqi02aqi = msg.payload.aqi;\n    context.global.aqi02temp = msg.payload.temperature;\n    context.global.aqi02humi = msg.payload.humidity;\n}\nreturn msg;","outputs":1,"noerr":0,"x":1100,"y":780,"wires":[["c7129273.d4399"]]},{"id":"c7129273.d4399","type":"function","z":"14e9f5d5.1d23fa","name":"Master BedRoom Temperature","func":"var qtime = new Date()\nqtime = qtime - 30*60*1000\nvar query = {}\nquery[\"topic\"] = /\\/masterbed\\/temperature$/i\nquery[\"dtime\"] = {\"$gt\": qtime}\nvar proj = {topic:1,payload:1,dtime:1,_id:0}\nmsg.projection = proj\nmsg.payload = query\nmsg.limit=1\nmsg.skip=0\nmsg.sort={dtime:-1}\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":840,"wires":[["9db36ed9.36766"]]},{"id":"9db36ed9.36766","type":"mongodb in","z":"14e9f5d5.1d23fa","mongodb":"d3cae7a7.2c3518","name":"Lookup DB","collection":"environment","operation":"find","x":730,"y":840,"wires":[["808420a2.916bd"]]},{"id":"808420a2.916bd","type":"function","z":"14e9f5d5.1d23fa","name":"First element","func":"var val = msg.payload;\nif (val) {\n    if (val.length > 0) {\n        val=val[0];\n        msg.payload=val;\n        context.global.mtemp = val.payload;\n        if (val.dtime > context.global.mLastUpdate)\n            context.global.mLastUpdate = val.dtime;\n    }\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"x":910,"y":840,"wires":[["243f0784.957cb8"]]},{"id":"243f0784.957cb8","type":"function","z":"14e9f5d5.1d23fa","name":"Master BedRoom Humidity","func":"var qtime = new Date()\nqtime = qtime - 30*60*1000\nvar query = {}\nquery[\"topic\"] = /\\/masterbed\\/humidity$/i\nquery[\"dtime\"] = {\"$gt\": qtime}\nvar proj = {topic:1,payload:1,dtime:1,_id:0}\nmsg.projection = proj\nmsg.payload = query\nmsg.limit=1\nmsg.skip=0\nmsg.sort={dtime:-1}\nreturn msg;","outputs":1,"noerr":0,"x":420,"y":900,"wires":[["b0c03bdf.15ff58"]]},{"id":"b0c03bdf.15ff58","type":"mongodb in","z":"14e9f5d5.1d23fa","mongodb":"d3cae7a7.2c3518","name":"Lookup DB","collection":"environment","operation":"find","x":730,"y":900,"wires":[["2013b10d.5b56be"]]},{"id":"2013b10d.5b56be","type":"function","z":"14e9f5d5.1d23fa","name":"First element","func":"var val = msg.payload;\nif (val) {\n    if (val.length > 0) {\n        val=val[0];\n        msg.payload=val;\n        context.global.mhumi = val.payload;\n        if (val.dtime > context.global.mLastUpdate)\n            context.global.mLastUpdate = val.dtime;\n    }\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"x":910,"y":900,"wires":[["a8431404.42f0f8"]]},{"id":"a8431404.42f0f8","type":"function","z":"14e9f5d5.1d23fa","name":"Room Temperature","func":"var qtime = new Date()\nqtime = qtime - 30*60*1000\nvar query = {}\nquery[\"topic\"] = /\\/living\\/temperature$/i\nquery[\"dtime\"] = {\"$gt\": qtime}\nvar proj = {topic:1,payload:1,dtime:1,_id:0}\nmsg.projection = proj\nmsg.payload = query\nmsg.limit=1\nmsg.skip=0\nmsg.sort={dtime:-1}\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":960,"wires":[["1917c2d6.b8c69d"]]},{"id":"1917c2d6.b8c69d","type":"mongodb in","z":"14e9f5d5.1d23fa","mongodb":"d3cae7a7.2c3518","name":"Lookup DB","collection":"environment","operation":"find","x":730,"y":960,"wires":[["2d50f684.c467fa"]]},{"id":"2d50f684.c467fa","type":"function","z":"14e9f5d5.1d23fa","name":"First element","func":"var val = msg.payload;\nif (val) {\n    if (val.length > 0) {\n        val=val[0];\n        msg.payload=val;\n        context.global.rtemp = val.payload;\n        if (val.dtime > context.global.rLastUpdate)\n            context.global.rLastUpdate = val.dtime;\n    }\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"x":910,"y":960,"wires":[["ec847e9a.bae59"]]},{"id":"ec847e9a.bae59","type":"function","z":"14e9f5d5.1d23fa","name":"Room Humidity","func":"var qtime = new Date()\nqtime = qtime - 30*60*1000\nvar query = {}\nquery[\"topic\"] = /\\/living\\/humidity$/i\nquery[\"dtime\"] = {\"$gt\": qtime}\nvar proj = {topic:1,payload:1,dtime:1,_id:0}\nmsg.projection = proj\nmsg.payload = query\nmsg.limit=1\nmsg.skip=0\nmsg.sort={dtime:-1}\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":1020,"wires":[["a5de33ac.4ec79"]]},{"id":"a5de33ac.4ec79","type":"mongodb in","z":"14e9f5d5.1d23fa","mongodb":"d3cae7a7.2c3518","name":"Lookup DB","collection":"environment","operation":"find","x":730,"y":1020,"wires":[["b0fd55eb.b96498"]]},{"id":"b0fd55eb.b96498","type":"function","z":"14e9f5d5.1d23fa","name":"First element","func":"var val = msg.payload;\nif (val) {\n    if (val.length > 0) {\n        val=val[0];\n        msg.payload=val;\n        context.global.rhumi = val.payload;\n        if (val.dtime > context.global.rLastUpdate)\n            context.global.rLastUpdate = val.dtime;\n    }\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":910,"y":1020,"wires":[["ae4cb6ac.5bed38"]]},{"id":"ae4cb6ac.5bed38","type":"function","z":"14e9f5d5.1d23fa","name":"Balcony Temperature","func":"var qtime = new Date()\nqtime = qtime - 30*60*1000\nvar query = {}\nquery[\"topic\"] = /\\/balcony\\/temperature$/i\nquery[\"dtime\"] = {\"$gt\": qtime}\nvar proj = {topic:1,payload:1,dtime:1,_id:0}\nmsg.projection = proj\nmsg.payload = query\nmsg.limit=1\nmsg.skip=0\nmsg.sort={dtime:-1}\nreturn msg;","outputs":1,"noerr":0,"x":400,"y":1080,"wires":[["ab9d2153.9e8c9"]]},{"id":"ab9d2153.9e8c9","type":"mongodb in","z":"14e9f5d5.1d23fa","mongodb":"d3cae7a7.2c3518","name":"Lookup DB","collection":"environment","operation":"find","x":730,"y":1080,"wires":[["8ac55ba6.fbd7a8"]]},{"id":"8ac55ba6.fbd7a8","type":"function","z":"14e9f5d5.1d23fa","name":"First element","func":"var val = msg.payload;\nif (val) {\n    if (val.length > 0) {\n        val=val[0];\n        msg.payload=val;\n        context.global.btemp = val.payload;\n        if (val.dtime > context.global.bLastUpdate)\n            context.global.bLastUpdate = val.dtime;\n    }\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":910,"y":1080,"wires":[["889b2b5c.06b5c8"]]},{"id":"889b2b5c.06b5c8","type":"function","z":"14e9f5d5.1d23fa","name":"Balcony Humidity","func":"var qtime = new Date()\nqtime = qtime - 30*60*1000\nvar query = {}\nquery[\"topic\"] = /\\/balcony\\/humidity$/i\nquery[\"dtime\"] = {\"$gt\": qtime}\nvar proj = {topic:1,payload:1,dtime:1,_id:0}\nmsg.projection = proj\nmsg.payload = query\nmsg.limit=1\nmsg.skip=0\nmsg.sort={dtime:-1}\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":1140,"wires":[["12138a93.8997b5"]]},{"id":"12138a93.8997b5","type":"mongodb in","z":"14e9f5d5.1d23fa","mongodb":"d3cae7a7.2c3518","name":"Lookup DB","collection":"environment","operation":"find","x":730,"y":1140,"wires":[["ea5f4a8a.317d98"]]},{"id":"ea5f4a8a.317d98","type":"function","z":"14e9f5d5.1d23fa","name":"First element","func":"var val = msg.payload;\nif (val) {\n    if (val.length > 0) {\n        val=val[0];\n        msg.payload=val;\n        context.global.bhumi = val.payload;\n        if (val.dtime > context.global.bLastUpdate)\n            context.global.bLastUpdate = val.dtime;\n    }\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":910,"y":1140,"wires":[["221aa8cd.448c28"]]},{"id":"c92283e0.e4cd8","type":"function","z":"14e9f5d5.1d23fa","name":"Sensor data","func":"var obj = {\n    living: {\n        temperature: context.global.rtemp,\n        motion: context.global.living_motion,\n        sound: context.global.living_sound,\n        humidity: context.global.rhumi,\n        brightness: context.global.living_brgt,\n        co2: context.global.living_co2,\n        voc: context.global.living_voc,\n        lastUpdate: context.global.rLastUpdate\n    },\n    balcony: {\n        temperature: context.global.btemp,\n        humidity: context.global.bhumi,\n        brightness: context.global.balcony_brgt,\n        lastUpdate: context.global.bLastUpdate\n    },\n    masterbed: {\n        temperature: context.global.mtemp,\n        humidity: context.global.mhumi,\n        brightness: context.global.masterbed_brgt,\n        lastUpdate: context.global.mLastUpdate\n    },\n    aqi: {\n        temperature: context.global.aqitemp,\n        humidity: context.global.aqihumi,\n        pm25: context.global.aqipm25,\n        aqi: context.global.aqiaqi,\n        lastUpdate: context.global.aqiALastUpdate\n    },\n    aqi02: {\n        temperature: context.global.aqi02temp,\n        humidity: context.global.aqi02humi,\n        pm25: context.global.aqi02pm25,\n        aqi: context.global.aqi02aqi,\n        lastUpdate: context.global.aqi02ALastUpdate\n    },\n    uv0980: {\n        uva: context.global.uv0980_uva,\n        uvb: context.global.uv0980_uvb,\n        uvi: context.global.uv0980_uvi,\n        vis: context.global.uv0980_vis,\n        ir: context.global.uv0980_ir,\n        lux: context.global.uv0980_lux,\n        temp: context.global.uv0980_temp,\n        press: context.global.uv0980_press,\n        lastUpdate: context.global.uv0980ALastUpdate\n    }\n};\nmsg.payload = obj;\nmsg.headers = {\"Content-type\":\"application/json\"};\nreturn msg;\n\n","outputs":1,"noerr":0,"x":1130,"y":1560,"wires":[["fd1536a2.f395e8","79c51543.8948ec"]]},{"id":"dba6cffd.e5114","type":"function","z":"14e9f5d5.1d23fa","name":"Value debug","func":"var obj = {\n    living: {\n        temperature: context.global.rtemp,\n        motion: context.global.living_motion,\n        sound: context.global.living_sound,\n        humidity: context.global.rhumi,\n        brightness: context.global.living_brgt,\n        co2: context.global.living_co2,\n        voc: context.global.living_voc\n    },\n    balcony: {\n        temperature: context.global.btemp,\n        humidity: context.global.bhumi,\n        brightness: context.global.balcony_brgt\n    },\n    masterbed: {\n        temperature: context.global.mtemp,\n        humidity: context.global.mhumi,\n        brightness: context.global.masterbed_brgt\n    },\n    lastUpdate: context.global.lastUpdate\n};\nmsg.payload = obj;\nmsg.headers = {\"Content-type\":\"application/json\"};\nreturn msg;","outputs":1,"noerr":0,"x":1130,"y":1500,"wires":[["5c59905.bf8f77"]]},{"id":"fd1536a2.f395e8","type":"http response","z":"14e9f5d5.1d23fa","name":"/sense2","x":1300,"y":1620,"wires":[]},{"id":"79c51543.8948ec","type":"debug","z":"14e9f5d5.1d23fa","name":"JSON values","active":false,"console":"false","complete":"payload","x":1310,"y":1560,"wires":[]},{"id":"5c59905.bf8f77","type":"debug","z":"14e9f5d5.1d23fa","name":"All Values","active":false,"console":"false","complete":"payload","x":1300,"y":1500,"wires":[]},{"id":"7be86c38.676954","type":"comment","z":"14e9f5d5.1d23fa","name":"Console Web Page","info":"","x":410,"y":60,"wires":[]},{"id":"67069fe0.06a6","type":"comment","z":"14e9f5d5.1d23fa","name":"Raw data","info":"","x":120,"y":620,"wires":[]},{"id":"3ba310ba.8b435","type":"http in","z":"14e9f5d5.1d23fa","name":"/envweb","url":"/envweb","method":"get","swaggerDoc":"","x":180,"y":240,"wires":[["feaaac2.0f78f5"]]},{"id":"feaaac2.0f78f5","type":"template","z":"14e9f5d5.1d23fa","name":"jQuery HTML","field":"payload","fieldType":"msg","format":"html","syntax":"mustache","template":"<!DOCTYPE html> \n<html>\n<head>\n    <title>Environment Concole</title>\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n\t<link rel=\"stylesheet\" href=\"http://code.jquery.com/mobile/1.4.0/jquery.mobile-1.4.0.min.css\" />\n<script src=\"http://code.jquery.com/jquery-1.9.1.min.js\"></script>\n<script src=\"http://code.jquery.com/mobile/1.4.0/jquery.mobile-1.4.0.min.js\"></script>\n<style>\n@media ( min-width: 30em ) {\n    /* Show the table header rows and set all cells to display: table-cell */\n    .sensor-list td,\n    .sensor-list th,\n    .sensor-list tbody th,\n    .sensor-list tbody td {\n        display: table-cell;\n        margin: 0;\n    }\n    /* Hide the labels in each cell */\n    .sensor-list thead td,\n    .sensor-list thead th,\n    .sensor-list td .ui-table-cell-label,\n    .sensor-list th .ui-table-cell-label {\n        display: none;\n    }\n    .sensor-list td,\n    .sensor-list tbody td {\n        padding-top: 16px;\n    }\n}\n\ntr {\n    border-bottom: 1px solid #d6d6d6;\n}\n\n\n#point { position:relative; -moz-animation:mymove 1s ease infinite; -webkit-animation:mymove 1s ease infinite; padding-left:1px; padding-right:1px; }\n\n@-webkit-keyframes mymove \n{\n0% {opacity:1.0; text-shadow:0 0 20px #00c6ff;}\n50% {opacity:0; text-shadow:none; }\n100% {opacity:1.0; text-shadow:0 0 20px #00c6ff; }  \n}\n\n\n@-moz-keyframes mymove \n{\n0% {opacity:1.0; text-shadow:0 0 20px #00c6ff;}\n50% {opacity:0; text-shadow:none; }\n100% {opacity:1.0; text-shadow:0 0 20px #00c6ff; }  \n}\n\n</style>\n<script src=\"/jq/jquery-2.1.4.min.js\"></script>\n<script src=\"/jq/mobile/jquery.mobile-1.4.5.min.js\"></script>\n<script>\n(function($) {\n    $(document).ready(function() {\n\n        var $cbtemp = $(\"#btemp\");\n        var $cbhumi = $(\"#bhumi\");\n        var $crtemp = $(\"#rtemp\");\n        var $crhumi = $(\"#rhumi\");\n        var $crco2  = $(\"#rco2\");\n        var $cmtemp = $(\"#mtemp\");\n        var $cmhumi = $(\"#mhumi\");\n        var $caqi01pm25 = $(\"#aqi01pm25\");\n        var $caqi01aqi = $(\"#aqi01aqi\");\n        var $caqi02pm25 = $(\"#aqi02pm25\");\n        var $caqi02aqi = $(\"#aqi02aqi\");\n        var $rlupdate = $(\"#rlupdate\");\n        var $blupdate = $(\"#blupdate\");\n        var $mlupdate = $(\"#mlupdate\");\n        var $aqilupdate = $(\"#aqilupdate\");\n        var $aqi02lupdate = $(\"#aqi02lupdate\");\n        var $cuva_uv0980 = $(\"#uva\");\n        var $cuvb_uv0980 = $(\"#uvb\");\n        var $cuvi_uv0980 = $(\"#uvi\");\n        var read_sensors = function() {\n            $.getJSON(\"/nodes/sense2\", function(data) {\n                var vbtemp = Math.round(data.balcony.temperature);\n                var vbhumi = Math.round(data.balcony.humidity);\n                $cbtemp.html(vbtemp);\n                $cbhumi.html(vbhumi);\n                $crtemp.html(Math.round(data.living.temperature));\n                $crhumi.html(Math.round(data.living.humidity));\n                $crco2.html(data.living.co2);\n                $cmtemp.html(Math.round(data.masterbed.temperature));\n                $cmhumi.html(Math.round(data.masterbed.humidity));\n                var pm25 = Math.round(data.aqi.pm25);\n                var aqi = Math.round(data.aqi.aqi);\n                var aqi02pm25 = Math.round(data.aqi02.pm25);\n                var aqi02aqi = Math.round(data.aqi02.aqi);\n                sessionStorage.aqi = aqi;\n                sessionStorage.aqi02aqi = aqi02aqi;\n                sessionStorage.rco2 = data.living.co2;\n                $caqi01pm25.html(pm25);\n                $caqi01aqi.html(aqi);\n                $caqi02pm25.html(aqi02pm25);\n                $caqi02aqi.html(aqi02aqi);\n                var uva = Math.round(data.uv0980.uva);\n                var uvb = Math.round(data.uv0980.uvb);\n                var uvi = Math.round(data.uv0980.lux);\n                $cuva_uv0980.html(uva);\n                $cuvb_uv0980.html(uvb);\n                $cuvi_uv0980.html(uvi);\n                \n                var blupdt = new Date(data.balcony.lastUpdate);\n                var rlupdt = new Date(data.living.lastUpdate);\n                var mlupdt = new Date(data.masterbed.lastUpdate);\n                var aqilupdt = new Date(data.aqi.lastUpdate);\n                var aqi02lupdt = new Date(data.aqi02.lastUpdate);\n                var noww = new Date();\n                var rdupdt = noww - rlupdt; // difference (Living Room)\n                var bdupdt = noww - blupdt; // difference (Balcony)\n                var mdupdt = noww - mlupdt; // difference (Master Bedroom)\n                var aqidupdt = noww - aqilupdt; // difference (AQI)\n                var aqi02dupdt = noww - aqi02lupdt; // difference (AQI02)\n                var rmupdt = parseInt(rdupdt/1000/60);\n                var bmupdt = parseInt(bdupdt/1000/60);\n                var mmupdt = parseInt(mdupdt/1000/60);\n                var aqimupdt = parseInt(aqidupdt/1000/60);\n                var aqi02mupdt = parseInt(aqi02dupdt/1000/60);\n                $rlupdate.html(rmupdt+\"m ago\");\n                $blupdate.html(bmupdt+\"m ago\");\n                $mlupdate.html(mmupdt+\"m ago\");\n                $aqilupdate.html(aqimupdt+\"m\");\n                $aqi02lupdate.html(aqi02mupdt+\"m\");\n                if (rmupdt>30) {\n                    $crtemp.html(\"--\");\n                    $crtemp.humi(\"--\");\n                    $rlupdate.html(\"FAIL\");\n                }\n                if (bmupdt>30) {\n                    if (aqimupdt>30) {\n                        $cbtemp.html(\"--\");\n                        $cbhumi.html(\"--\");\n                        $blupdate.html(\"FAIL\");\n                    } else {\n                        $cbtemp.html(Math.round(data.aqi.temperature));\n                        $cbhumi.html(Math.round(data.aqi.humidity));\n                    }\n                }\n                if (mmupdt>30) {\n                    $cmtemp.html(\"--\");\n                    $cmhumi.html(\"--\");\n                    $mlupdate.html(\"FAIL\");\n                }\n                if (aqimupdt > 60) {\n                    $caqi01pm25.html(\"--\");\n                    $caqi01aqi.html(\"--\");\n                    $aqilupdate.html(\"FAIL\");\n                }\n                if (aqi02mupdt > 60) {\n                    $caqi02pm25.html(\"--\");\n                    $caqi02aqi.html(\"--\");\n                    $aqi02lupdate.html(\"FAIL\");\n                }\n            });\n        };\n        $cbtemp.html(\"00ºC\");\n        $cbhumi.html(\"00%rh\");\n        $crtemp.html(\"00ºC\");\n        $crhumi.html(\"00%rh\");\n        $crco2.html(\"0\");\n        $cmtemp.html(\"00ºC\");\n        $cmhumi.html(\"00%rh\");\n        $caqi01pm25.html(\"00\");\n        $caqi01aqi.html(\"00\");\n        $caqi02pm25.html(\"00\");\n        $caqi02aqi.html(\"00\");\n        $rlupdate.html(\"Unknown\");\n        $blupdate.html(\"Unknown\");\n        $mlupdate.html(\"Unknown\");\n        $aqilupdate.html(\"Unknown\");\n        $aqi02lupdate.html(\"Unknown\");\n        $cuva_uv0980.html(\"0\");\n        $cuvb_uv0980.html(\"0\");\n        $cuvi_uv0980.html(\"0\");\n        read_sensors();\n\n        var tt = $(\"#aqi01aqi\").text();\n        var tti = sessionStorage.aqi;\n        if (tt != \"FAIL\" || (tt != \"--\")) {\n            if (tti < 50) {\n                $('.aqi').closest('td').css({\"color\":\"black\",\n                \"background-color\":\"#30ff30\"});\n            } else if ((50 <= tti) && (tti < 100)) {\n                $('.aqi').closest('td').css({\"color\":\"black\",\n                \"background-color\":\"yellow\"});\n            } else if ((100 <= tti) && (tti < 200)) {\n                $('.aqi').closest('td').css({\"color\":\"black\",\n                \"background-color\":\"orange\"});\n            } else if ((200 <= tti) && (tti < 300)) {\n                $('.aqi').closest('td').css({\"color\":\"white\",\n                \"background-color\":\"red\"});\n            } else if (tti > 300) {\n                $('.aqi').closest('td').css({\"color\":\"white\",\n                \"background-color\":\"black\"});\n            }\n        } else {\n            $('.aqi').closest('td').css({\"color\":\"white\",\"background-color\":\"white\"});\n        }\n\n        var tt2 = $(\"#aqi02aqi\").text();\n        var tti2 = sessionStorage.aqi02aqi;\n        if (tt2 != \"FAIL\" || (tt2 != \"--\")) {\n            if (tti2 < 50) {\n                $('.aqi02').closest('td').css({\"color\":\"black\",\n                \"background-color\":\"#30ff30\"});\n            } else if ((50 <= tti2) && (tti2 < 100)) {\n                $('.aqi02').closest('td').css({\"color\":\"black\",\n                \"background-color\":\"yellow\"});\n            } else if ((100 <= tti2) && (tti2 < 200)) {\n                $('.aqi02').closest('td').css({\"color\":\"black\",\n                \"background-color\":\"orange\"});\n            } else if ((200 <= tti2) && (tti2 < 300)) {\n                $('.aqi02').closest('td').css({\"color\":\"white\",\n                \"background-color\":\"red\"});\n            } else if (tti2 > 300) {\n                $('.aqi02').closest('td').css({\"color\":\"white\",\n                \"background-color\":\"black\"});\n            }\n        } else {\n            $('.aqi02').closest('td').css({\"color\":\"white\",\"background-color\":\"white\"});\n        }\n\n        var tt3 = $(\"#rco2\").text();\n        var tti3 = sessionStorage.rco2;\n        if (tt3 != \"FAIL\" || (tt3 != \"--\")) {\n            if (tti3 < 700) {\n                $('.co2').closest('td').css({\"color\":\"black\",\n                \"background-color\":\"#30ff30\"});\n            } else if ((800 <= tti3) && (tti3 < 1000)) {\n                $('.co2').closest('td').css({\"color\":\"black\",\n                \"background-color\":\"yellow\"});\n            } else if ((1000 <= tti3) && (tti3 < 2000)) {\n                $('.co2').closest('td').css({\"color\":\"black\",\n                \"background-color\":\"orange\"});\n            } else if ((2000 <= tti3) && (tti3 < 3000)) {\n                $('.co2').closest('td').css({\"color\":\"white\",\n                \"background-color\":\"red\"});\n            } else if (tti3 > 3000) {\n                $('.co2').closest('td').css({\"color\":\"white\",\n                \"background-color\":\"black\"});\n            }\n        } else {\n            $('.co2').closest('td').css({\"color\":\"white\",\"background-color\":\"white\"});\n        }\n\n\n        // read_switches();\n        // Set default state of control buttons according to their current status\n        var $radios = $('input:radio[name=livingRoomlight]');\n        if($radios.is(':checked') === false) {\n            $radios.filter('[value=1]').prop('checked', true);\n        }\n\n        var refreshId = setInterval(read_sensors, 300000);\n        setInterval( function() {\n            // Create a newDate() object and extract the minutes of the current time on the visitor's\n            var minutes = new Date().getMinutes();\n            // Add a leading zero to the minutes value\n            $(\"#min\").html(( minutes < 10 ? \"0\" : \"\" ) + minutes);\n        },1000);\n    \n        setInterval( function() {\n            // Create a newDate() object and extract the hours of the current time on the visitor's\n            var hours = new Date().getHours();\n            // Add a leading zero to the hours value\n            $(\"#hours\").html(( hours < 10 ? \"0\" : \"\" ) + hours);\n        }, 1000);\n\n    });\n})(jQuery);\n</script>\n<script>$('input[name=\"livingRoomlight\"]').on('switchChange', function(event, state) {\n  console.log(this); // DOM element\n  console.log(event); // jQuery event\n  console.log(state); // true | false\n  console.log(this.value);\n});\n</script>\n</head>\n\n<body>\n<!-- Start of first page: #one -->\n<div data-role=\"page\" id=\"one\">\n\n    <div data-role=\"header\">\n        <h1>\n            <span id=\"uvi\"></span>(<span id=\"uva\"></span>/<span id=\"uvb\"></span>)\n            &nbsp;&nbsp;&nbsp;\n            House <span id=\"hours\"></span><span id=\"point\">:</span><span id=\"min\"></span>\n        </h1>\n    </div><!-- /header -->\n\n    <div role=\"main\" class=\"ui-content\" >\n    <table data-role=\"table\" class=\"sensor-list\">\n        <thead>\n        <tr>\n            <th>Place</th>\n            <th>Temp</th>\n            <th>%RH</th>\n        </tr>\n        </thead>\n        <tbody>\n        <tr>\n            <td>Balcony</td>\n            <td><font size=11><b><span id=\"btemp\"></span></b></font>ºC</td>\n            <td><font size=6><b><span id=\"bhumi\"></span></b></font>%RH</td>\n            <td class=\"aqi\"><font size=11><b><span id=\"aqi01aqi\"></span></b></font>/<font size=6><b><span id=\"aqi01pm25\"></span></b></font></td>\n        </tr>\n        <tr>\n            <td>Living Room</td>\n            <td><font size=6><b><span id=\"rtemp\"></span></b></font>ºC</td>\n            <td><font size=6><b><span id=\"rhumi\"></span></b></font>%RH</td>\n            <td class=\"aqi02\"><font size=11><b><span id=\"aqi02aqi\"></span></b></font>/<font size=6><b><span id=\"aqi02pm25\"></span></b></font></td>\n            <td class=\"co2\"><font size=6><b><span id=\"rco2\"></span></b></font>ppm</td>\n        </tr>\n        <tr>\n            <td>Master BedRoom</td>\n            <td><font size=6><b><span id=\"mtemp\"></span></b></font>ºC</td>\n            <td><font size=6><b><span id=\"mhumi\"></span></b></font>%RH</td>\n        </tr>\n        </tbody>\n    </table>\n<!--\n    <p>Updated Outdoor <span id=\"blupdate\"></span>, living <span id=\"rlupdate\"></span>, bed <span id=\"mlupdate\"></span></p>\n-->\n<!--        <p><a href=\"#two\" class=\"ui-btn ui-shadow ui-corner-all\">Show page \"two\"</a></p> -->\n        <p><a href=\"#popup\" class=\"ui-btn ui-shadow ui-corner-all\" data-rel=\"dialog\" data-transition=\"pop\">Control</a></p>\n    </div><!-- /content -->\n\n    <div data-role=\"footer\" data-theme=\"a\">\n        <h4>Home IoT</h4>\n    </div><!-- /footer -->\n</div><!-- /page one -->\n\n<!-- Start of second page: #two -->\n<div data-role=\"page\" id=\"two\" data-theme=\"a\">\n\n    <div data-role=\"header\">\n        <h1>Two</h1>\n    </div><!-- /header -->\n\n    <div role=\"main\" class=\"ui-content\">\n        <h2>Two</h2>\n        <p>I have an id of \"two\" on my page container. I'm the second page container in this multi-page template.</p>\n        <p>Notice that the theme is different for this page because we've added a few <code>data-theme</code> swatch assigments here to show off how flexible it is. You can add any content or widget to these pages, but we're keeping these simple.</p>\n        <p><a href=\"#one\" data-direction=\"reverse\" class=\"ui-btn ui-shadow ui-corner-all ui-btn-b\">Back to page \"one\"</a></p>\n\n    </div><!-- /content -->\n\n    <div data-role=\"footer\">\n        <h4>Home IoT</h4>\n    </div><!-- /footer -->\n</div><!-- /page two -->\n\n<!-- Start of third page: #popup -->\n<div data-role=\"page\" id=\"popup\">\n\n    <div data-role=\"header\" data-theme=\"b\">\n        <h1>Screens and Lights</h1>\n    </div><!-- /header -->\n\n    <div role=\"main\" class=\"ui-content\">\n        <p><b>Controls screens and lights</b></p>\n<form>\n    <table data-role=\"table\" class=\"sensor-list\">\n        <thead>\n        <tr>\n            <th>Display</th>\n            <th>Set</th>\n        </tr>\n        </thead>\n        <tbody>\n        <tr>\n            <td>Balcony Lanterns</td>\n            <td>\n    <fieldset data-role=\"controlgroup\" data-type=\"horizontal\">\n        <input type=\"radio\" name=\"livingRoomlight\" id=\"livingRoomLight-a\" value=\"0\">\n        <label for=\"livingRoomLight-a\">Off</label>\n        <input type=\"radio\" name=\"livingRoomlight\" id=\"livingRoomLight-b\" value=\"1\">\n        <label for=\"livingRoomLight-b\">On</label>\n\n<!--\n        <input type=\"radio\" name=\"radio-choice-h-2\" id=\"radio-choice-h-2c\" value=\"other\">\n        <label for=\"radio-choice-h-2c\">Three</label>\n-->\n    </fieldset>\n            </td>\n        </tr>\n        </tbody>\n    </table>\n</form>\n    <p><a href=\"#one\" data-rel=\"back\" class=\"ui-btn ui-shadow ui-corner-all ui-btn-inline ui-icon-back ui-btn-icon-left\">Back to Main</a></p>\n    </div><!-- /content -->\n\n    <div data-role=\"footer\">\n        <h4>Home IoT</h4>\n    </div><!-- /footer -->\n</div><!-- /page popup -->\n</body>\n</html>\n","x":390,"y":240,"wires":[["b5a10c3f.1e523"]]},{"id":"b5a10c3f.1e523","type":"http response","z":"14e9f5d5.1d23fa","name":"/envweb","x":1180,"y":240,"wires":[]},{"id":"d62307a2.67c4a8","type":"http in","z":"14e9f5d5.1d23fa","name":"/envwebc","url":"/envwebc","method":"get","swaggerDoc":"","x":180,"y":500,"wires":[["2f3867d9.c321a8"]]},{"id":"2f3867d9.c321a8","type":"template","z":"14e9f5d5.1d23fa","name":"jQuery HTML","field":"payload","fieldType":"msg","format":"text","syntax":"mustache","template":"<!DOCTYPE html> \n<html>\n<head>\n\t<title>Environment Concole</title>\n\t<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n\t<link rel=\"stylesheet\" href=\"/jq/mobile/jquery.mobile-1.4.5.min.css\" />\n<link rel=\"stylesheet\" href=\"/css/themes/greenie.css\" />\n<link rel=\"stylesheet\" href=\"/css/themes/jquery.mobile.icons.min.css\" />\n<style>\n@media ( min-width: 30em ) {\n\t/* Show the table header rows and set all cells to display: table-cell */\n\t.sensor-list td,\n\t.sensor-list th,\n\t.sensor-list tbody th,\n\t.sensor-list tbody td {\n\t\tdisplay: table-cell;\n\t\tmargin: 0;\n\t}\n\t/* Hide the labels in each cell */\n\t.sensor-list thead td,\n\t.sensor-list thead th,\n\t.sensor-list td .ui-table-cell-label,\n\t.sensor-list th .ui-table-cell-label {\n\t\tdisplay: none;\n\t}\n}\n</style>\n<script src=\"/jq/jquery-2.1.4.min.js\"></script>\n<script src=\"/jq/mobile/jquery.mobile-1.4.5.min.js\"></script>\n<script>\n(function($) {\n    $(document).ready(function() {\n\n        var $cbtemp = $(\"#btemp\");\n        var $cbhumi = $(\"#bhumi\");\n        var $crtemp = $(\"#rtemp\");\n        var $crhumi = $(\"#rhumi\");\n        var $cmtemp = $(\"#mtemp\");\n        var $cmhumi = $(\"#mhumi\");\n        var $cnoww = $(\"#noww\");\n        var $rlupdate = $(\"#rlupdate\");\n        var $blupdate = $(\"#blupdate\");\n        var $mlupdate = $(\"#mlupdate\");\n        var read_sensors = function() {\n            $.getJSON(\"/nodes/sense2\", function(data) {\n                $cbtemp.html(data.balcony.temperature);\n                $cbhumi.html(data.balcony.humidity);\n                $crtemp.html(data.living.temperature);\n                $crhumi.html(data.living.humidity);\n                $cmtemp.html(data.masterbed.temperature);\n                $cmhumi.html(data.masterbed.humidity);\n                var blupdt = new Date(data.balcony.lastUpdate);\n                var rlupdt = new Date(data.living.lastUpdate);\n                var mlupdt = new Date(data.masterbed.lastUpdate);\n                var noww = new Date();\n                var rdupdt = noww - rlupdt; // difference (Living Room)\n                var bdupdt = noww - blupdt; // difference (Balcony)\n                var mdupdt = noww - mlupdt; // difference (Master Bedroom)\n                var rmupdt = parseInt(rdupdt/1000/60);\n                var bmupdt = parseInt(bdupdt/1000/60);\n                var mmupdt = parseInt(mdupdt/1000/60);\n                $rlupdate.html(rmupdt+\"分鐘前\");\n                $blupdate.html(bmupdt+\"分鐘前\");\n                $mlupdate.html(mmupdt+\"分鐘前\");\n                $cnoww.html(noww);\n            });\n        };\n        $cbtemp.html(\"00.00ºC\");\n        $cbhumi.html(\"00.00%rh\");\n        $crtemp.html(\"00.00ºC\");\n        $crhumi.html(\"00.00%rh\");\n        $cmtemp.html(\"00.00ºC\");\n        $cmhumi.html(\"00.00%rh\");\n        $rlupdate.html(\"Unknown\");\n        $blupdate.html(\"Unknown\");\n        $mlupdate.html(\"Unknown\");\n        read_sensors();\n        var refreshId = setInterval(read_sensors, 10000);\n    });\n})(jQuery);\n</script>\n</head>\n\n<body>\n<!-- Start of first page: #one -->\n<div data-role=\"page\" id=\"one\">\n\n\t<div data-role=\"header\">\n\t\t<h1>住處</h1>\n\t</div><!-- /header -->\n\n\t<div role=\"main\" class=\"ui-content\" >\n\t<table data-role=\"table\" class=\"sensor-list\">\n        <thead>\n        <tr>\n            <th>Place</th>\n\t\t    <th>Temp</th>\n    \t\t<th>%RH</th>\n    \t</tr>\n        </thead>\n        <tbody>\n        <tr>\n            <td>露台</td>\n            <td><font size=11><b><span id=\"btemp\"></span></b></font>ºC</td>\n            <td><font size=6><b><span id=\"bhumi\"></span></b></font>%RH</td>\n        </tr>\n        <tr>\n            <td>客廳</td>\n            <td><font size=6><b><span id=\"rtemp\"></span></b></font>ºC</td>\n            <td><font size=6><b><span id=\"rhumi\"></span></b></font>%RH</td>\n        </tr>\n        <tr>\n            <td>主人房</td>\n            <td><font size=6><b><span id=\"mtemp\"></span></b></font>ºC</td>\n            <td><font size=6><b><span id=\"mhumi\"></span></b></font>%RH</td>\n        </tr>\n        </tbody>\n    </table>\n    <p>更新：戶外 <span id=\"blupdate\"></span>, 客廳 <span id=\"rlupdate\"></span>, 主人房 <span id=\"mlupdate\"></span></p>\n<!--\t\t<p><a href=\"#two\" class=\"ui-btn ui-shadow ui-corner-all\">Show page \"two\"</a></p> -->\n\t\t<p><a href=\"#popup\" class=\"ui-btn ui-shadow ui-corner-all\" data-rel=\"dialog\" data-transition=\"pop\">控制</a></p>\n\t</div><!-- /content -->\n\n\t<div data-role=\"footer\" data-theme=\"a\">\n\t\t<h4>家居監控平台</h4>\n\t</div><!-- /footer -->\n</div><!-- /page one -->\n\n<!-- Start of second page: #two -->\n<div data-role=\"page\" id=\"two\" data-theme=\"a\">\n\n\t<div data-role=\"header\">\n\t\t<h1>Two</h1>\n\t</div><!-- /header -->\n\n\t<div role=\"main\" class=\"ui-content\">\n\t\t<h2>Two</h2>\n\t\t<p>I have an id of \"two\" on my page container. I'm the second page container in this multi-page template.</p>\n\t\t<p>Notice that the theme is different for this page because we've added a few <code>data-theme</code> swatch assigments here to show off how flexible it is. You can add any content or widget to these pages, but we're keeping these simple.</p>\n\t\t<p><a href=\"#one\" data-direction=\"reverse\" class=\"ui-btn ui-shadow ui-corner-all ui-btn-b\">Back to page \"one\"</a></p>\n\n\t</div><!-- /content -->\n\n\t<div data-role=\"footer\">\n\t\t<h4>家居監控平台</h4>\n\t</div><!-- /footer -->\n</div><!-- /page two -->\n\n<!-- Start of third page: #popup -->\n<div data-role=\"page\" id=\"popup\">\n\n\t<div data-role=\"header\" data-theme=\"b\">\n\t\t<h1>Screens and Lights</h1>\n\t</div><!-- /header -->\n\n\t<div role=\"main\" class=\"ui-content\">\n\t\t<p><b>Controls screens and lights</b></p>\n<form>\n\t<table data-role=\"table\" class=\"sensor-list\">\n        <thead>\n        <tr>\n            <th>Display</th>\n\t\t    <th>Set</th>\n    \t</tr>\n        </thead>\n        <tbody>\n        <tr>\n            <td>MagicLight</td>\n            <td>\n    <fieldset data-role=\"controlgroup\" data-type=\"horizontal\">\n        <input type=\"radio\" name=\"magiclight\" id=\"radio-choice-h-2a\" value=\"0\" checked=\"checked\">\n        <label for=\"radio-choice-h-2a\">Off</label>\n        <input type=\"radio\" name=\"magiclight\" id=\"radio-choice-h-2b\" value=\"1\">\n        <label for=\"radio-choice-h-2b\">Auto</label>\n<!--\n        <input type=\"radio\" name=\"radio-choice-h-2\" id=\"radio-choice-h-2c\" value=\"other\">\n        <label for=\"radio-choice-h-2c\">Three</label>\n-->\n    </fieldset>\n            </td>\n        </tr>\n        </tbody>\n    </table>\n</form>\n\t<p><a href=\"#one\" data-rel=\"back\" class=\"ui-btn ui-shadow ui-corner-all ui-btn-inline ui-icon-back ui-btn-icon-left\">Back to Main</a></p>\n\t</div><!-- /content -->\n\n\t<div data-role=\"footer\">\n\t\t<h4>家居監控平台</h4>\n\t</div><!-- /footer -->\n</div><!-- /page popup -->\n</body>\n</html>","x":390,"y":500,"wires":[["4ded5004.1442"]]},{"id":"4ded5004.1442","type":"http response","z":"14e9f5d5.1d23fa","name":"/envwebc","x":1180,"y":500,"wires":[]},{"id":"78813128.ff792","type":"inject","z":"32ff8a67.c39a86","name":"Arm All Alarms","topic":"sensornet/command/arm","payload":"arm","payloadType":"string","repeat":"","crontab":"","once":false,"x":240,"y":700,"wires":[["71091176.872c9"]]},{"id":"71091176.872c9","type":"mqtt out","z":"32ff8a67.c39a86","name":"MQTT Send","topic":"","qos":"","retain":"","broker":"9eac092b.6153f8","x":653.8571472167969,"y":773.0000667572021,"wires":[]},{"id":"e59675e4.3e7f88","type":"inject","z":"32ff8a67.c39a86","name":"DisArm All","topic":"sensornet/command/disarm","payload":"disarm","payloadType":"string","repeat":"","crontab":"","once":false,"x":220,"y":760,"wires":[["71091176.872c9"]]},{"id":"ea1168f0.499708","type":"inject","z":"32ff8a67.c39a86","name":"Console 01 Display Off","topic":"sensornet/command/envconsole01/display/off","payload":"doff","payloadType":"string","repeat":"","crontab":"","once":false,"x":260,"y":820,"wires":[["71091176.872c9"]]},{"id":"b82de6d9.00f528","type":"inject","z":"32ff8a67.c39a86","name":"Console 01 Display On","topic":"sensornet/command/envconsole01/display/on","payload":"don","payloadType":"string","repeat":"","crontab":"","once":true,"x":270,"y":880,"wires":[["71091176.872c9"]]},{"id":"f99bfae1.4f7b68","type":"mqtt in","z":"32ff8a67.c39a86","name":"Status","topic":"sensornet/status/#","broker":"9eac092b.6153f8","x":250,"y":380,"wires":[["9a671d06.8514","b1b17f20.e2c09"]]},{"id":"9a671d06.8514","type":"function","z":"32ff8a67.c39a86","name":"Set arm status","func":"var str = msg.payload;\nvar changed = false;\nif (context.global.allarmed === null) {\n    context.global.allarmed = false;\n    changed = true;\n}\nif (str == 'ARMED') {\n    if (!context.global.allarmed) {\n        context.global.allarmed = true;\n        changed = true;\n    }\n} else if (str == 'DISARMED') {\n    if (context.global.allarmed) {\n        context.global.allarmed = false;\n        changed = true;\n    }\n}\nmsg.allarmed=context.global.allarmed;\nif (changed)\n    return msg;\nelse\n    return;\n    ","outputs":1,"noerr":0,"x":420,"y":420,"wires":[["c68f8f58.eb157"]]},{"id":"b1b17f20.e2c09","type":"debug","z":"32ff8a67.c39a86","name":"All devices status","active":true,"console":"false","complete":"payload","x":1150,"y":380,"wires":[]},{"id":"c68f8f58.eb157","type":"switch","z":"32ff8a67.c39a86","name":"IPCam On/Off selection","property":"allarmed","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","outputs":2,"x":430,"y":520,"wires":[["71306bbe.52af74"],["a11ec7e8.8df368"]]},{"id":"71306bbe.52af74","type":"change","z":"32ff8a67.c39a86","name":"Turn on IPCam","rules":[{"t":"set","p":"deviceid","pt":"msg","to":"1605000","tot":"str"},{"t":"set","p":"payload","pt":"msg","to":"on","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":680,"y":580,"wires":[["931e02c9.281b1"]]},{"id":"a11ec7e8.8df368","type":"change","z":"32ff8a67.c39a86","name":"Turn off IPCam","rules":[{"t":"set","p":"deviceid","pt":"msg","to":"1605000","tot":"str"},{"t":"set","p":"payload","pt":"msg","to":"off","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":680,"y":640,"wires":[["931e02c9.281b1"]]},{"id":"931e02c9.281b1","type":"function","z":"32ff8a67.c39a86","name":"Telldus ONOFF","func":"// Node-RED function to\n// a) list all Telldus devices (device = everything in Telldus Live except sensors)\n//\n// The code below relies on the following modules to be installed in the Node-RED environment, including being set up\n// in the functionGlobalContext section of the Node-RED settings.js config file (see last section of http://nodered.org/docs/writing-functions.html page)\n//\n// a) Telldus-Live module (https://github.com/TheThingSystem/node-telldus-live)\n//\n//\n// The function will fire one output message for each device it gets information about from Telldus Live.\n// By default the device id and name is included in the messages, but this can be customised as needed.\n//\n\n// Define Telldus Live API credentials\nvar publicKey    = 'FEHUVEW84RAFR5SP22RABURUPHAFRUNU',\n    privateKey   = 'ZUXEVEGA9USTAZEWRETHAQUBUR69U6EF',\n    token        = '13469c397c5216df6db311f991b09b3f055d36f2a',\n    tokenSecret  = '0b66cde0bc8c0afca00c56289b174cac',\n    cloud;\n\nvar mydevice = msg.deviceid;\nvar onP = (msg.payload==='on');\n\n// Create and log into new TelldusAPI object\ncloud = new context.global.telldusLive.TelldusAPI({ publicKey  : publicKey,\n    privateKey : privateKey });\n\ncloud.login(token, tokenSecret, function(err, user) {\n  if (!!err) return console.log('login error: ' + err.message);\n\n  // Get list of all devices. Use async call to avoid blocking\n  cloud.getDevices(function(err, devices) {\n    var f, i;\n\n    if (!!err) return console.log('getDevices: ' + err.message);\n\n\n    f = function() {\n      return function(err, result) {\n        if (!!err) return console.log('onOffDevices: ' + err.message);\n        node.send({payload:result});\n        return;\n      };\n    };\n\n    // Loop over all devices, asynchcronously get the data for each\n    for (i = 0; i < devices.length; i++) {\n      if (devices[i].type === 'device' && devices[i].id === mydevice) {\n        node.log('found device: '+i+' '+devices[i].id);\n        cloud.onOffDevice(devices[i], onP, f());\n      }\n    }\n  });\n}).on('error', function(err) {\n  console.log('background error: ' + err.message);\n});\n\n\nreturn;\n","outputs":1,"noerr":0,"x":900,"y":580,"wires":[["1775280c.3b48e8"]]},{"id":"460cd3a9.30362c","type":"inject","z":"32ff8a67.c39a86","name":"IPCam on","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"x":220,"y":580,"wires":[["71306bbe.52af74"]]},{"id":"758f218a.ecbc5","type":"inject","z":"32ff8a67.c39a86","name":"IPCam off","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"x":220,"y":640,"wires":[["a11ec7e8.8df368"]]},{"id":"1775280c.3b48e8","type":"debug","z":"32ff8a67.c39a86","name":"Telldus-live IPCam On/Off","active":false,"console":"false","complete":"payload","x":1130,"y":580,"wires":[]},{"id":"19160e0a.227aa2","type":"comment","z":"32ff8a67.c39a86","name":"House alarms","info":"Turn on and off house alarms and send alarm via push message to the iPhone.\n","x":170,"y":100,"wires":[]},{"id":"d4fd60c1.e68af","type":"prowl","z":"32ff8a67.c39a86","title":"Intruder in Living Room","priority":0,"name":"Push Alarm","x":707.7142753601074,"y":982.285572052002,"wires":[]},{"id":"edc8e6d4.669d78","type":"mqtt in","z":"32ff8a67.c39a86","name":"Motion Alarm","topic":"sensornet/env/home/living/alarm/motion","broker":"9eac092b.6153f8","x":210,"y":980,"wires":[["cb4ed0dc.2c97f"]]},{"id":"cb4ed0dc.2c97f","type":"change","z":"32ff8a67.c39a86","name":"Alarm Message","rules":[{"t":"set","p":"payload","to":"Intruder found"}],"action":"","property":"","from":"","to":"","reg":false,"x":484.57141876220703,"y":980.9997539520264,"wires":[["d4fd60c1.e68af"]]},{"id":"ce7e1e1e.cb59a","type":"inject","z":"32ff8a67.c39a86","name":"Enable alarm","topic":"","payload":"enable","payloadType":"string","repeat":"","crontab":"","once":false,"x":230,"y":160,"wires":[["7827125d.7994fc"]]},{"id":"94de22e2.daac1","type":"inject","z":"32ff8a67.c39a86","name":"Disable alarm","topic":"","payload":"disable","payloadType":"string","repeat":"","crontab":"","once":true,"x":240,"y":220,"wires":[["7827125d.7994fc"]]},{"id":"7827125d.7994fc","type":"function","z":"32ff8a67.c39a86","name":"Enable/Disable Alarm","func":"var s = msg.payload;\nif (s === 'enable')\n    context.global.enableAlarm = true;\nelse\n    context.global.enableAlarm = false;\nreturn msg;","outputs":1,"noerr":0,"x":480,"y":180,"wires":[[]]},{"id":"c0993b0f.418978","type":"inject","z":"14e9f5d5.1d23fa","name":"Print","topic":"","payload":"","payloadType":"none","repeat":"","crontab":"","once":false,"x":150,"y":180,"wires":[["748f7232.85df6c"]]},{"id":"748f7232.85df6c","type":"function","z":"14e9f5d5.1d23fa","name":"Print","func":"msg.payload = context.global.aqiALastUpdate;\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":180,"wires":[["12ce4bb5.faa524"]]},{"id":"12ce4bb5.faa524","type":"debug","z":"14e9f5d5.1d23fa","name":"","active":true,"console":"false","complete":"false","x":530,"y":180,"wires":[]},{"id":"f053416b.f7967","type":"function","z":"14e9f5d5.1d23fa","name":"Sensor data","func":"var obj = {\n    living: {\n        temperature: context.global.living_temp,\n        motion: context.global.living_motion,\n        sound: context.global.living_sound,\n        humidity: context.global.living_humi,\n        brightness: context.global.living_brgt\n    },\n    balcony: {\n        temperature: context.global.balcony_temp,\n        humidity: context.global.balcony_humi,\n        brightness: context.global.balcony_brgt\n    }\n};\nmsg.payload = obj;\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":320,"wires":[["b84d151d.7c3638"]]},{"id":"b84d151d.7c3638","type":"json","z":"14e9f5d5.1d23fa","name":"","x":510,"y":320,"wires":[["c36a9be3.61eee8"]]},{"id":"85f6538b.2a2b7","type":"http in","z":"14e9f5d5.1d23fa","name":"/sense","url":"/sense","method":"get","swaggerDoc":"","x":170,"y":320,"wires":[["f053416b.f7967"]]},{"id":"c36a9be3.61eee8","type":"http response","z":"14e9f5d5.1d23fa","name":"/sense","x":670,"y":320,"wires":[]},{"id":"c45d69ee.f0cb28","type":"http in","z":"14e9f5d5.1d23fa","name":"/envweb2","url":"/envweb2","method":"get","swaggerDoc":"","x":180,"y":380,"wires":[["36470a9a.f1acc6"]]},{"id":"36470a9a.f1acc6","type":"function","z":"14e9f5d5.1d23fa","name":"Latest Temperature","func":"var qtime = new Date()\nqtime = qtime - 30*60*1000\nvar query = {}\nquery[\"topic\"] = /\\/temperature$/i\nquery[\"dtime\"] = {\"$gt\": qtime}\nvar proj = {topic:1,payload:1,dtime:1,_id:0}\nmsg.projection = proj\nmsg.payload = query\nmsg.limit=1\nmsg.sort={dtime:-1}\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":380,"wires":[["1565d6c1.30b189"]]},{"id":"1565d6c1.30b189","type":"mongodb in","z":"14e9f5d5.1d23fa","mongodb":"d3cae7a7.2c3518","name":"Lookup DB","collection":"environment","operation":"find","x":570,"y":380,"wires":[["ef4e5b58.eaf478"]]},{"id":"ef4e5b58.eaf478","type":"function","z":"14e9f5d5.1d23fa","name":"First element","func":"msg.payload=msg.payload[0]\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":380,"wires":[["abff4849.25f538"]]},{"id":"abff4849.25f538","type":"template","z":"14e9f5d5.1d23fa","name":"jQuery HTML","field":"","format":"text","template":"<!DOCTYPE html> \n<html>\n<head>\n\t<title>Environment Concole</title>\n\t<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n\t<link rel=\"stylesheet\" href=\"/jq/mobile/jquery.mobile-1.4.5.min.css\" />\n<link rel=\"stylesheet\" href=\"/css/themes/greenie.css\" />\n<link rel=\"stylesheet\" href=\"/css/themes/jquery.mobile.icons.min.css\" />\n<style>\n@media ( min-width: 30em ) {\n\t/* Show the table header rows and set all cells to display: table-cell */\n\t.sensor-list td,\n\t.sensor-list th,\n\t.sensor-list tbody th,\n\t.sensor-list tbody td {\n\t\tdisplay: table-cell;\n\t\tmargin: 0;\n\t}\n\t/* Hide the labels in each cell */\n\t.sensor-list thead td,\n\t.sensor-list thead th,\n\t.sensor-list td .ui-table-cell-label,\n\t.sensor-list th .ui-table-cell-label {\n\t\tdisplay: none;\n\t}\n}\n</style>\n<script src=\"/jq/jquery-2.1.4.min.js\"></script>\n<script src=\"/jq/mobile/jquery.mobile-1.4.5.min.js\"></script>\n<script>\n(function($) {\n    $(document).ready(function() {\n\n        var $cbtemp = $(\"#btemp\");\n        var $cbhumi = $(\"#bhumi\");\n        var $crtemp = $(\"#rtemp\");\n        var $crhumi = $(\"#rhumi\");\n        var $lupdate = $(\"#lupdate\");\n        var read_sensors = function() {\n            $.getJSON(\"/nodes/sense2\", function(data) {\n                $cbtemp.html(data.balcony.temperature);\n                $cbhumi.html(data.balcony.humidity);\n                $crtemp.html(data.living.temperature);\n                $crhumi.html(data.living.humidity);\n                var lupdt = new Date(data.lastUpdate);\n                var dupdt = new Date();\n                dupdt = dupdt - lupdt; // difference\n                var mupdt = new Date(dupdt).getMinutes();\n                $lupdate.html(mupdt+\"m ago\");\n            });\n        };\n        $cbtemp.html(\"00.00ºC\");\n        $cbhumi.html(\"00.00%rh\");\n        $crtemp.html(\"00.00ºC\");\n        $crhumi.html(\"00.00%rh\");\n        $lupdate.html(\"Unknown\");\n        read_sensors();\n        var refreshId = setInterval(read_sensors, 10000);\n    });\n})(jQuery);\n</script>\n</head>\n\n<body>\n<!-- Start of first page: #one -->\n<div data-role=\"page\" id=\"one\">\n\n\t<div data-role=\"header\">\n\t\t<h1>House</h1>\n\t</div><!-- /header -->\n\n\t<div role=\"main\" class=\"ui-content\" >\n\t<table data-role=\"table\" class=\"sensor-list\">\n        <thead>\n        <tr>\n            <th>Place</th>\n\t\t    <th>Temp</th>\n    \t\t<th>%RH</th>\n    \t</tr>\n        </thead>\n        <tbody>\n        <tr>\n            <td>Balcony</td>\n            <td><font size=11><b><span id=\"btemp\"></span></b></font>ºC</td>\n            <td><font size=6><b><span id=\"bhumi\"></span></b></font>%RH</td>\n        </tr>\n        <tr>\n            <td>Living Room</td>\n            <td><font size=6><b><span id=\"rtemp\"></span></b></font>ºC</td>\n            <td><font size=6><b><span id=\"rhumi\"></span></b></font>%RH</td>\n        </tr>\n        </tbody>\n    </table>\n    <p>Updated <span id=\"lupdate\"></span></p>\n<!--\t\t<p><a href=\"#two\" class=\"ui-btn ui-shadow ui-corner-all\">Show page \"two\"</a></p> -->\n\t\t<p><a href=\"#popup\" class=\"ui-btn ui-shadow ui-corner-all\" data-rel=\"dialog\" data-transition=\"pop\">Control</a></p>\n\t</div><!-- /content -->\n\n\t<div data-role=\"footer\" data-theme=\"a\">\n\t\t<h4>Home IoT</h4>\n\t</div><!-- /footer -->\n</div><!-- /page one -->\n\n<!-- Start of second page: #two -->\n<div data-role=\"page\" id=\"two\" data-theme=\"a\">\n\n\t<div data-role=\"header\">\n\t\t<h1>Two</h1>\n\t</div><!-- /header -->\n\n\t<div role=\"main\" class=\"ui-content\">\n\t\t<h2>Two</h2>\n\t\t<p>I have an id of \"two\" on my page container. I'm the second page container in this multi-page template.</p>\n\t\t<p>Notice that the theme is different for this page because we've added a few <code>data-theme</code> swatch assigments here to show off how flexible it is. You can add any content or widget to these pages, but we're keeping these simple.</p>\n\t\t<p><a href=\"#one\" data-direction=\"reverse\" class=\"ui-btn ui-shadow ui-corner-all ui-btn-b\">Back to page \"one\"</a></p>\n\n\t</div><!-- /content -->\n\n\t<div data-role=\"footer\">\n\t\t<h4>Home IoT</h4>\n\t</div><!-- /footer -->\n</div><!-- /page two -->\n\n<!-- Start of third page: #popup -->\n<div data-role=\"page\" id=\"popup\">\n\n\t<div data-role=\"header\" data-theme=\"b\">\n\t\t<h1>Screens and Lights</h1>\n\t</div><!-- /header -->\n\n\t<div role=\"main\" class=\"ui-content\">\n\t\t<p><b>Controls screens and lights</b></p>\n<form>\n\t<table data-role=\"table\" class=\"sensor-list\">\n        <thead>\n        <tr>\n            <th>Display</th>\n\t\t    <th>Set</th>\n    \t</tr>\n        </thead>\n        <tbody>\n        <tr>\n            <td>MagicLight</td>\n            <td>\n    <fieldset data-role=\"controlgroup\" data-type=\"horizontal\">\n        <input type=\"radio\" name=\"magiclight\" id=\"radio-choice-h-2a\" value=\"0\" checked=\"checked\">\n        <label for=\"radio-choice-h-2a\">Off</label>\n        <input type=\"radio\" name=\"magiclight\" id=\"radio-choice-h-2b\" value=\"1\">\n        <label for=\"radio-choice-h-2b\">Auto</label>\n<!--\n        <input type=\"radio\" name=\"radio-choice-h-2\" id=\"radio-choice-h-2c\" value=\"other\">\n        <label for=\"radio-choice-h-2c\">Three</label>\n-->\n    </fieldset>\n            </td>\n        </tr>\n        </tbody>\n    </table>\n</form>\n\t<p><a href=\"#one\" data-rel=\"back\" class=\"ui-btn ui-shadow ui-corner-all ui-btn-inline ui-icon-back ui-btn-icon-left\">Back to Main</a></p>\n\t</div><!-- /content -->\n\n\t<div data-role=\"footer\">\n\t\t<h4>Home IoT</h4>\n\t</div><!-- /footer -->\n</div><!-- /page popup -->\n</body>\n</html>","x":970,"y":380,"wires":[["60bf3170.1b16a"]]},{"id":"60bf3170.1b16a","type":"http response","z":"14e9f5d5.1d23fa","name":"/envweb2","x":1180,"y":380,"wires":[]},{"id":"e46fcad0.140fe8","type":"comment","z":"4d31febf.b2ce","name":"Disabled","info":"","x":1240,"y":2140,"wires":[]},{"id":"77c7712d.47c5a","type":"mqtt in","z":"4d31febf.b2ce","name":"0980 UVA","topic":"sensornet/env/ext/uv/uv0980/uva","qos":"2","broker":"9eac092b.6153f8","x":140,"y":2300,"wires":[["7f8bf589.821c1c"]]},{"id":"7f8bf589.821c1c","type":"function","z":"4d31febf.b2ce","name":"Context var","func":"var d = new Date();\nmsg.dtime = d.getTime();\nif (msg.payload) {\n    context.global.uv0980_uva=msg.payload;\n    return msg;\n}\nreturn;\n","outputs":1,"noerr":0,"x":350,"y":2300,"wires":[["5c0f491a.a3f0b8"]]},{"id":"3584afac.7503f","type":"mqtt in","z":"4d31febf.b2ce","name":"0980 UVB","topic":"sensornet/env/ext/uv/uv0980/uvb","qos":"2","broker":"9eac092b.6153f8","x":140,"y":2360,"wires":[["ea9b107d.d13d8"]]},{"id":"ea9b107d.d13d8","type":"function","z":"4d31febf.b2ce","name":"Context var","func":"var d = new Date();\nmsg.dtime = d.getTime();\nif (msg.payload) {\n    context.global.uv0980_uvb=msg.payload;\n    return msg;\n}\nreturn;\n","outputs":1,"noerr":0,"x":350,"y":2360,"wires":[["5c0f491a.a3f0b8"]]},{"id":"47322ca0.eee6d4","type":"mqtt in","z":"4d31febf.b2ce","name":"0980 UVI","topic":"sensornet/env/ext/uv/uv0980/uvi","qos":"2","broker":"9eac092b.6153f8","x":140,"y":2420,"wires":[["7ac4083c.5b2bb8"]]},{"id":"7ac4083c.5b2bb8","type":"function","z":"4d31febf.b2ce","name":"Context var","func":"var d = new Date();\nmsg.dtime = d.getTime();\nif (msg.payload) {\n    context.global.uv0980_uvi=msg.payload;\n    return msg;\n}\nreturn;\n","outputs":1,"noerr":0,"x":350,"y":2420,"wires":[["5c0f491a.a3f0b8"]]},{"id":"7861a011.958b1","type":"mqtt in","z":"4d31febf.b2ce","name":"0980 Visible","topic":"sensornet/env/ext/uv/uv0980/vis","qos":"2","broker":"9eac092b.6153f8","x":150,"y":2480,"wires":[["eb9f0c95.ef97c"]]},{"id":"eb9f0c95.ef97c","type":"function","z":"4d31febf.b2ce","name":"Context var","func":"var d = new Date();\nmsg.dtime = d.getTime();\nif (msg.payload) {\n    context.global.uv0980_vis=msg.payload;\n    return msg;\n}\nreturn;\n","outputs":1,"noerr":0,"x":350,"y":2480,"wires":[["5c0f491a.a3f0b8"]]},{"id":"8ccb3d93.0776a","type":"mqtt in","z":"4d31febf.b2ce","name":"0980 IR","topic":"sensornet/env/ext/uv/uv0980/ir","qos":"2","broker":"9eac092b.6153f8","x":130,"y":2540,"wires":[["6545276c.90cc98"]]},{"id":"6545276c.90cc98","type":"function","z":"4d31febf.b2ce","name":"Context var","func":"var d = new Date();\nmsg.dtime = d.getTime();\nif (msg.payload) {\n    context.global.uv0980_ir=msg.payload;\n    return msg;\n}\nreturn;\n","outputs":1,"noerr":0,"x":350,"y":2540,"wires":[["5c0f491a.a3f0b8"]]},{"id":"25f30edf.6567d2","type":"mqtt in","z":"4d31febf.b2ce","name":"0980 Lux","topic":"sensornet/env/ext/uv/uv0980/lux","qos":"2","broker":"9eac092b.6153f8","x":140,"y":2600,"wires":[["aced2c1f.2196e"]]},{"id":"aced2c1f.2196e","type":"function","z":"4d31febf.b2ce","name":"Context var","func":"var d = new Date();\nmsg.dtime = d.getTime();\nif (msg.payload) {\n    context.global.uv0980_lux=msg.payload;\n    return msg;\n}\nreturn;\n","outputs":1,"noerr":0,"x":350,"y":2600,"wires":[["5c0f491a.a3f0b8","b38c67fd.b141f8"]]},{"id":"f7f7bcc4.a4f2b","type":"mqtt out","z":"22752fb7.ea4aa","name":"0980 UVA","topic":"sensornet/env/ext/uv/uv0980/uva","qos":"2","retain":"true","broker":"9eac092b.6153f8","x":1140,"y":1100,"wires":[]},{"id":"2b3c9adf.3a9ea6","type":"mqtt out","z":"22752fb7.ea4aa","name":"0980 UVB","topic":"sensornet/env/ext/uv/uv0980/uvb","qos":"2","retain":"true","broker":"9eac092b.6153f8","x":1140,"y":1160,"wires":[]},{"id":"e68a152f.1ce518","type":"mqtt out","z":"22752fb7.ea4aa","name":"0980 UVI","topic":"sensornet/env/ext/uv/uv0980/uvi","qos":"2","retain":"true","broker":"9eac092b.6153f8","x":1140,"y":1220,"wires":[]},{"id":"c449f19b.1ec9c","type":"mqtt out","z":"22752fb7.ea4aa","name":"0980 Visible","topic":"sensornet/env/ext/uv/uv0980/vis","qos":"2","retain":"true","broker":"9eac092b.6153f8","x":1150,"y":1280,"wires":[]},{"id":"8ec82c60.c364b","type":"mqtt out","z":"22752fb7.ea4aa","name":"0980 IR","topic":"sensornet/env/ext/uv/uv0980/ir","qos":"2","retain":"true","broker":"9eac092b.6153f8","x":1140,"y":1340,"wires":[]},{"id":"bcccdcba.0d3a1","type":"mqtt out","z":"22752fb7.ea4aa","name":"0980 Lux","topic":"sensornet/env/ext/uv/uv0980/lux","qos":"2","retain":"true","broker":"9eac092b.6153f8","x":1140,"y":960,"wires":[]},{"id":"510a345a.300ffc","type":"mqtt out","z":"22752fb7.ea4aa","name":"0980 Temp","topic":"sensornet/env/ext/uv/uv0980/temp","qos":"2","retain":"true","broker":"9eac092b.6153f8","x":1150,"y":840,"wires":[]},{"id":"eae07d3a.90ed4","type":"mqtt out","z":"22752fb7.ea4aa","name":"0980 Pressure","topic":"sensornet/env/ext/uv/uv0980/press","qos":"2","retain":"true","broker":"9eac092b.6153f8","x":1160,"y":900,"wires":[]},{"id":"221aa8cd.448c28","type":"function","z":"14e9f5d5.1d23fa","name":"UV0980 UVA","func":"var qtime = new Date()\nqtime = qtime - 30*60*1000\nvar query = {}\nquery[\"topic\"] = /\\/uv0980\\/uva$/i\nquery[\"dtime\"] = {\"$gt\": qtime}\nvar proj = {topic:1,payload:1,dtime:1,_id:0}\nmsg.projection = proj\nmsg.payload = query\nmsg.limit=1\nmsg.skip=0\nmsg.sort={dtime:-1}\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":1200,"wires":[["576106dc.b9e918"]]},{"id":"112e3f9c.91283","type":"function","z":"14e9f5d5.1d23fa","name":"UV0980 UVB","func":"var qtime = new Date()\nqtime = qtime - 30*60*1000\nvar query = {}\nquery[\"topic\"] = /\\/uv0980\\/uvb$/i\nquery[\"dtime\"] = {\"$gt\": qtime}\nvar proj = {topic:1,payload:1,dtime:1,_id:0}\nmsg.projection = proj\nmsg.payload = query\nmsg.limit=1\nmsg.skip=0\nmsg.sort={dtime:-1}\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":1260,"wires":[["260e0261.07b9ce"]]},{"id":"4be820f6.2eb6b","type":"function","z":"14e9f5d5.1d23fa","name":"UV0980 UVI","func":"var qtime = new Date()\nqtime = qtime - 30*60*1000\nvar query = {}\nquery[\"topic\"] = /\\/uv0980\\/uvi$/i\nquery[\"dtime\"] = {\"$gt\": qtime}\nvar proj = {topic:1,payload:1,dtime:1,_id:0}\nmsg.projection = proj\nmsg.payload = query\nmsg.limit=1\nmsg.skip=0\nmsg.sort={dtime:-1}\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":1320,"wires":[["2fe5fca7.da4494"]]},{"id":"576106dc.b9e918","type":"mongodb in","z":"14e9f5d5.1d23fa","mongodb":"d3cae7a7.2c3518","name":"Lookup DB","collection":"environment","operation":"find","x":730,"y":1200,"wires":[["99a6a11a.79eb2"]]},{"id":"260e0261.07b9ce","type":"mongodb in","z":"14e9f5d5.1d23fa","mongodb":"d3cae7a7.2c3518","name":"Lookup DB","collection":"environment","operation":"find","x":730,"y":1260,"wires":[["81a485b5.fb6d68"]]},{"id":"2fe5fca7.da4494","type":"mongodb in","z":"14e9f5d5.1d23fa","mongodb":"d3cae7a7.2c3518","name":"Lookup DB","collection":"environment","operation":"find","x":730,"y":1320,"wires":[["7ef689f6.6e8518"]]},{"id":"99a6a11a.79eb2","type":"function","z":"14e9f5d5.1d23fa","name":"First element","func":"var val = msg.payload;\nif (val) {\n    if (val.length > 0) {\n        val=val[0];\n        msg.payload=val;\n        context.global.uv0980_uva = val.payload;\n        if (val.dtime > context.global.uv0980ALastUpdate)\n            context.global.uv0980ALastUpdate = val.dtime;\n    }\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":910,"y":1200,"wires":[["112e3f9c.91283"]]},{"id":"81a485b5.fb6d68","type":"function","z":"14e9f5d5.1d23fa","name":"First element","func":"var val = msg.payload;\nif (val) {\n    if (val.length > 0) {\n        val=val[0];\n        msg.payload=val;\n        context.global.uv0980_uvb = val.payload;\n        if (val.dtime > context.global.uv0980ALastUpdate)\n            context.global.uv0980ALastUpdate = val.dtime;\n    }\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":910,"y":1260,"wires":[["4be820f6.2eb6b"]]},{"id":"7ef689f6.6e8518","type":"function","z":"14e9f5d5.1d23fa","name":"First element","func":"var val = msg.payload;\nif (val) {\n    if (val.length > 0) {\n        val=val[0];\n        msg.payload=val;\n        context.global.uv0980_uvi = val.payload;\n        if (val.dtime > context.global.uv0980ALastUpdate)\n            context.global.uv0980ALastUpdate = val.dtime;\n    }\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":910,"y":1320,"wires":[["8fa153ac.c32aa"]]},{"id":"a3c22d8f.390ce","type":"mqtt in","z":"4d31febf.b2ce","name":"0980 Temp","topic":"sensornet/env/ext/uv/uv0980/temp","qos":"2","broker":"9eac092b.6153f8","x":140,"y":2660,"wires":[["7ebc2866.864928"]]},{"id":"7ebc2866.864928","type":"function","z":"4d31febf.b2ce","name":"Context var","func":"var d = new Date();\nmsg.dtime = d.getTime();\nif (msg.payload) {\n    context.global.uv0980_temp=msg.payload;\n    return msg;\n}\nreturn;\n","outputs":1,"noerr":0,"x":350,"y":2660,"wires":[["5c0f491a.a3f0b8"]]},{"id":"e3442b01.c26b68","type":"mqtt in","z":"4d31febf.b2ce","name":"0980 Pressure","topic":"sensornet/env/ext/uv/uv0980/press","qos":"2","broker":"9eac092b.6153f8","x":150,"y":2720,"wires":[["d556767c.53f5d8"]]},{"id":"d556767c.53f5d8","type":"function","z":"4d31febf.b2ce","name":"Context var","func":"var d = new Date();\nmsg.dtime = d.getTime();\nif (msg.payload) {\n    context.global.uv0980_press=msg.payload;\n    return msg;\n}\nreturn;\n","outputs":1,"noerr":0,"x":350,"y":2720,"wires":[["5c0f491a.a3f0b8"]]},{"id":"8fa153ac.c32aa","type":"function","z":"14e9f5d5.1d23fa","name":"UV0980 VIS","func":"var qtime = new Date()\nqtime = qtime - 30*60*1000\nvar query = {}\nquery[\"topic\"] = /\\/uv0980\\/vis$/i\nquery[\"dtime\"] = {\"$gt\": qtime}\nvar proj = {topic:1,payload:1,dtime:1,_id:0}\nmsg.projection = proj\nmsg.payload = query\nmsg.limit=1\nmsg.skip=0\nmsg.sort={dtime:-1}\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":1380,"wires":[["46289deb.0f5dc4"]]},{"id":"9614dca5.5e127","type":"function","z":"14e9f5d5.1d23fa","name":"UV0980 IR","func":"var qtime = new Date()\nqtime = qtime - 30*60*1000\nvar query = {}\nquery[\"topic\"] = /\\/uv0980\\/ir$/i\nquery[\"dtime\"] = {\"$gt\": qtime}\nvar proj = {topic:1,payload:1,dtime:1,_id:0}\nmsg.projection = proj\nmsg.payload = query\nmsg.limit=1\nmsg.skip=0\nmsg.sort={dtime:-1}\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":1440,"wires":[["9b28bc86.9acfc"]]},{"id":"d4f4ec9d.9f063","type":"function","z":"14e9f5d5.1d23fa","name":"UV0980 LUX","func":"var qtime = new Date()\nqtime = qtime - 30*60*1000\nvar query = {}\nquery[\"topic\"] = /\\/uv0980\\/lux$/i\nquery[\"dtime\"] = {\"$gt\": qtime}\nvar proj = {topic:1,payload:1,dtime:1,_id:0}\nmsg.projection = proj\nmsg.payload = query\nmsg.limit=1\nmsg.skip=0\nmsg.sort={dtime:-1}\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":1500,"wires":[["c9628697.346c48"]]},{"id":"46289deb.0f5dc4","type":"mongodb in","z":"14e9f5d5.1d23fa","mongodb":"d3cae7a7.2c3518","name":"Lookup DB","collection":"environment","operation":"find","x":730,"y":1380,"wires":[["3ee07eb0.45c4c2"]]},{"id":"9b28bc86.9acfc","type":"mongodb in","z":"14e9f5d5.1d23fa","mongodb":"d3cae7a7.2c3518","name":"Lookup DB","collection":"environment","operation":"find","x":730,"y":1440,"wires":[["4694b95c.679898"]]},{"id":"c9628697.346c48","type":"mongodb in","z":"14e9f5d5.1d23fa","mongodb":"d3cae7a7.2c3518","name":"Lookup DB","collection":"environment","operation":"find","x":730,"y":1500,"wires":[["1950e7df.b482a8"]]},{"id":"3ee07eb0.45c4c2","type":"function","z":"14e9f5d5.1d23fa","name":"First element","func":"var val = msg.payload;\nif (val) {\n    if (val.length > 0) {\n        val=val[0];\n        msg.payload=val;\n        context.global.uv0980_vis = val.payload;\n        if (val.dtime > context.global.uv0980ALastUpdate)\n            context.global.uv0980ALastUpdate = val.dtime;\n    }\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":910,"y":1380,"wires":[["9614dca5.5e127"]]},{"id":"4694b95c.679898","type":"function","z":"14e9f5d5.1d23fa","name":"First element","func":"var val = msg.payload;\nif (val) {\n    if (val.length > 0) {\n        val=val[0];\n        msg.payload=val;\n        context.global.uv0980_ir = val.payload;\n        if (val.dtime > context.global.uv0980ALastUpdate)\n            context.global.uv0980ALastUpdate = val.dtime;\n    }\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":910,"y":1440,"wires":[["d4f4ec9d.9f063"]]},{"id":"1950e7df.b482a8","type":"function","z":"14e9f5d5.1d23fa","name":"First element","func":"var val = msg.payload;\nif (val) {\n    if (val.length > 0) {\n        val=val[0];\n        msg.payload=val;\n        context.global.uv0980_lux = val.payload;\n        if (val.dtime > context.global.uv0980ALastUpdate)\n            context.global.uv0980ALastUpdate = val.dtime;\n    }\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":910,"y":1500,"wires":[["389ab2cd.1799fe"]]},{"id":"b1c6f241.900ac","type":"comment","z":"4d31febf.b2ce","name":"AQI02","info":"","x":125.58325576782227,"y":3329.916438102722,"wires":[]},{"id":"7e5014ca.1853bc","type":"inject","z":"6623960.c5be96c","name":"AQI01 Periodic Read","topic":"sensornet/AQI01/measure","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"x":200,"y":140,"wires":[["b1acc8fc.697f68","fd056f77.135d5"]]},{"id":"a9bc018f.1dd1c","type":"mqtt out","z":"6623960.c5be96c","name":"AQI01","topic":"","qos":"0","retain":"","broker":"9eac092b.6153f8","x":546.5000076293945,"y":138.99999904632568,"wires":[]},{"id":"971778e6.a58bd8","type":"inject","z":"6623960.c5be96c","name":"AQI01 Periodic tem","topic":"sensornet/AQI01/temperature","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"x":196.75010681152344,"y":267.4169931411743,"wires":[["97f54916.71a7c8"]]},{"id":"97f54916.71a7c8","type":"mqtt out","z":"6623960.c5be96c","name":"AQI01","topic":"","qos":"0","retain":"","broker":"9eac092b.6153f8","x":404.2501029968262,"y":267.6669912338257,"wires":[]},{"id":"40200d7b.6afe94","type":"inject","z":"6623960.c5be96c","name":"AQI01 Fan On","topic":"sensornet/AQI01/fanon","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"x":174.41674423217773,"y":350.08356189727783,"wires":[["db7c3284.35cca"]]},{"id":"db7c3284.35cca","type":"mqtt out","z":"6623960.c5be96c","name":"AQI01","topic":"","qos":"0","retain":"","broker":"9eac092b.6153f8","x":399.41674423217773,"y":348.83356189727783,"wires":[]},{"id":"39e20b37.677e54","type":"inject","z":"6623960.c5be96c","name":"AQI01 Fan Off","topic":"sensornet/AQI01/fanoff","payload":"","payloadType":"none","repeat":"","crontab":"","once":false,"x":173.16674423217773,"y":398.83356189727783,"wires":[["6f3f5edf.9805f"]]},{"id":"6f3f5edf.9805f","type":"mqtt out","z":"6623960.c5be96c","name":"AQI01","topic":"","qos":"0","retain":"","broker":"9eac092b.6153f8","x":398.16674423217773,"y":397.58356189727783,"wires":[]},{"id":"b1acc8fc.697f68","type":"delay","z":"6623960.c5be96c","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":384.5833435058594,"y":138.49992752075195,"wires":[["a9bc018f.1dd1c"]]},{"id":"fd056f77.135d5","type":"mqtt out","z":"6623960.c5be96c","name":"AQI01 Fan On","topic":"sensornet/AQI01/fanon","qos":"0","retain":"","broker":"9eac092b.6153f8","x":404.5833511352539,"y":196,"wires":[]},{"id":"505d6603.ab8d48","type":"comment","z":"6623960.c5be96c","name":"Retired- AQI01 no longer controlled by MQTT","info":"","x":270,"y":80,"wires":[]},{"id":"632f0e42.4072","type":"function","z":"9473c5a0.f3e0c8","name":"AQI Temperature","func":"var qtime = new Date()\nqtime = qtime - 30*60*1000\nvar query = {}\nquery[\"topic\"] = /sensornet\\/env\\/home\\/balcony\\/temperature/i\n//query[\"dtime\"] = {\"$gt\": qtime}\nvar proj = {topic:1,payload:1,dtime:1,_id:0}\nmsg.projection = proj\nmsg.payload = query\nmsg.limit=1\nmsg.skip=0\nmsg.sort={dtime:-1}\nreturn msg;","outputs":1,"noerr":0,"x":421,"y":180,"wires":[["9d4ea52d.3981b8"]]},{"id":"9d4ea52d.3981b8","type":"mongodb in","z":"9473c5a0.f3e0c8","mongodb":"d3cae7a7.2c3518","name":"Lookup DB","collection":"environment","operation":"find","x":761,"y":180,"wires":[["ebfebec5.e612"]]},{"id":"b54d0fd3.614a","type":"inject","z":"9473c5a0.f3e0c8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":200,"wires":[["632f0e42.4072"]]},{"id":"ebfebec5.e612","type":"debug","z":"9473c5a0.f3e0c8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1040,"y":200,"wires":[]},{"id":"e504c1ff.d6675","type":"rpi-gpio out","z":"91296eb.86fc89","name":"BLE Remote","pin":"7","set":true,"level":"1","freq":"","out":"out","x":490,"y":140,"wires":[]},{"id":"c439e1b9.d22aa","type":"trigger","z":"91296eb.86fc89","op1":"0","op2":"1","op1type":"num","op2type":"str","duration":"250","extend":false,"units":"ms","reset":"","bytopic":"all","name":"1/4s pulse","x":270,"y":140,"wires":[["e504c1ff.d6675"]]},{"id":"d04590d0.90987","type":"inject","z":"91296eb.86fc89","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":100,"y":100,"wires":[["c439e1b9.d22aa"]]},{"id":"6f959cdc.29d914","type":"link out","z":"81fd7809.1072f","name":"BLE Trigger","links":["59ef35a1.7608cc"],"x":895,"y":840,"wires":[]},{"id":"59ef35a1.7608cc","type":"link in","z":"91296eb.86fc89","name":"","links":["6f959cdc.29d914"],"x":135,"y":220,"wires":[["c439e1b9.d22aa"]]},{"id":"d1db3622.71cac8","type":"telldus-switchsensor","z":"81fd7809.1072f","gateway":"1ee64e7d.ebc352","localId":"45","name":"Kitchen Motion","interval":"30","onlyStateChange":true,"x":110,"y":860,"wires":[["fb7cb289.5d2a6","1f9b4dd9.a7e282"]]},{"id":"fb7cb289.5d2a6","type":"debug","z":"81fd7809.1072f","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":470,"y":760,"wires":[]},{"id":"434b52fc.ac608c","type":"trigger","z":"81fd7809.1072f","op1":"","op2":"0","op1type":"nul","op2type":"num","duration":"30","extend":true,"units":"s","reset":"","bytopic":"all","name":"Kitchen delay 30","x":830,"y":940,"wires":[["eb7af842.a58d58","fb7cb289.5d2a6"]]},{"id":"1f9b4dd9.a7e282","type":"function","z":"81fd7809.1072f","name":"Normalise payload","func":"if (msg.payload.toState == \"off\") {\n    msg.payload=0\n} else \nif (msg.payload.toState == \"on\") {\n    msg.payload=1\n} else {\n    msg.payload=9\n}\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":860,"wires":[["fb7cb289.5d2a6","b61e1c2e.c0e5b"]]},{"id":"b61e1c2e.c0e5b","type":"function","z":"81fd7809.1072f","name":"Ignore repeated ON","func":"if (global.get(\"kit_onoff\") === 0) {\n    if (msg.payload == 1) {\n        global.set(\"kit_onoff\", 1)\n    }\n} else if (msg.payload == 1) {\n        msg.payload = 9\n    }\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":860,"wires":[["ef8ea9ad.a6d458","fb7cb289.5d2a6"]]},{"id":"ef8ea9ad.a6d458","type":"switch","z":"81fd7809.1072f","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"neq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":730,"y":860,"wires":[[],["434b52fc.ac608c"]]},{"id":"eb7af842.a58d58","type":"change","z":"81fd7809.1072f","name":"Set global","rules":[{"t":"set","p":"kit_onoff","pt":"global","to":"0","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1020,"y":940,"wires":[[]]},{"id":"a7128542.08e628","type":"scanner","z":"9473c5a0.f3e0c8","name":"","timeout":5000,"x":300,"y":320,"wires":[["8a7c28fb.3a5ee8"]]},{"id":"8a7c28fb.3a5ee8","type":"peripheral","z":"9473c5a0.f3e0c8","name":"Balcony","mac":"cf:9e:fc:96:a3:5d","timeout":"5000","x":480,"y":320,"wires":[["711542e5.bb4cfc"],[]]},{"id":"673d920e.38bc6c","type":"characteristic","z":"9473c5a0.f3e0c8","name":"Temperature","uuid":"2a6e","subscribe":true,"x":830,"y":320,"wires":[["6fb42211.35d70c"]]},{"id":"de6e2567.9c7318","type":"inject","z":"9473c5a0.f3e0c8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":320,"wires":[["a7128542.08e628"]]},{"id":"5af676e.1571788","type":"debug","z":"9473c5a0.f3e0c8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":690,"y":560,"wires":[]},{"id":"e0173e0f.18a33","type":"change","z":"22752fb7.ea4aa","name":"Clear topic","rules":[{"t":"set","p":"topic","pt":"msg","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":230,"y":820,"wires":[["b482b76c.660748"]]},{"id":"389ab2cd.1799fe","type":"function","z":"14e9f5d5.1d23fa","name":"Living Room CO2","func":"var qtime = new Date()\nqtime = qtime - 30*60*1000\nvar query = {}\nquery[\"topic\"] = /\\/living\\/co2$/i\nquery[\"dtime\"] = {\"$gt\": qtime}\nvar proj = {topic:1,payload:1,dtime:1,_id:0}\nmsg.projection = proj\nmsg.payload = query\nmsg.limit=1\nmsg.skip=0\nmsg.sort={dtime:-1}\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":1560,"wires":[["98c6889e.81ff38"]]},{"id":"98c6889e.81ff38","type":"mongodb in","z":"14e9f5d5.1d23fa","mongodb":"d3cae7a7.2c3518","name":"Lookup DB","collection":"environment","operation":"find","x":730,"y":1560,"wires":[["12b35566.cbcb1b"]]},{"id":"12b35566.cbcb1b","type":"function","z":"14e9f5d5.1d23fa","name":"First element","func":"var val = msg.payload;\nif (val) {\n    if (val.length > 0) {\n        val=val[0];\n        msg.payload=val;\n        context.global.living_co2 = val.payload;\n        if (val.dtime > context.global.livingCO2ALastUpdate)\n            context.global.livingCO2ALastUpdate = val.dtime;\n    }\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":910,"y":1560,"wires":[["e7925edb.e7f9d"]]},{"id":"e7925edb.e7f9d","type":"function","z":"14e9f5d5.1d23fa","name":"Living Room VOC","func":"var qtime = new Date()\nqtime = qtime - 30*60*1000\nvar query = {}\nquery[\"topic\"] = /\\/living\\/voc$/i\nquery[\"dtime\"] = {\"$gt\": qtime}\nvar proj = {topic:1,payload:1,dtime:1,_id:0}\nmsg.projection = proj\nmsg.payload = query\nmsg.limit=1\nmsg.skip=0\nmsg.sort={dtime:-1}\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":1620,"wires":[["ea7b463e.c9f308"]]},{"id":"ea7b463e.c9f308","type":"mongodb in","z":"14e9f5d5.1d23fa","mongodb":"d3cae7a7.2c3518","name":"Lookup DB","collection":"environment","operation":"find","x":730,"y":1620,"wires":[["8d3a8d02.19ebc"]]},{"id":"8d3a8d02.19ebc","type":"function","z":"14e9f5d5.1d23fa","name":"First element","func":"var val = msg.payload;\nif (val) {\n    if (val.length > 0) {\n        val=val[0];\n        msg.payload=val;\n        context.global.living_voc = val.payload;\n        if (val.dtime > context.global.livingVOCALastUpdate)\n            context.global.livingVOCALastUpdate = val.dtime;\n    }\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":910,"y":1620,"wires":[["c92283e0.e4cd8","dba6cffd.e5114"]]},{"id":"3792525e.824cae","type":"mqtt in","z":"4d31febf.b2ce","name":"eCO2","topic":"sensornet/env/home/living/co2","qos":"2","broker":"9eac092b.6153f8","x":130,"y":1020,"wires":[["28e28571.a171da"]]},{"id":"28e28571.a171da","type":"function","z":"4d31febf.b2ce","name":"Context var","func":"var d = new Date();\nmsg.dtime = d.getTime();\nif (msg.payload) {\n    context.global.living_co2=msg.payload;\n    return msg;\n}\nreturn;\n","outputs":1,"noerr":0,"x":390,"y":1020,"wires":[["306fcbe9.cf9034"]]},{"id":"3b472a49.349e76","type":"function","z":"4d31febf.b2ce","name":"Context var","func":"var d = new Date();\nmsg.dtime = d.getTime();\nif (msg.payload) {\n    context.global.living_voc=msg.payload;\n    return msg;\n}\nreturn;\n","outputs":1,"noerr":0,"x":390,"y":1080,"wires":[["306fcbe9.cf9034"]]},{"id":"22822263.2c86de","type":"mqtt in","z":"4d31febf.b2ce","name":"eTVoC","topic":"sensornet/env/home/living/voc","qos":"2","broker":"9eac092b.6153f8","x":130,"y":1080,"wires":[["3b472a49.349e76"]]},{"id":"711542e5.bb4cfc","type":"service","z":"9473c5a0.f3e0c8","name":"Env","x":630,"y":320,"wires":[["673d920e.38bc6c"]]},{"id":"6fb42211.35d70c","type":"characteristic","z":"9473c5a0.f3e0c8","name":"Humidity","uuid":"2a6f","subscribe":true,"x":820,"y":400,"wires":[["5af676e.1571788"]]},{"id":"8518981e.e51168","type":"delay","z":"22752fb7.ea4aa","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":220,"y":420,"wires":[["fd6ff25a.d696","c51fab92.de6ad8"]]},{"id":"c51fab92.de6ad8","type":"delay","z":"22752fb7.ea4aa","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":220,"y":600,"wires":[["3ab82a57.a879b6","cd919c76.a854b"]]},{"id":"3ab82a57.a879b6","type":"delay","z":"22752fb7.ea4aa","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":220,"y":720,"wires":[["e0173e0f.18a33"]]},{"id":"9ea5cef6.3843","type":"telldus-metricsensor","z":"81fd7809.1072f","gateway":"1ee64e7d.ebc352","localId":"4","name":"AirCleaner_Fibaro","interval":"40","filter":"watt","x":650,"y":480,"wires":[["188708a4.f1aee7"]]},{"id":"188708a4.f1aee7","type":"function","z":"81fd7809.1072f","name":"Power value","func":"msg.payload = msg.payload.metrics[1].value\nreturn msg;","outputs":1,"noerr":0,"x":910,"y":480,"wires":[[]]},{"id":"6d91effa.9b32f","type":"inject","z":"4d31febf.b2ce","name":"Night light on balcony","topic":"sensornet/light/home/balcony/lantern","payload":"40","payloadType":"num","repeat":"","crontab":"00 19 * * *","once":false,"onceDelay":0.1,"x":230,"y":4120,"wires":[["feeaf4be.85ccb8","d4460c03.77569"]]},{"id":"1e52edb6.14d6e2","type":"mqtt out","z":"4d31febf.b2ce","name":"Balcony Night light","topic":"sensornet/light/home/balcony/lantern","qos":"1","retain":"","broker":"9eac092b.6153f8","x":730,"y":4040,"wires":[]},{"id":"fb26062c.e97dc8","type":"inject","z":"4d31febf.b2ce","name":"Night light dim balcony","topic":"sensornet/light/home/balcony/lantern","payload":"10","payloadType":"num","repeat":"","crontab":"50 23 * * *","once":false,"onceDelay":0.1,"x":230,"y":4160,"wires":[[]]},{"id":"a17506dc.2c9d88","type":"inject","z":"4d31febf.b2ce","name":"On 0.2","topic":"sensornet/light/home/balcony/lantern","payload":"14","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":170,"y":3980,"wires":[["1e52edb6.14d6e2"]]},{"id":"e57ad49b.d3da78","type":"inject","z":"4d31febf.b2ce","name":"Off","topic":"sensornet/light/home/balcony/lantern","payload":"0","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":170,"y":4020,"wires":[["1e52edb6.14d6e2"]]},{"id":"d499690b.218238","type":"inject","z":"4d31febf.b2ce","name":"On 0.8","topic":"","payload":"50","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":170,"y":3940,"wires":[["1e52edb6.14d6e2"]]},{"id":"bb1d33c9.8111e","type":"inject","z":"4d31febf.b2ce","name":"Night light off balcony","topic":"sensornet/light/home/balcony/lantern","payload":"0","payloadType":"num","repeat":"","crontab":"00 05 * * *","once":false,"onceDelay":0.1,"x":230,"y":4200,"wires":[["feeaf4be.85ccb8","d4460c03.77569","addbfa09.ee5318"]]},{"id":"208483c8.e269fc","type":"Generic BLE out","z":"22752fb7.ea4aa","name":"Lantern","genericBle":"73347c44.a85694","x":760,"y":2120,"wires":[]},{"id":"6fe61fa8.fa4a5","type":"mqtt in","z":"22752fb7.ea4aa","name":"Balcony Night Light","topic":"sensornet/light/home/balcony/lantern","qos":"1","broker":"9eac092b.6153f8","x":170,"y":2120,"wires":[["df386e56.c86ba"]]},{"id":"df386e56.c86ba","type":"function","z":"22752fb7.ea4aa","name":"comp json","func":"var pl = '{\"000015251212efde1523785feabcd123\":\"'+msg.payload+'\", \"writeWithoutResponse\":true}';\nmsg.payload = pl;\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":2120,"wires":[["51c2bdf5.0c3d84","7badcfbe.784e9"]]},{"id":"51c2bdf5.0c3d84","type":"json","z":"22752fb7.ea4aa","name":"","property":"payload","action":"","pretty":true,"x":550,"y":2120,"wires":[["208483c8.e269fc"]]},{"id":"ebc787ae.10ee48","type":"inject","z":"22752fb7.ea4aa","name":"","topic":"sensornet/light/home/balcony/lantern","payload":"70","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":130,"y":2040,"wires":[["df386e56.c86ba"]]},{"id":"c709c18.0fd074","type":"inject","z":"22752fb7.ea4aa","name":"Set","topic":"2a6e,2a6f,2a6d","payload":"{}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":110,"y":240,"wires":[["fa87d5c2.922f88"]]},{"id":"7badcfbe.784e9","type":"debug","z":"22752fb7.ea4aa","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":680,"y":2220,"wires":[]},{"id":"3f4238dc.eed088","type":"mqtt out","z":"4d31febf.b2ce","name":"Balcony lanterns","topic":"sensornet/light/home/balcony/lantern","qos":"0","retain":"false","broker":"9eac092b.6153f8","x":620,"y":2820,"wires":[]},{"id":"708a1840.a73d08","type":"function","z":"4d31febf.b2ce","name":"Auto-On when dark","func":"if (msg.payload <= 3) {\n    msg.payload = 50;\n    node.send(msg);\n}\nreturn null;","outputs":1,"noerr":0,"x":410,"y":2820,"wires":[["3f4238dc.eed088"]]},{"id":"feeaf4be.85ccb8","type":"trigger","z":"4d31febf.b2ce","op1":"40","op2":"0","op1type":"str","op2type":"str","duration":"-100","extend":false,"units":"ms","reset":"0","bytopic":"all","name":"40@1s","x":490,"y":4300,"wires":[["6b320252.95f2bc"]]},{"id":"d280a43d.ce0b88","type":"inject","z":"4d31febf.b2ce","name":"Start flashing","topic":"sensornet/light/home/balcony/lantern","payload":"1","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":110,"y":4300,"wires":[["feeaf4be.85ccb8","d4460c03.77569"]]},{"id":"d4460c03.77569","type":"trigger","z":"4d31febf.b2ce","op1":"10","op2":"0","op1type":"str","op2type":"str","duration":"-2","extend":false,"units":"s","reset":"0","bytopic":"all","name":"0@1s","x":330,"y":4360,"wires":[["e6a8ccd7.fabb6"]]},{"id":"e6a8ccd7.fabb6","type":"delay","z":"4d31febf.b2ce","name":"Rand delay 1-5","pauseType":"random","timeout":"0.5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":500,"y":4360,"wires":[["39ffdb60.876084"]]},{"id":"65f837a3.4bcaf8","type":"inject","z":"4d31febf.b2ce","name":"Stop flashing","topic":"","payload":"0","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":110,"y":4360,"wires":[["feeaf4be.85ccb8","d4460c03.77569","addbfa09.ee5318"]]},{"id":"6b320252.95f2bc","type":"random","z":"4d31febf.b2ce","name":"Rand 20-40","low":"20","high":"40","inte":"true","property":"payload","x":650,"y":4200,"wires":[["1e52edb6.14d6e2"]]},{"id":"39ffdb60.876084","type":"random","z":"4d31febf.b2ce","name":"Rand 1-10","low":"1","high":"10","inte":"true","property":"payload","x":670,"y":4280,"wires":[["1e52edb6.14d6e2"]]},{"id":"addbfa09.ee5318","type":"delay","z":"4d31febf.b2ce","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":500,"y":4160,"wires":[["1e52edb6.14d6e2"]]},{"id":"b38c67fd.b141f8","type":"function","z":"4d31febf.b2ce","name":"Day_Night","func":"if (msg.payload > 0) {\n    msg.topic = \"sensornet/light/home/balcony/lantern\";\n    if (msg.payload <= 0.2) {\n        msg.payload = 1;\n        if (global.get(\"lantern\") != 1) node.send([msg, null]);\n        global.set(\"lantern\", 1);\n    } else if (msg.payload > 0.2) {\n        msg.payload = 0;\n        if (global.get(\"lantern\") !== 0) node.send([null, msg]);\n        global.set(\"lantern\", 0);\n    }\n} else {\n    return null;\n}","outputs":2,"noerr":0,"x":620,"y":2600,"wires":[["7bfbd38a.e5377c"],["3fcb26c8.9bf35a"]]},{"id":"6c625b74.3138d4","type":"link in","z":"4d31febf.b2ce","name":"LanternOn","links":["aabffd4e.e39f8","bbb5c1ed.dddd9"],"x":155,"y":4440,"wires":[["feeaf4be.85ccb8","d4460c03.77569"]]},{"id":"6d22117.2cf5ef","type":"ui_slider","z":"28f95376.747dcc","name":"Period","label":"Hours before","tooltip":"","group":"7f80b2a1.1b92bc","order":2,"width":"0","height":"0","passthru":true,"outs":"end","topic":"","min":"1","max":"24","step":1,"x":130,"y":180,"wires":[["8d0a925e.4759a"]]},{"id":"8d0a925e.4759a","type":"function","z":"28f95376.747dcc","name":"UV0980","func":"var i_qtime = msg.payload;\nif (parseInt(i_qtime) <= 0) {\n    i_qtime = global.get(\"i_qtime\");\n    if (parseInt(i_qtime) <= 0) {\n        i_qtime = 6;\n    }\n}\nglobal.set(\"i_qtime\", i_qtime); // i_qtime in hours\nvar qtime = new Date();\nqtime = qtime - i_qtime*3600*1000;\nvar query = {};\nquery[\"topic\"] = {$regex: /uv0980\\/lux|vis|ir|uva|uvb/i};\nquery[\"dtime\"] = {\"$gt\": qtime};\nvar proj = {topic:1,payload:1,dtime:1,_id:0};\nmsg.projection = proj;\nmsg.payload = query;\n//msg.limit=360;\nmsg.skip=0;\nmsg.sort={dtime:-1};\nreturn msg;","outputs":1,"noerr":0,"x":320,"y":180,"wires":[["7d2213ee.78a8bc"]]},{"id":"7d2213ee.78a8bc","type":"mongodb in","z":"28f95376.747dcc","mongodb":"d3cae7a7.2c3518","name":"Lookup DB","collection":"environment","operation":"find","x":510,"y":180,"wires":[["c8bc8271.603b1"]]},{"id":"c8bc8271.603b1","type":"function","z":"28f95376.747dcc","name":"Prepare chart data","func":"var KalmanFilter = global.get('KalmanFilter')\n\nvar kf_uva = new KalmanFilter();\nvar kf_uvb = new KalmanFilter();\nvar kf_vis = new KalmanFilter();\nvar kf_ir = new KalmanFilter();\nvar kf_lux = new KalmanFilter();\nvar inp = msg.payload;\nvar out = [];\n\nif (inp.length > 0) {\n    var vis = [];\n    var lux = [];\n    var ir = [];\n    var uva = [];\n    var uvb = [];\n    for (var i = 0; i < inp.length; i++) {\n        topic = inp[i].topic;\n        val = {\"x\": inp[i].dtime, \"y\": inp[i].payload};\n        if (topic.indexOf(\"/uva\") > 0) {\n            val.y = kf_uva.filter(val.y);\n            uva.push(val);\n        }\n        if (topic.indexOf(\"/uvb\") > 0) {\n            val.y = kf_uvb.filter(val.y);\n            uvb.push(val);\n        }\n        if (topic.indexOf(\"/vis\") > 0) {\n            val.y = kf_vis.filter(val.y);\n            vis.push(val);\n        }\n        if (topic.indexOf(\"/ir\") > 0) {\n            val.y = kf_ir.filter(val.y);\n            ir.push(val);\n        }\n        if (topic.indexOf(\"/lux\") > 0) {\n            val.y = kf_lux.filter(val.y);\n            lux.push(val);\n        }\n    }\n    out = [uva, uvb, vis, ir, lux];\n}\nout = [{\"series\": [\"UV-A\", \"UV-B\", \"Vis\", \"IR\", \"Lux\"], \"data\": out, \"labels\": [\"\"]}];\nmsg.payload = out;\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":180,"wires":[["41395dea.0df3b4"]]},{"id":"41395dea.0df3b4","type":"ui_chart","z":"28f95376.747dcc","name":"Balcony","group":"7f80b2a1.1b92bc","order":0,"width":"0","height":"0","label":"Balcony","chartType":"line","legend":"true","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":"8","removeOlderPoints":"","removeOlderUnit":"604800","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"outputs":1,"x":960,"y":180,"wires":[[]]},{"id":"fab99dc.b6fa06","type":"comment","z":"28f95376.747dcc","name":"Charting","info":"","x":120,"y":80,"wires":[]},{"id":"6e04d7b.64a3028","type":"mqtt out","z":"22752fb7.ea4aa","name":"Livingroom vis","topic":"sensornet/env/home/living/vis","qos":"1","retain":"true","broker":"9eac092b.6153f8","x":1100,"y":1580,"wires":[]},{"id":"3765bf8d.1ec26","type":"mqtt out","z":"22752fb7.ea4aa","name":"Livingroom IR","topic":"sensornet/env/home/living/ir","qos":"1","retain":"true","broker":"9eac092b.6153f8","x":1100,"y":1640,"wires":[]},{"id":"41da9589.b0e48c","type":"ui_button","z":"28f95376.747dcc","name":"","group":"7f80b2a1.1b92bc","order":2,"width":"0","height":"0","passthru":false,"label":"Refresh","tooltip":"","color":"","bgcolor":"","icon":"","payload":"i_qtime","payloadType":"global","topic":"","x":140,"y":240,"wires":[["8d0a925e.4759a"]]},{"id":"7e15e6c3.a2f638","type":"comment","z":"28f95376.747dcc","name":"Gauges","info":"","x":110,"y":620,"wires":[]},{"id":"f7373e6b.e7d29","type":"mqtt in","z":"28f95376.747dcc","name":"LivingRoom temp","topic":"sensornet/env/home/living/temperature","broker":"9eac092b.6153f8","x":170,"y":700,"wires":[["20d8d6c2.5acf7a"]]},{"id":"20d8d6c2.5acf7a","type":"ui_gauge","z":"28f95376.747dcc","name":"Indoor temperature","group":"564b00d.e410c","order":3,"width":"3","height":"2","gtype":"gage","title":"Indoor","label":"℃","format":"{{value | number:1}}","min":"18","max":"32","colors":["#005cb9","#00b500","#fc6300"],"seg1":"","seg2":"","x":430,"y":700,"wires":[]},{"id":"ffaa2ad.86b3bd8","type":"mqtt in","z":"28f95376.747dcc","name":"LivingRoom humi","topic":"sensornet/env/home/living/humidity","broker":"9eac092b.6153f8","x":160,"y":760,"wires":[["646b9ac0.bef214"]]},{"id":"646b9ac0.bef214","type":"ui_gauge","z":"28f95376.747dcc","name":"Indoor humidity","group":"564b00d.e410c","order":3,"width":"3","height":"2","gtype":"gage","title":"Indoor rH","label":"rH","format":"{{value | number:1}}%","min":0,"max":"97","colors":["#e6e600","#00b500","#ca3838"],"seg1":"","seg2":"","x":420,"y":760,"wires":[]},{"id":"2bf0877.39d1a78","type":"mqtt in","z":"28f95376.747dcc","name":"Balcony temp","topic":"sensornet/env/home/balcony/temperature","broker":"9eac092b.6153f8","x":170,"y":820,"wires":[["65c8c277.dad77c"]]},{"id":"b91965e7.1e1548","type":"mqtt in","z":"28f95376.747dcc","name":"Balcony humi","topic":"sensornet/env/home/balcony/humidity","broker":"9eac092b.6153f8","x":170,"y":880,"wires":[["7e9e19f8.cfe6c8"]]},{"id":"65c8c277.dad77c","type":"ui_gauge","z":"28f95376.747dcc","name":"Outdoor temperature","group":"564b00d.e410c","order":3,"width":"3","height":"3","gtype":"gage","title":"Outdoor","label":"℃","format":"{{value | number:1}}","min":"0","max":"35","colors":["#005cb9","#00b500","#fc6300"],"seg1":"18","seg2":"27","x":440,"y":820,"wires":[]},{"id":"7e9e19f8.cfe6c8","type":"ui_gauge","z":"28f95376.747dcc","name":"Outdoor humidity","group":"564b00d.e410c","order":3,"width":"3","height":"2","gtype":"gage","title":"Outdoor rH","label":"rH","format":"{{value | number:1}}%","min":0,"max":"97","colors":["#e6e600","#00b500","#ca3838"],"seg1":"","seg2":"","x":430,"y":880,"wires":[]},{"id":"7bfbd38a.e5377c","type":"mqtt out","z":"4d31febf.b2ce","name":"Night Light On","topic":"sensornet/light/home/nightlight/on","qos":"2","retain":"false","broker":"8daacbf2.827ed8","x":840,"y":2560,"wires":[]},{"id":"3fcb26c8.9bf35a","type":"mqtt out","z":"4d31febf.b2ce","name":"Night Light Off","topic":"sensornet/light/home/nightlight/off","qos":"2","retain":"false","broker":"8daacbf2.827ed8","x":840,"y":2620,"wires":[]},{"id":"c1c11e98.71a5e","type":"mqtt in","z":"4d31febf.b2ce","name":"Night Light On","topic":"sensornet/light/home/nightlight/on","qos":"2","broker":"8daacbf2.827ed8","x":100,"y":4520,"wires":[["d9a19e1f.de11"]]},{"id":"a6af73f2.78bb1","type":"mqtt in","z":"4d31febf.b2ce","name":"Night Light Off","topic":"sensornet/light/home/nightlight/off","qos":"2","broker":"8daacbf2.827ed8","x":100,"y":4580,"wires":[["40113957.386d78"]]},{"id":"ec2328f3.c74cb8","type":"link in","z":"4d31febf.b2ce","name":"LanternOff","links":["18f28f26.a164b1","9f59d8e4.fd0e98"],"x":155,"y":4480,"wires":[["d4460c03.77569","feeaf4be.85ccb8","addbfa09.ee5318"]]},{"id":"bbb5c1ed.dddd9","type":"link out","z":"4d31febf.b2ce","name":"Set Lantern On","links":["6c625b74.3138d4"],"x":515,"y":4520,"wires":[]},{"id":"9f59d8e4.fd0e98","type":"link out","z":"4d31febf.b2ce","name":"Set Lantern Off","links":["ec2328f3.c74cb8"],"x":515,"y":4580,"wires":[]},{"id":"d9a19e1f.de11","type":"change","z":"4d31febf.b2ce","name":"Set 40","rules":[{"t":"set","p":"payload","pt":"msg","to":"40","tot":"num"},{"t":"set","p":"topic","pt":"msg","to":"sensornet/light/home/balcony/lantern","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":310,"y":4520,"wires":[["bbb5c1ed.dddd9"]]},{"id":"40113957.386d78","type":"change","z":"4d31febf.b2ce","name":"Set zero","rules":[{"t":"set","p":"payload","pt":"msg","to":"0","tot":"num"},{"t":"set","p":"topic","pt":"msg","to":"sensornet/light/home/balcony/lantern","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":320,"y":4580,"wires":[["9f59d8e4.fd0e98"]]},{"id":"92fa756f.0a6848","type":"inject","z":"22752fb7.ea4aa","name":"","topic":"815d,815e,2a77,2a6d,2a6e","payload":"{\"notify\":true,\"period\":0}","payloadType":"json","repeat":"","crontab":"","once":true,"onceDelay":"5","x":90,"y":1640,"wires":[["1cac45a8.5ca7fa"]]},{"id":"1cac45a8.5ca7fa","type":"Generic BLE in","z":"22752fb7.ea4aa","name":"LivingRoom Lux","genericBle":"6cff269d.a96688","useString":false,"notification":true,"x":440,"y":1640,"wires":[["186875c7.a4645a","842be5d6.aa1248","7d8be84b.e49d18","bd3b8c0b.99aea","d3e63f09.50fb8","c66caa7.8856158"]]},{"id":"a491eb4c.233678","type":"ui_slider","z":"28f95376.747dcc","name":"Period","label":"Hours before","tooltip":"","group":"7f80b2a1.1b92bc","order":2,"width":"0","height":"0","passthru":true,"outs":"end","topic":"","min":"1","max":"24","step":1,"x":130,"y":300,"wires":[["a6a482be.905c7"]]},{"id":"a6a482be.905c7","type":"function","z":"28f95376.747dcc","name":"LivingRoom Vis","func":"var i_qtime = msg.payload;\nif (parseInt(i_qtime) <= 0) {\n    i_qtime = global.get(\"i_qtime\");\n    if (parseInt(i_qtime) <= 0) {\n        i_qtime = 6;\n    }\n}\nglobal.set(\"i_qtime\", i_qtime); // i_qtime in hours\nvar qtime = new Date();\nqtime = qtime - i_qtime*3600*1000;\nvar query = {};\nquery[\"topic\"] = {$regex: /living\\/brightness/i};\nquery[\"dtime\"] = {\"$gt\": qtime};\nvar proj = {topic:1,payload:1,dtime:1,_id:0};\nmsg.projection = proj;\nmsg.payload = query;\n//msg.limit=360;\nmsg.skip=0;\nmsg.sort={dtime:-1};\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":300,"wires":[["b0f76d65.d313d"]]},{"id":"b0f76d65.d313d","type":"mongodb in","z":"28f95376.747dcc","mongodb":"d3cae7a7.2c3518","name":"Lookup DB","collection":"environment","operation":"find","x":510,"y":300,"wires":[["44ef9cf3.46b904"]]},{"id":"8d5d3b36.906298","type":"ui_button","z":"28f95376.747dcc","name":"","group":"7f80b2a1.1b92bc","order":2,"width":"0","height":"0","passthru":false,"label":"Refresh","tooltip":"","color":"","bgcolor":"","icon":"","payload":"i_qtime","payloadType":"global","topic":"","x":140,"y":360,"wires":[["a6a482be.905c7"]]},{"id":"44ef9cf3.46b904","type":"function","z":"28f95376.747dcc","name":"Prepare chart data","func":"var KalmanFilter = global.get('KalmanFilter')\n\nvar kf_vis = new KalmanFilter();\nvar kf_ir = new KalmanFilter();\nvar kf_lux = new KalmanFilter();\nvar inp = msg.payload;\nvar out = [];\n\nif (inp.length > 0) {\n    var vis = [];\n    var lux = [];\n    var ir = [];\n    for (var i = 0; i < inp.length; i++) {\n        topic = inp[i].topic;\n        val = {\"x\": inp[i].dtime, \"y\": inp[i].payload};\n        if (topic.indexOf(\"/vis\") > 0) {\n            val.y = kf_vis.filter(val.y);\n            vis.push(val);\n        }\n        if (topic.indexOf(\"/ir\") > 0) {\n            val.y = kf_ir.filter(val.y);\n            ir.push(val);\n        }\n        if (topic.indexOf(\"/brightness\") > 0) {\n            val.y = kf_lux.filter(val.y);\n            lux.push(val);\n        }\n    }\n    out = [vis, ir, lux];\n}\nout = [{\"series\": [\"Vis\", \"IR\", \"Lux\"], \"data\": out, \"labels\": [\"\"]}];\nmsg.payload = out;\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":300,"wires":[["c6f2b81e.ba0368"]]},{"id":"c6f2b81e.ba0368","type":"ui_chart","z":"28f95376.747dcc","name":"Living Room","group":"7f80b2a1.1b92bc","order":0,"width":"0","height":"0","label":"Living Room","chartType":"line","legend":"true","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":"8","removeOlderPoints":"","removeOlderUnit":"604800","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"outputs":1,"x":970,"y":300,"wires":[[]]},{"id":"8f511a50.245758","type":"status","z":"22752fb7.ea4aa","name":"BLE Status","scope":["1cac45a8.5ca7fa"],"x":80,"y":1720,"wires":[["c39c3afd.967408","47029b2c.bdb0c4"]]},{"id":"c39c3afd.967408","type":"debug","z":"22752fb7.ea4aa","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":390,"y":1820,"wires":[]},{"id":"47029b2c.bdb0c4","type":"function","z":"22752fb7.ea4aa","name":"WatchDog","func":"if (msg.status.text.indexOf(\"disconnected\")>0) {\n    msg.topic = \"815d,815e,2a77,2a6d,2a6e\";\n    msg.payload = {\"notify\":true,\"period\":0};\n    return msg;\n}\n","outputs":1,"noerr":0,"x":250,"y":1720,"wires":[["1cac45a8.5ca7fa"]]}]